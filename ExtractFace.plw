#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : ExtractFace
# Website     : http://le-tools.com/
# GitHub		  : https://github.com/arioux/ExtractFace
# Description : Dump Facebook stuff for analysis or reporting purposes
# Creation    : 2015-08-01
# Modified    : 2016-07-07
my $VERSION   = "4.0";
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2015-2016  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use utf8;
use arybase;
use Encode qw(encode decode);
use Excel::Writer::XLSX;
use File::Copy::Recursive qw(rcopy);
use File::Path qw(remove_tree);
use Firefox::Application::API40;
use Firefox::Application;
use HTML::Entities;
use Image::Info qw(image_info dim);
use LWP::UserAgent;
use Module::Pluggable::Fast;
use MozRepl::Client;
use MozRepl::Log;
use MozRepl::RemoteObject;
use MozRepl;
use threads;
use threads::shared;
use Time::Local;
use Time::HiRes qw(usleep);
use URI::Escape::JavaScript qw(unescape);
use Win32::API();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI qw( WS_POPUP WS_CAPTION WS_THICKFRAME WS_EX_TOPMOST );
use Win32::GUI::BitmapInline();
use Win32::GUI::Grid;
use Win32::Process;
use WWW::Mechanize::Firefox;
require "ExtractFaceGraph.pl";
require "ExtractFaceLang.pl";

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#

my ($winICO, $logoBmp, $albumBmp, $friendsBmp, $eventBmp, $contribBmp, $chatBmp, $configBmp, $browseBmp) = &loadGraph();
  
#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\ExtractFace") { $USERDIR = "$ENV{'APPDATA'}\\ExtractFace"; }
else                                   { $USERDIR = $PROGDIR;                       }
my $CONFIG_FILE  = "$USERDIR\\ExtractFace.ini";                                # Configuration file
my $DEBUG_FILE   = "$USERDIR\\debug.log";                                      # Debug log file
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $URL_DOC      = "http://le-tools.com/ExtractFaceDoc.html";                  # Online documentation
my $URL_TOOL     = 'http://le-tools.com/ExtractFace.html#Download';            # Url of the tool (download)
my $URL_VER      = 'http://www.le-tools.com/download/ExtractFaceVer.txt';      # Url of the version file
my %CONFIG;                                                                    # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW       :shared;                                                       # Arrow pointer
my $HOURGLASS   :shared;                                                       # Hourglass pointer
my $START       = 0;                                                           # Indicate when program is started
my $THR;                                                                       # Thread

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#

&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings

#------------------------------------------------------------------------------#
# Splash window
#------------------------------------------------------------------------------#

my $splash = new Win32::GUI::Window ( -name       => 'Splash'                   ,
                                      -text       => 'Splash'                   ,
                                      -size       => [128,128]                  ,
                                      -pos        => [100,100]                  ,
                                      -addstyle   => WS_POPUP                   ,
                                      -popstyle   => WS_CAPTION | WS_THICKFRAME ,
                                      -addexstyle => WS_EX_TOPMOST              , );
$splash->AddLabel(                    -name       => 'Bitmap'                   ,
                                      -size       => [128,128]                  ,
                                      -pos        => [  0,  0]                  ,
                                      -bitmap     => $logoBmp                   , );

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#

my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);     # Width
my $scrnY     = Win32::GUI::Height($screen);    # Height
my $winWidth  = 520;
my $winHeight = 195;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;

my $win = Win32::GUI::Window->new( -name       => 'main'               ,
                                   -title      => 'ExtractFace'        ,
                                   -background => [255, 255, 255]      ,
                                   -width      => $winWidth            ,
                                   -height     => $winHeight           ,
                                   -pos        => [$winPosX, $winPosY] ,
                                   -resizable  => 0                    ,
                                   -hasmaximize=> 0                    , );
$win->SetIcon($winICO);

# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $font8;
my $font10;
my $font10t;

# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name       => 'Arial '             ,
                                  -size       => 10                   ,
                                  -bold       => 1                    , );
  $fontGB2 = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       => 10                   ,
                                  -bold       => 1                    ,
                                  -underline  => 1                    , );
  $font8   = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  6                   , );
  $font10  = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                  , );
  $font10t = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                  ,
                                  -underline  =>  1                   , );
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name       => 'Arial '             ,
                                  -size       => 12                   ,
                                  -bold       => 1                    , );
  $fontGB2 = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       => 12                   ,
                                  -bold       => 1                    ,
                                  -underline  => 1                    , );
  $font8   = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                   , );
  $font10  = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  10                  , );
  $font10t = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  10                  ,
                                  -underline  =>  1                   , );
}

# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);

# Taskbar
$win->AddNotifyIcon(-name    => "Tray"           , 
                    -icon    => $winICO          ,
                    -tip     => 'ExtractFace'    ,
                    -balloon => 1                , );

# Main section
$win->AddLabel(   -name        => 'lblLogo'           ,
                  -size        => [128,128]           ,
                  -pos         => [  0,  5]           ,
                  -bitmap      => $logoBmp            ,
                  -background  => [255, 255, 255]     , );
$win->AddLabel(   -name        => 'lblText1'          ,
                  -size        => [ 90, 65]           ,
                  -pos         => [135, 10]           ,
                  -font        => $font10             ,
                  -foreground  => [0  , 0  , 102]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => $STR{'update4'}.":\n".$STR{'website'}.":\n".$STR{'author'}.":\n".$STR{'translatedBy'}.':', );
$win->AddLabel(   -name        => 'lblText2'          ,
                  -size        => [270, 65]           ,
                  -pos         => [230, 10]           ,
                  -font        => $font10             ,
                  -foreground  => [185, 154,   0]     ,
                  -background  => [255, 255, 255]     ,
                  -text        =>  "$VERSION\nhttp://www.le-tools.com/\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
$win->AddLabel(   -name        => 'lblText3'          ,
                  -size        => [300, 20]           ,
                  -pos         => [135, 80]           ,
                  -font        => $font10             ,
                  -foreground  => [0  , 0  , 102]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => '© Copyright 2015-2016 Alain Rioux', );
$win->AddLabel(   -name        => 'lblText4'          ,
                  -size        => [340, 22]           ,
                  -pos         => [180,110]           ,
                  -font        => $font10             ,
                  -foreground  => [255,   0,   0]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => '>> '.$STR{'lblText4'}.' <<', );
$win->AddCheckbox(-name        => 'chStartMinimized'  ,
                  -size        => [300, 22]           ,
                  -pos         => [ 10,140]           ,
                  -text        => $STR{'chStartMinimized'},
                  -background  => [255, 255, 255]     ,
                  -font        => $font10             , );

# Load taskbar menu
my $trayMenu = Win32::GUI::Menu->new(
 	"SysTray"             => "SysTray",
  ">$STR{'menu1'}"      => { -name => "ScrollExpand" , -onClick => \&scrollExpand           },
  ">$STR{'menu2'}"      => { -name => "Scrolling"    , -onClick => \&scroll                 },
  ">$STR{'menu3'}"      => { -name => "Expand"       , -onClick => \&expand                 },
  " > -"                => 0,
  ">$STR{'menu5'}..."   => { -name => "Albums"       , -onClick => \&winAlbums              },
  ">$STR{'menu6'}..."   => { -name => "Friends"      , -onClick => \&winFriends             },
  ">$STR{'menu7'}..."   => { -name => "Events"       , -onClick => \&winEvent               },
  ">$STR{'menu17'}..."  => { -name => "Contributors" , -onClick => \&winContrib             },
  " > -"                => 0,
  ">$STR{'menu8'}"      => { -name => "ScrollChat"   , -onClick => \&scrollChat             },
  ">$STR{'menu9'}"      => { -name => "LoadOldMsg"   , -onClick => \&loadOldMsg             },
  ">$STR{'menu10'}"     => { -name => "LoadNewMsg"   , -onClick => \&loadNewMsg             },
  ">$STR{'menu11'}..."  => { -name => "Chat"         , -onClick => \&winChat                },
  " > -"                => 0,
  ">$STR{'menu12'}..."  => { -name => "Config"       , -onClick => \&winConfig              },
  " > -"                => 0,
  ">$STR{'menu14'}..."  => { -name => "Help"         , -onClick => \&help                   },
  ">$STR{'menu15'}..."  => { -name => "About"        , -onClick => \&Tray_DblClick          },
  ">$STR{'menu16'}"     => { -name => "Quit"         , -onClick => \&main_Quit              },
);

#------------------------------------------------------------------------------#
# Dump albums window
#------------------------------------------------------------------------------#
my $winAlbumsPosX   = ($scrnX - 780) / 2;
my $winAlbumsPosY   = ($scrnY - 355) / 2;
my $winAlbums = Win32::GUI::DialogBox->new( -name        => 'winAlbums'                     ,
                                            -parent      => $win                            ,
                                            -text        => $STR{'winAlbums'}               ,
                                            -pos         => [$winAlbumsPosX, $winAlbumsPosY],
                                            -size        => [780,355]                       ,
                                            -background  => [255, 255, 255]                 ,
                                            -hasmaximize => 0                               ,
                                            -hasminimize => 1                               ,
                                            -helpbutton  => 0                               ,
                                            -resizable   => 0                               ,
                                            -topmost     => 1                               ,
                                            -dialogui    => 1                               , );
$winAlbums->SetIcon($winICO);

$winAlbums->AddLabel(             -name         => 'lblLogo'                      ,
                                  -size         => [128,128]                      ,
                                  -pos          => [  5,  5]                      ,
                                  -bitmap       => $albumBmp                      ,
                                  -background   => [255, 255, 255]                , );
$winAlbums->AddLabel(             -name         => 'lblAlbumTitle'                ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 18]                      ,
                                  -text         => $STR{'file'}.':'               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddTextfield(         -name         => 'tfAlbumTitle'                 ,
                                  -size         => [440, 22]                      ,
                                  -pos          => [220, 15]                      , );
$winAlbums->AddLabel(             -name         => 'lblDirSaveAlbums'             ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 48]                      ,
                                  -text         => $STR{'dir'}.':'                ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddTextfield(         -name         => 'tfDirSaveAlbums'              ,
                                  -size         => [440, 22]                      ,
                                  -pos          => [220, 45]                      , );
$winAlbums->AddButton(            -name         => 'btnDirSaveAlbums'             ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [662, 45]                      ,
                                  -bitmap       => $browseBmp                     , );
$winAlbums->AddCheckbox(          -name         => 'chSaveAlbumDir'               ,
                                  -size         => [200, 20]                      ,
                                  -pos          => [220, 73]                      ,
                                  -text         => $STR{'remDir'}                 ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -checked      => 0                              , );
$winAlbums->AddLabel(             -name         => 'lblInProgress'                ,
                                  -size         => [280, 22]                      ,
                                  -pos          => [490, 74]                      ,
                                  -font         => $font10                        ,
                                  -foreground   => [0, 153, 0]                    ,
                                  -background   => [255, 255, 255]                ,
                                  -visible      => 1                              , );
$winAlbums->AddGrid (             -name         => 'GridAlbums'                   ,
                                  -pos          => [140,100]                      ,
                                  -size         => [630,145]                      ,
                                  -fixedrows    => 1                              ,
                                  -fixedcolumns => 0                              ,
                                  -editable     => 0                              , );
$winAlbums->GridAlbums->SetListMode(1);
$winAlbums->AddLabel(             -name         => 'lblAlbumsOpt'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,250]                      ,
                                  -text         => $STR{'lblOptions'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winAlbums->AddCheckbox(          -name         => 'chPublishDate'                ,
                                  -size         => [190, 20]                      ,
                                  -pos          => [220,250]                      ,
                                  -text         => $STR{'chPublishDate'}          ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddCheckbox(          -name         => 'chAlbumsOpenHTML'             ,
                                  -size         => [180, 20]                      ,
                                  -pos          => [415,250]                      ,
                                  -text         => $STR{'openHTML'}               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddCheckbox(          -name         => 'chAlbumsOpenDir'              ,
                                  -size         => [170, 20]                      ,
                                  -pos          => [600,250]                      ,
                                  -text         => $STR{'openAlbumDir'}           ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );

$winAlbums->AddButton(            -name         => 'btnAlbumsOk'                  ,
                                  -size         => [ 85, 30]                      ,
                                  -pos          => [355,285]                      ,
                                  -text         => $STR{'dump'}                   ,
                                  -font         => $font10                        ,
                                  -disabled     => 1                              ,
                                  -ok           => 1                              ,
                                  -default      => 1                              , );

#------------------------------------------------------------------------------#
# Dump friends window
#------------------------------------------------------------------------------#
my $winFriendsPosX   = ($scrnX - 745) / 2;
my $winFriendsPosY   = ($scrnY - 345) / 2;
my $winFriends = Win32::GUI::DialogBox->new(-name        => 'winFriends'                   ,
                                            -parent      => $win                           ,
                                            -text        => $STR{'winFriends'}             ,
                                            -pos         => [$winFriendsPosX, $winFriendsPosY],
                                            -size        => [745,345]                      ,
                                            -background  => [255, 255, 255]                ,
                                            -hasmaximize => 0                              ,
                                            -hasminimize => 1                              ,
                                            -helpbutton  => 0                              ,
                                            -resizable   => 0                              ,
                                            -topmost     => 1                              ,
                                            -dialogui    => 1                              , );
$winFriends->SetIcon($winICO);

$winFriends->AddLabel(              -name       => 'lblLogo'                      ,
                                    -size       => [128,128]                      ,
                                    -pos        => [  0,  5]                      ,
                                    -bitmap     => $friendsBmp                    ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddLabel(              -name       => 'lblFriendName'                ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 18]                      ,
                                    -text       => $STR{'file'}.':'               ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddTextfield(          -name       => 'tfFriendName'                 ,
                                    -size       => [440, 22]                      ,
                                    -pos        => [220, 15]                      ,
                                    -tabstop    => 1                              , );
$winFriends->AddLabel(              -name       => 'lblDirSaveFriends'            ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 48]                      ,
                                    -text       => $STR{'dir'}.':'                ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddTextfield(          -name       => 'tfDirSaveFriends'             ,
                                    -size       => [440, 22]                      ,
                                    -pos        => [220, 45]                      ,
                                    -tabstop    => 1                              , );
$winFriends->AddButton(             -name       => 'btnDirSaveFriends'            ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [662, 45]                      ,
                                    -bitmap     => $browseBmp                     ,
                                    -tabstop    => 1                              , );
$winFriends->AddCheckbox(           -name       => 'chSaveFriendsDir'             ,
                                    -size       => [200, 20]                      ,
                                    -pos        => [220, 73]                      ,
                                    -text       => $STR{'remDir'}                 ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddLabel(              -name       => 'lblInProgress'                ,
                                    -size       => [240, 22]                      ,
                                    -pos        => [490, 74]                      ,
                                    -font       => $font10                        ,
                                    -foreground => [0, 153, 0]                    ,
                                    -background => [255, 255, 255]                ,
                                    -visible    => 1                              , );
$winFriends->AddGrid (              -name         => 'GridFriends'                ,
                                    -pos          => [140,100]                    ,
                                    -size         => [590,145]                    ,
                                    -fixedrows    => 1                            ,
                                    -fixedcolumns => 0                            ,
                                    -editable     => 0                            , );
$winFriends->GridFriends->SetListMode(1);
$winFriends->AddLabel(              -name       => 'lblFriendsOpt'                ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140,251]                      ,
                                    -text       => $STR{'lblOptions'}.':'         ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddCheckbox(           -name       => 'chFriendsProfileIcons'        ,
                                    -size       => [170, 20]                      ,
                                    -pos        => [220,250]                      ,
                                    -text       => $STR{'chIncludeIcons'}         ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddCheckbox(           -name       => 'chFriendsOpenXLSX'            ,
                                    -size       => [170, 22]                      ,
                                    -pos        => [400,250]                      ,
                                    -text       => $STR{'openXLSX'}               ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddCheckbox(           -name       => 'chFriendsSafeMode'            ,
                                    -size       => [155, 20]                      ,
                                    -pos        => [575,250]                      ,
                                    -text       => $STR{'chSafeMode'}             ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddButton(             -name       => 'btnFriendsOk'                 ,
                                    -size       => [ 90, 30]                      ,
                                    -pos        => [355,280]                      ,
                                    -text       => $STR{'dump'}                   ,
                                    -font       => $font10                        ,
                                    -disabled   => 1                              ,
                                    -tabstop    => 1                              ,
                                    -ok         => 1                              ,
                                    -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Event members window
#------------------------------------------------------------------------------#
my $winEventPosX = ($scrnX - 745) / 2;
my $winEventPosY = ($scrnY - 380) / 2;
my $winEvent = Win32::GUI::DialogBox->new( -name        => 'winEvent'                     ,
                                           -parent      => $win                           ,
                                           -text        => $STR{'winEvent'}               ,
                                           -pos         => [$winEventPosX, $winEventPosY] ,
                                           -size        => [745,380]                      ,
                                           -background  => [255, 255, 255]                ,
                                           -hasmaximize => 0                              ,
                                           -hasminimize => 1                              ,
                                           -helpbutton  => 0                              ,
                                           -resizable   => 0                              ,
                                           -topmost     => 1                              ,
                                           -dialogui    => 1                              , );
$winEvent->SetIcon($winICO);

$winEvent->AddLabel(              -name         => 'lblLogo'                      ,
                                  -size         => [128,128]                      ,
                                  -pos          => [  0,  5]                      ,
                                  -bitmap       => $eventBmp                      ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddLabel(              -name         => 'lblEventName'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 18]                      ,
                                  -text         => $STR{'file'}.':'               ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfEventName'                  ,
                                  -size         => [260, 22]                      ,
                                  -pos          => [220, 15]                      ,
                                  -tabstop      => 1                              , );
$winEvent->AddLabel(              -name         => 'lblDirSaveEvent'              ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 48]                      ,
                                  -text         => $STR{'dir'}.':'                ,
                                  -font         => $font10                        , 
                                  -background   => [255, 255, 255]                ,);
$winEvent->AddTextfield(          -name         => 'tfDirSaveEvent'               ,
                                  -size         => [340, 22]                      ,
                                  -pos          => [220, 45]                      ,
                                  -tabstop      => 1                              , );
$winEvent->AddButton(             -name         => 'btnDirSaveEvent'              ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [562, 45]                      ,
                                  -bitmap       => $browseBmp                     ,
                                  -tabstop      => 1                              , );
$winEvent->AddCheckbox(           -name         => 'chSaveEventDir'               ,
                                  -size         => [200, 20]                      ,
                                  -pos          => [220, 73]                      ,
                                  -text         => $STR{'remDir'}                 ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddLabel(              -name         => 'lblEventsOpt'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,101]                      ,
                                  -text         => $STR{'lblOptions'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddCheckbox(           -name         => 'chEventProfileIcons'          ,
                                  -size         => [170, 22]                      ,
                                  -pos          => [220,100]                      ,
                                  -text         => $STR{'chIncludeIcons'}         ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chEventOpenXLSX'              ,
                                  -size         => [170, 22]                      ,
                                  -pos          => [395,100]                      ,
                                  -text         => $STR{'openXLSX'}               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
# Event Details
$winEvent->AddLabel(              -name         => 'lblEventDetailsT'             ,
                                  -size         => [590, 22]                      ,
                                  -pos          => [140,135]                      ,
                                  -text         => $STR{'lblEventDetailsT'}       ,
                                  -font         => $fontGB                        ,
                                  -background   => [206, 221, 255]                , );
$winEvent->AddLabel(              -name         => 'lblEventID'                   ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,168]                      ,
                                  -text         => $STR{'lblEventID'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfEventID'                    ,
                                  -size         => [220, 22]                      ,
                                  -pos          => [260,165]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblInProgress'                ,
                                  -size         => [240, 22]                      ,
                                  -pos          => [490,168]                      ,
                                  -font         => $font10                        ,
                                  -foreground   => [0, 153, 0]                    ,
                                  -background   => [255, 255, 255]                ,
                                  -visible      => 1                              , );
$winEvent->AddLabel(              -name         => 'lblAuthorID'                  ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,198]                      ,
                                  -text         => $STR{'lblAuthorID'}.':'        ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfAuthorID'                   ,
                                  -size         => [220, 22]                      ,
                                  -pos          => [260,195]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblDataURL'                   ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,228]                      ,
                                  -text         => $STR{'lblDataURL'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfDataURL'                    ,
                                  -size         => [470, 22]                      ,
                                  -pos          => [260,225]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblGuestLists'                ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,258]                      ,
                                  -text         => $STR{'lblGuestLists'}.':'      ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddCheckbox(           -name         => 'chGoing'                      ,
                                  -size         => [140, 20]                      ,
                                  -pos          => [260,255]                      ,
                                  -text         => 'Going'                        ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chMaybe'                      ,
                                  -size         => [140, 20]                      ,
                                  -pos          => [405,255]                      ,
                                  -text         => 'Maybe'                        ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chInvited'                    ,
                                  -size         => [140, 20]                      ,
                                  -pos          => [260,278]                      ,
                                  -text         => 'Invited'                      ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chDeclined'                   ,
                                  -size         => [140, 20]                      ,
                                  -pos          => [405,278]                      ,
                                  -text         => 'Declined'                     ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddButton(             -name         => 'btnEventOk'                   ,
                                  -size         => [ 90, 30]                      ,
                                  -pos          => [360,310]                      ,
                                  -text         => $STR{'dump'}                   ,
                                  -font         => $font10                        ,
                                  -disabled     => 1                              ,
                                  -tabstop      => 1                              ,
                                  -ok           => 1                              ,
                                  -default      => 1                              , );

#------------------------------------------------------------------------------#
# Dump Contributors window
#------------------------------------------------------------------------------#
my $winContrib = Win32::GUI::DialogBox->new(  -name        => 'winContrib'                   ,
                                              -parent      => $win                           ,
                                              -text        => $STR{'menu17'}                 ,
                                              -pos         => [($scrnX-650)/2,($scrnY-295)/2],
                                              -size        => [600,320]                      ,
                                              -background  => [255, 255, 255]                ,
                                              -hasmaximize => 0                              ,
                                              -hasminimize => 1                              ,
                                              -helpbutton  => 0                              ,
                                              -resizable   => 0                              ,
                                              -topmost     => 1                              ,
                                              -dialogui    => 1                              , );
$winContrib->SetIcon($winICO);
$winContrib->AddLabel(            -name       => 'lblLogo'                      ,
                                  -size       => [128,128]                      ,
                                  -pos        => [  0,  5]                      ,
                                  -bitmap     => $contribBmp                    ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddLabel(            -name       => 'lblContribName'               ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 18]                      ,
                                  -text       => $STR{'file'}.':'               ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddTextfield(        -name       => 'tfContribName'                ,
                                  -size       => [260, 22]                      ,
                                  -pos        => [220, 15]                      ,
                                  -tabstop    => 1                              , );
$winContrib->AddLabel(            -name       => 'lblDirSaveContrib'            ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 48]                      ,
                                  -text       => $STR{'dir'}.':'                ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddTextfield(        -name       => 'tfDirSaveContrib'             ,
                                  -size       => [340, 22]                      ,
                                  -pos        => [220, 45]                      ,
                                  -tabstop    => 1                              , );
$winContrib->AddButton(           -name       => 'btnDirSaveContrib'            ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [562, 45]                      ,
                                  -bitmap     => $browseBmp                     ,
                                  -tabstop    => 1                              , );
$winContrib->AddCheckbox(         -name       => 'chSaveContribDir'             ,
                                  -size       => [200, 20]                      ,
                                  -pos        => [220, 72]                      ,
                                  -text       => $STR{'remDir'}                 ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Types section
$winContrib->AddLabel(            -name       => 'lblContribCat'                ,
                                  -size       => [445, 22]                      ,
                                  -pos        => [140,102]                      ,
                                  -text       => $STR{'lblContribTypes'}        ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winContrib->AddCheckbox(         -name       => 'chContribComments'            ,
                                  -size       => [105, 20]                      ,
                                  -pos        => [140,132]                      ,
                                  -text       => $STR{'chContribComments'}      ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribLikes'               ,
                                  -size       => [ 80, 20]                      ,
                                  -pos        => [250,132]                      ,
                                  -text       => $STR{'chContribLikes'}         ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribVPosts'              ,
                                  -size       => [250, 20]                      ,
                                  -pos        => [335,132]                      ,
                                  -text       => $STR{'chContribVPosts'}        ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Options section
$winContrib->AddLabel(            -name       => 'lblContribOpt'                ,
                                  -size       => [445, 22]                      ,
                                  -pos        => [140,162]                      ,
                                  -text       => $STR{'lblOptions'}             ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winContrib->AddCheckbox(         -name       => 'chContribProfileIcons'        ,
                                  -size       => [170, 22]                      ,
                                  -pos        => [140,192]                      ,
                                  -text       => $STR{'chIncludeIcons'}         ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribOpenXLSX'            ,
                                  -size       => [210, 22]                      ,
                                  -pos        => [325,192]                      ,
                                  -text       => $STR{'openXLSX'}               ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribDontScrollVPosts'    ,
                                  -size       => [300, 22]                      ,
                                  -pos        => [140,217]                      ,
                                  -text       => $STR{'dontScrollVPosts'}       ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              ,
                                  -disabled   => 1                              , );

$winContrib->AddButton(           -name       => 'btnContribOk'                 ,
                                  -size       => [ 85, 30]                      ,
                                  -pos        => [310,250]                      ,
                                  -text       => $STR{'dump'}                   ,
                                  -font       => $font10                        ,
                                  -disabled   => 1                              ,
                                  -tabstop    => 1                              ,
                                  -ok         => 1                              ,
                                  -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Chat window
#------------------------------------------------------------------------------#
my $winChatPosX = ($scrnX - 650) / 2;
my $winChatPosY = ($scrnY - 295) / 2;
my $winChat = Win32::GUI::DialogBox->new(  -name        => 'winChat'                      ,
                                           -parent      => $win                           ,
                                           -text        => $STR{'winChat'}                ,
                                           -pos         => [$winChatPosX, $winChatPosY]   ,
                                           -size        => [640,340]                      ,
                                           -background  => [255, 255, 255]                ,
                                           -hasmaximize => 0                              ,
                                           -hasminimize => 1                              ,
                                           -helpbutton  => 0                              ,
                                           -resizable   => 0                              ,
                                           -topmost     => 1                              ,
                                           -dialogui    => 1                              , );
$winChat->SetIcon($winICO);

$winChat->AddLabel(               -name       => 'lblLogo'                      ,
                                  -size       => [128,128]                      ,
                                  -pos        => [  0,  5]                      ,
                                  -bitmap     => $chatBmp                       ,
                                  -background => [255, 255, 255]                , );
$winChat->AddLabel(               -name       => 'lblChatName'                  ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 18]                      ,
                                  -text       => $STR{'file'}.':'               ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddTextfield(           -name       => 'tfChatName'                   ,
                                  -size       => [260, 22]                      ,
                                  -pos        => [220, 15]                      ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblDirSaveChat'               ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 48]                      ,
                                  -text       => $STR{'dir'}.':'                ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddTextfield(           -name       => 'tfDirSaveChat'                ,
                                  -size       => [380, 22]                      ,
                                  -pos        => [220, 45]                      ,
                                  -tabstop    => 1                              , );
$winChat->AddButton(              -name       => 'btnDirSaveChat'               ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [602, 45]                      ,
                                  -bitmap     => $browseBmp                     ,
                                  -tabstop    => 1                              , );
$winChat->AddCheckbox(            -name       => 'chSaveChatDir'                ,
                                  -size       => [200, 20]                      ,
                                  -pos        => [220, 72]                      ,
                                  -text       => $STR{'remDir'}                 ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Options
$winChat->AddLabel(               -name       => 'lblChatOpt'                   ,
                                  -size       => [485, 22]                      ,
                                  -pos        => [140,100]                      ,
                                  -text       => $STR{'lblOptions'}             ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winChat->AddRadioButton(         -name       => 'rbChatNormalMode'             ,
                                  -size       => [125, 22]                      ,
                                  -pos        => [140,125]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatNormalMode'}       ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 1                              ,
                                  -group      => 1                              , );
$winChat->AddRadioButton(         -name       => 'rbChatSafeMode'               ,
                                  -size       => [140, 22]                      ,
                                  -pos        => [270,125]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'chSafeMode'}             ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chSearched'                   ,
                                  -size       => [210, 20]                      ,
                                  -pos        => [415,125]                      ,
                                  -text       => $STR{'chSearched'}             ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddLabel(               -name       => 'lblChatDownload'              ,
                                  -size       => [ 75, 22]                      ,
                                  -pos        => [140,155]                      ,
                                  -text       => $STR{'download'}.':'           ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddCheckbox(            -name       => 'chDownloadImg'                ,
                                  -size       => [100, 20]                      ,
                                  -pos        => [220,155]                      ,
                                  -text       => $STR{'chDownloadImg'}          ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadImgFull'            ,
                                  -size       => [100, 20]                      ,
                                  -pos        => [375,155]                      ,
                                  -text       => $STR{'chFullSize'}             ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -disabled   => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadVid'                ,
                                  -size       => [105, 20]                      ,
                                  -pos        => [520,155]                      ,
                                  -text       => $STR{'chDownloadVid'}          ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadAD'                 ,
                                  -size       => [150, 20]                      ,
                                  -pos        => [220, 175]                     ,
                                  -text       => $STR{'chDownloadAD'}           ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadVM'                 ,
                                  -size       => [140, 20]                      ,
                                  -pos        => [375,175]                      ,
                                  -text       => $STR{'chDownloadVM'}           ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddLabel(               -name       => 'lblChatDates'                 ,
                                  -size       => [ 75, 22]                      ,
                                  -pos        => [140,200]                      ,
                                  -text       => $STR{'dates'}.':'              ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddRadioButton(         -name       => 'rbChatDatesAll'               ,
                                  -size       => [ 50, 22]                      ,
                                  -pos        => [220,200]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatDatesAll'}         ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 1                              ,
                                  -group      => 1                              , );
$winChat->AddRadioButton(         -name       => 'rbChatDatesRange'             ,
                                  -size       => [ 60, 22]                      ,
                                  -pos        => [220,220]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatDatesRange'}       ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblChatDatesRangeS'           ,
                                  -size       => [ 50, 22]                      ,
                                  -pos        => [285,223]                      ,
                                  -text       => $STR{'start'}.':'              ,
                                  -align      => 'right'                        ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddDateTime(            -name       => 'dtChatDatesRangeS'            ,
                                  -size       => [ 90, 22]                      ,
                                  -pos        => [340,220]                      ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                ,
                                  -format     => 'shortdate'                    ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblChatDatesRangeE'           ,
                                  -size       => [ 40, 22]                      ,
                                  -pos        => [435,223]                      ,
                                  -text       => $STR{'end'}.':'                ,
                                  -align      => 'right'                        ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddDateTime(            -name       => 'dtChatDatesRangeE'            ,
                                  -size       => [ 90, 22]                      ,
                                  -pos        => [480,220]                      ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                ,
                                  -format     => 'shortdate'                    ,
                                  -tabstop    => 1                              , );
$winChat->AddCheckbox(            -name       => 'chHideMe'                     ,
                                  -size       => [220, 20]                      ,
                                  -pos        => [140,245]                      ,
                                  -text       => $STR{'chHideMe'}               ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

$winChat->AddButton(              -name       => 'btnChatOk'                    ,
                                  -size       => [ 85, 30]                      ,
                                  -pos        => [300,270]                      ,
                                  -text       => $STR{'dump'}                   ,
                                  -font       => $font10                        ,
                                  -disabled   => 1                              ,
                                  -tabstop    => 1                              ,
                                  -ok         => 1                              ,
                                  -default    => 1                              , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfigPosX   = ($scrnX - 650) / 2;
my $winConfigPosY   = ($scrnY - 300) / 2;
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'                    ,
                                            -parent      => $win                           ,
                                            -text        => $STR{'winConfig'}              ,
                                            -pos         => [$winConfigPosX, $winConfigPosY] ,
                                            -size        => [650,300]                      , # 532 to 650, 285 to 340
                                            -background  => [255, 255, 255]                ,
                                            -hasmaximize => 0                              ,
                                            -hasminimize => 0                              ,
                                            -helpbutton  => 0                              ,
                                            -resizable   => 0                              ,
                                            -topmost     => 1                              ,
                                            -dialogui    => 1                              , );
$winConfig->SetIcon($winICO);

$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $configBmp            ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'           ,
                                    -size         => [500,260]             ,
                                    -pos          => [140,  5]             ,
                                    -fixedwidth   => 1                     ,
                                    -tabstop      => 1                     ,
                                    -background   => [255, 255, 255]       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblGenOpt'}     , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblScrollOpt'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblExpOpt'}     , );
$winConfig->configTab->SetItemSize(126,20);

# General options
# Tool Section
$winConfig->AddLabel(     -name        => 'lblTool'             ,
                          -size        => [ 80, 22]             ,
                          -pos         => [150, 38]             ,
                          -background  => [255, 255, 255]       ,
                          -foreground  => [  0, 102, 204]       ,
                          -text        => $STR{'Tool'}.':'      ,
                          -font        => $fontGB2              , );
$winConfig->AddButton(    -name        => 'btnExportLang'       ,
                          -size        => [125, 24]             ,
                          -pos         => [150, 68]             ,
                          -text        => $STR{'btnExportLang'} ,
                          -font        => $font10               ,
                          -tabstop     => 1                     , );
$winConfig->AddButton(    -name        => 'btnCheckUpdate'      ,
                          -size        => [125, 24]             ,
                          -pos         => [150, 98]             ,
                          -text        => $STR{'menu13'}        ,
                          -font        => $font10               , );
$winConfig->AddCheckbox(  -name        => 'chAutoUpdate'        ,
                          -size        => [310, 20]             ,
                          -pos         => [285,100]             ,
                          -text        => $STR{'chAutoUpdate'}  ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     , );
# Functions section
$winConfig->AddLabel(     -name        => 'lblFunctions'        ,
                          -size        => [120, 22]             ,
                          -pos         => [150,140]             ,
                          -background  => [255, 255, 255]       ,
                          -foreground  => [  0, 102, 204]       ,
                          -text        => $STR{'Functions'}.':' ,
                          -font        => $fontGB2              , );
$winConfig->AddLabel(     -name        => 'lblTimeToWait'       ,
                          -size        => [115, 22]             ,
                          -pos         => [150,173]             ,
                          -text        => $STR{'lblTimeToWait'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddTextfield( -name        => 'tfTimeToWait'        ,
                          -size        => [ 40, 22]             ,
                          -pos         => [270,170]             ,
                          -tip         => $STR{'tfTimeToWaitTip'}, );
$winConfig->AddUpDown(    -name        => 'upTimeToWait'        ,
                          -tabstop     => 1                     , );
$winConfig->upTimeToWait->SetRange(1,10);
$winConfig->AddLabel(     -name        => 'lblTimeToWait2'      ,
                          -size        => [ 60, 22]             ,
                          -pos         => [313,173]             ,
                          -text        => $STR{'lblTimeToWait2'},
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddLabel(     -name        => 'lblNbrResume'        ,
                          -size        => [135, 22]             ,
                          -pos         => [400,173]             ,
                          -text        => $STR{'lblNbrResume'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddTextfield( -name        => 'tfNbrResume'         ,
                          -size        => [ 40, 22]             ,
                          -pos         => [540,170]             ,
                          -tip         => $STR{'tfNbrResumeTip'}, );
$winConfig->AddUpDown(    -name        => 'upNbrResume'         ,
                          -tabstop     => 1                     , );
$winConfig->upNbrResume->SetRange(1,99);
$winConfig->AddCheckbox(  -name        => 'chDelTempFiles'      ,
                          -size        => [230, 20]             ,
                          -pos         => [150,200]             ,
                          -text        => $STR{'chDelTempFiles'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     , );
$winConfig->AddCheckbox(  -name        => 'chDebugLogging'      ,
                          -size        => [200, 20]             ,
                          -pos         => [400,200]             ,
                          -text        => $STR{'chDebugLogging'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     , );
$winConfig->AddLabel(     -name        => 'lblCharset'          ,
                          -size        => [ 70, 22]             ,
                          -pos         => [150,233]             ,
                          -text        => $STR{'lblCharset'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddCombobox(  -name        => 'cbCharset'           ,
                          -size        => [110,100]             ,
                          -pos         => [235,230]             ,
                          -font        => $font10               ,
                          -dropdown    => 1                     ,
                          -vscroll     => 1                     ,
                          -tabstop     => 1                     , );
$winConfig->cbCharset->Add('cp1252'     , 'iso-8859-1' , 'iso-8859-2' , 'iso-8859-3' ,
                           'iso-8859-4' , 'iso-8859-5' , 'iso-8859-6' , 'iso-8859-7' ,
                           'iso-8859-8' , 'iso-8859-9' , 'iso-8859-10', 'iso-8859-11', 
                           'iso-8859-13', 'iso-8859-14', 'iso-8859-15', 'iso-8859-16', );

# Scroll options
$winConfig->AddLabel(       -name        => 'lblMaxScrollChat'    ,
                            -size        => [165, 22]             ,
                            -pos         => [150, 48]             ,
                            -text        => $STR{'lblMaxLoading'}.':',
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -visible     => 0                     , );
$winConfig->AddRadioButton( -name        => 'rbMaxScrollChatByPage',
                            -size        => [100, 22]             ,
                            -pos         => [320, 45]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByPage'}.':' ,
                            -font        => $font10               ,
                            -checked     => 1                     ,
                            -group       => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddTextfield(   -name        => 'tfMaxScrollChat'     ,
                            -size        => [ 40, 22]             ,
                            -pos         => [425, 45]             ,
                            -tip         => $STR{'tfMaxScrollByPageTip'},
                            -number      => 1                     ,
                            -tabstop     => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddUpDown(      -name        => 'upMaxScrollChat'     ,
                            -tabstop     => 1                     , );
$winConfig->upMaxScrollChat->SetRange(0,99);
$winConfig->AddRadioButton( -name        => 'rbMaxScrollChatByDate',
                            -size        => [100, 22]             ,
                            -pos         => [320, 75]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByDate'}.':' ,
                            -font        => $font10               ,
                            -visible     => 0                     , );
$winConfig->AddDateTime(    -name        => 'dtMaxScrollChatByDate',
                            -size        => [ 90, 22]             ,
                            -pos         => [425, 75]             ,
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -format      => 'shortdate'           ,
                            -tip         => $STR{'tfMaxScrollByDateTip'},
                            -visible     => 0                     , );
$winConfig->AddLabel(       -name        => 'lblMaxScroll'        ,
                            -size        => [165, 22]             ,
                            -pos         => [150,108]             ,
                            -text        => $STR{'lblMaxScroll'}.':',
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -visible     => 0                     , );
$winConfig->AddRadioButton( -name        => 'rbMaxScrollByPage'   ,
                            -size        => [100, 22]             ,
                            -pos         => [320,105]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByPage'}.':' ,
                            -font        => $font10               ,
                            -checked     => 1                     ,
                            -group       => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddTextfield(   -name        => 'tfMaxScroll'         ,
                            -size        => [ 40, 22]             ,
                            -pos         => [425,105]             ,
                            -tip         => $STR{'tfMaxScrollByPageTip'},
                            -number      => 1                     ,
                            -tabstop     => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddUpDown(      -name        => 'upMaxScroll'         ,
                            -tabstop     => 1                     , );
$winConfig->upMaxScroll->SetRange(0,99);
$winConfig->AddRadioButton( -name        => 'rbMaxScrollByDate'   ,
                            -size        => [100, 22]             ,
                            -pos         => [320,135]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByDate'}.':' ,
                            -font        => $font10               ,
                            -visible     => 0                     , );
$winConfig->AddDateTime(    -name        => 'dtMaxScrollByDate'   ,
                            -size        => [ 90, 22]             ,
                            -pos         => [425,135]             ,
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -format      => 'shortdate'           ,
                            -tip         => $STR{'tfMaxScrollByDateTip'},
                            -visible     => 0                     , );
$winConfig->AddCheckbox(    -name        => 'chOptScrollTop'      ,
                            -size        => [310, 20]             ,
                            -pos         => [150,170]             ,
                            -text        => $STR{'chOptScrollTop'},
                            -background  => [255, 255, 255]       ,
                            -font        => $font10               ,
                            -tabstop     => 1                     ,
                            -checked     => 1                     , );

# Expand options
$winConfig->AddCheckbox(  -name        => 'chOptSeemore'        ,
                          -size        => [200, 20]             ,
                          -pos         => [150, 35]             ,
                          -text        => $STR{'chOptSeemore'}  ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptComments'       ,
                          -size        => [305, 20]             ,
                          -pos         => [150, 60]             ,
                          -text        => $STR{'chOptComments'} ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptPosts'          ,
                          -size        => [200, 20]             ,
                          -pos         => [150, 85]             ,
                          -text        => $STR{'chOptPosts'}    ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptTranslate'      ,
                          -size        => [200, 20]             ,
                          -pos         => [150,110]             ,
                          -text        => $STR{'chOptTranslate'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );

#------------------------------------------------------------------------------#
# Progress window
#------------------------------------------------------------------------------#
my $winProgressPosX = ($scrnX - 740) / 2;
my $winProgressPosY = ($scrnY - 180) / 2;
my $winPb = Win32::GUI::DialogBox->new( -name        => 'winPb'                   ,
                                        -parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winProgressPosX, $winProgressPosY],
                                        -size        => [740, 180]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -topmost     => 1                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);

$winPb->AddLabel(       -name        => 'lblLogo'        ,
                        -size        => [128,128]        ,
                        -pos         => [  0, 10]        ,
                        -bitmap      => $logoBmp         ,
                        -background  => [255, 255, 255]  , );
$winPb->AddLabel(       -name        => 'lblPbCurr1'     ,
                        -size        => [578, 22]        ,
                        -pos         => [140,  8]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb1'       ,
                        -size        => [470, 22]        ,
                        -pos         => [140, 32]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount1'      ,
                        -size        => [100, 22]        ,
                        -pos         => [620, 33]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddLabel(       -name        => 'lblPbCurr2'     ,
                        -size        => [578, 22]        ,
                        -pos         => [140, 60]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb2'       ,
                        -size        => [470, 22]        ,
                        -pos         => [140, 84]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount2'      ,
                        -size        => [100, 22]        ,
                        -pos         => [620, 85]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [330,115]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winProgress2PosX = ($scrnX - 550) / 2;
my $winProgress2PosY = ($scrnY - 175) / 2;
my $winPb2 = Win32::GUI::DialogBox->new(-name        => 'winPb2'                  ,
                                        -parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winProgress2PosX, $winProgress2PosY],
                                        -size        => [590,175]                 ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -topmost     => 1                         ,
                                        -dialogui    => 1                         , );
$winPb2->SetIcon($winICO);

$winPb2->AddLabel(      -name        => 'lblLogo'        ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logoBmp         ,
                        -background  => [255, 255, 255]  , );
$winPb2->AddLabel(      -name        => 'lblPbCurr'      ,
                        -size        => [350, 40]        ,
                        -pos         => [140, 30]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb2->AddLabel(      -name        => 'lblCount'       ,
                        -size        => [ 80, 22]        ,
                        -pos         => [495, 30]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb2->AddButton(     -name        => 'btnCancel2'     ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [280, 80]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#

# Center the splash and show it
$splash->Center();
$splash->Show();
Win32::GUI::DoEvents();

# Taskbar
$win->Tray->Change(-balloon_icon    => 'info'         ,
                   -balloon_title   => 'ExtractFace'  ,
                   -balloon_timeout => 5000           , );

# Header Dump albums grid
$winAlbums->GridAlbums->SetRows(1);
$winAlbums->GridAlbums->SetColumns(3); # 1: checkbox, 2: Album name, 3e: Album url
$winAlbums->GridAlbums->SetCellText(0, 0, ''        );
$winAlbums->GridAlbums->SetCellType(0, 0, GVIT_CHECK);
$winAlbums->GridAlbums->SetCellCheck(0, 0, 1);
$winAlbums->GridAlbums->SetCellText(0, 1, $STR{'albumNames'});
$winAlbums->GridAlbums->SetCellText(0, 2, $STR{'albumURLs'});
$winAlbums->GridAlbums->SetColumnWidth(0, 25);
$winAlbums->GridAlbums->SetColumnWidth(1, 80);
$winAlbums->GridAlbums->ExpandLastColumn();

# Header Dump friends grid
$winFriends->GridFriends->SetRows(1);
$winFriends->GridFriends->SetColumns(4); # 1: checkbox, 2: Category name, 3e: Category Id (hidden), 4e: Category url
$winFriends->GridFriends->SetCellText(0, 0, ''        );
$winFriends->GridFriends->SetCellType(0, 0, GVIT_CHECK);
$winFriends->GridFriends->SetCellCheck(0, 0, 1);
$winFriends->GridFriends->SetCellText(0, 1, $STR{'friendCat'});
$winFriends->GridFriends->SetCellText(0, 3, $STR{'url'});
$winFriends->GridFriends->SetColumnWidth(0, 25);
$winFriends->GridFriends->SetColumnWidth(1, 80);
$winFriends->GridFriends->SetColumnWidth(2, 0);
$winFriends->GridFriends->ExpandLastColumn();

&loadConfig(\%CONFIG);

# Auto-Update
if ($CONFIG{'AUTO_UPDATE'} == 1) { threads->create(sub { &checkUpdate(0); }); }

my $API = new Win32::API('user32','GetForegroundWindow','', 'N');
Win32::GUI::DoEvents();
usleep(500000);
$splash->Hide;

$START = 1;
if (!$CONFIG{'START_MINIMIZED'}) { $win->Show(); }
Win32::GUI::Dialog();

#--------------------------#
sub chStartMinimized_Click
#--------------------------#
{
  # Save the choice
  if ($win->chStartMinimized->Checked()) {
    $CONFIG{'START_MINIMIZED'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'START_MINIMIZED'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chStartMinimized_Click

#--------------------------#
sub main_Terminate
#--------------------------#
{
  $win->Disable();  # Act as minimize, to quit, user must use the taskbar function
  $win->Hide();
  if ($THR and $THR->is_running()) { $win->Tray->ShowBalloon(); }
  return(0);

}  #--- End main_Terminate

#--------------------------#
sub main_Quit
#--------------------------#
{
  $win->Tray->Remove();
  -1; # Exit signal

}  #--- End main_Quit

#--------------------------#
sub main_Minimize
#--------------------------#
{
  $win->Disable();
  $win->Hide();
  if ($THR and $THR->is_running()) { $win->Tray->ShowBalloon(); }
  return(0);

}  #--- End main_Minimize

#--------------------------#
sub Tray_DblClick
#--------------------------#
{
  $win->Enable();
  $win->Show();  

}  #--- End Tray_DblClick

#--------------------------#
sub Tray_RightClick
#--------------------------#
{
  $win->TrackPopupMenu($trayMenu->{SysTray});
  return(1);

}  #--- End Tray_Click

#--------------------------#
sub scroll
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&scrollThr, $nbrRetries, $count);
  }
}  #--- End scroll

#--------------------------#
sub scrollThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollThr, $nbrRetries, $count);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
    &scrollToBottom(\$mech, $CONFIG{'TIME_TO_WAIT'}, $count);
    
    # Scroll to the top
    if ($winConfig->chOptScrollTop->Checked()) { $mech->eval_in_page('window.scrollTo(0,0)'); }
    
    $win->Tray->Change(-tip => $STR{'scrollTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
    $win->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End scrollThr

#--------------------------#
sub expand
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    if ($winConfig->chOptSeemore->Checked()  or $winConfig->chOptPosts->Checked()    or
        $winConfig->chOptComments->Checked() or $winConfig->chOptTranslate->Checked()) {
      # Start the thread
      my $nbrRetries = 0;
      $THR = threads->create(\&expandThr, $nbrRetries);
    } else { Win32::GUI::MessageBox($win, $STR{'warn2'}, $STR{'warn2T'}, 0x40010); }
  }
}  #--- End expand

#--------------------------#
sub expandThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'expandTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&expandThr, $nbrRetries);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'expandTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'expandTaskP'}.'...');
    &expandContent(\$mech);
    &expandContent(\$mech); # Do it again
    
    $win->Tray->Change(-tip => $STR{'expandTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'expandTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
    $win->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End expandThr

#--------------------------#
sub scrollExpand
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $status     = 0; # If status == 1, scrolling finished
    my $count      = 0;
    $THR = threads->create(\&scrollExpandThr, $nbrRetries, $status, $count);
  }
}  #--- End scrollExpand

#--------------------------#
sub scrollExpandThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $status, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrExpTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->Tray->Change(-tip => 'ExtractFace');
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollExpandThr, $nbrRetries, $status, $count);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  if ($mech->uri() =~ /facebook.com/) {
    # Show starting of the process
    $win->Tray->Change(-tip => $STR{'scrollTaskP'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollTaskP'} , );
      $win->Tray->ShowBalloon(1);
    }
    
    # Scroll one page at a time and expand until end of page is reached
    $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
    my $maxScrollByDate = $winConfig->rbMaxScrollByDate->Checked();
    my $maxDate;
    my $maxScroll;
    if ($maxScrollByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScroll = $winConfig->tfMaxScroll->Text(); }
   
    my $end = &scrollPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
    $count++;
    while (!$end) { # If $end == 1, we reached the end of the page
      # Expand
      if ($winConfig->chOptSeemore->Checked()  or $winConfig->chOptPosts->Checked()    or
          $winConfig->chOptComments->Checked() or $winConfig->chOptTranslate->Checked()) {
        # Expand all additional content
        $winPb2->lblPbCurr->Text($STR{'expandTaskP'}.'...');
        $win->Tray->Change(-tip => $STR{'expandTaskP'}.'...');
        &expandContent(\$mech);
        &expandContent(\$mech); # Do it again
      }
      
      # Scroll again
      $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
      if ($maxScrollByDate and $maxDate) { # Stop by date
        my $lastDisplayedDate = ($mech->selector('a._5pcq abbr'))[-1];
        if ($lastDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
          my $date = $1;
          if ($date <= $maxDate) { last; }
        }
      } elsif ($maxScroll and $count >= $maxScroll) { last; } # Stop by page
      $end = &scrollPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
      $count++;
    }
    
    # Scroll to the top
    if ($winConfig->chOptScrollTop->Checked()) { $mech->eval_in_page('window.scrollTo(0,0)'); }
    
    $win->Tray->Change(-tip => $STR{'expandTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrExpTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;
  $win->ChangeCursor($ARROW);

}  #--- End scrollExpandThr

#--------------------------#
sub winAlbums
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winAlbumsThr);
    
    usleep(500000);
    $winAlbums->GridAlbums->AutoSize();
    $winAlbums->Center();
    $winAlbums->DoModal();
  }

}  #--- End winAlbums

#--------------------------#
sub winAlbumsThr
#--------------------------#
{
  # Local variables
  my $tempDir = "$USERDIR\\temp";
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winAlbumsThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winAlbums, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winAlbums->btnAlbumsOk->Disable();
      Win32::GUI::MessageBox($winAlbums, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Gather album names
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    $winAlbums->ChangeCursor($HOURGLASS);
    &validAlbumPage(\$mech);

    # Get album names and urls
    $winAlbums->GridAlbums->DeleteNonFixedRows();
    my %albums;
    my @albums = $mech->selector('td._51m-.vTop.hLeft.pbm.prm a.photoTextTitle');
    foreach my $album (@albums) {
      my $albumName = $album->{innerHTML};
      $albumName   =~ s/<[^\>]+>//g;
      $albumName   = encode($CONFIG{'CHARSET'}, $albumName);
      my $albumUrl = $album->{href};
      $albums{$albumName} = $albumUrl;
    }
    
    # Feed the Album Grid
    foreach my $albumName (sort keys %albums) {
      if (exists($albums{$albumName}) and my $i = $winAlbums->GridAlbums->InsertRow($albumName, -1)) {
        $winAlbums->GridAlbums->SetCellText($i, 0, ''        );
        $winAlbums->GridAlbums->SetCellType($i, 0, GVIT_CHECK);
        $winAlbums->GridAlbums->SetCellCheck($i, 0, 1);
        $winAlbums->GridAlbums->SetCellText($i, 1, $albumName);
        $winAlbums->GridAlbums->SetCellText($i, 2, $albums{$albumName});
        $winAlbums->GridAlbums->AutoSize();
        $winAlbums->GridAlbums->Refresh();
      }
    }
    
    $winAlbums->lblInProgress->Text('');
    $winAlbums->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winAlbums, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Ready ?
  &isDumpAlbumsReady();

}  #--- End winAlbumsThr

#--------------------------#
sub validAlbumPage
#--------------------------#
{
  # Local variables
  my ($refMech) = @_;
  
  my $currURL = $$refMech->uri();
  my $currTitle;
  if ($currURL !~ /photos_albums$/ and $currURL !~ /collection_token=\w+%\w+%3A6$/) {
    # Trying to get the good page
    if ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) {
      my $profilID = $1;
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      my $goodURL = "https://www.facebook.com/profile.php?id=$profilID&sk=photos&collection_token=$profilID%3A2305272732%3A6";
      ($currURL, $currTitle) = &loadPage($refMech, $goodURL);
    } elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/]+)/) {
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      my $goodURL = "https://www.facebook.com/$1/photos_albums";
      ($currURL, $currTitle) = &loadPage($refMech, $goodURL);
    }
    
    # Re evaluate current page
    if (($currURL !~ /photos_albums$/ and $currURL !~ /collection_token=\w+%\w+%3A6$/) or $currTitle =~ /Page Not Found/) {
      $winAlbums->btnAlbumsOk->Disable();
      Win32::GUI::MessageBox($winAlbums, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    } else {
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
    }
  # You are in the right page, scroll down to load the whole page
  } else {
    if ($currURL and $currURL =~ /https:\/\/www.facebook.com\//) {
      if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
      elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
    }
    $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
  }
  
  # Write title (used for HTML Album)
  if ($currTitle) {
    $currTitle .= " - Albums";
    $winAlbums->tfAlbumTitle->Text($currTitle);
  }

}  #--- End validAlbumPage

#--------------------------#
sub tfDirSaveAlbums_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
  
  # Remember
  if ($saveDir and -d $saveDir and $winAlbums->chSaveAlbumDir->Checked()) {
      $CONFIG{'DIR_SAVE_ALBUMS'} = $saveDir;
      &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpAlbumsReady();

}  #--- End tfDirSaveAlbums_Change

#--------------------------#
sub btnDirSaveAlbums_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winAlbums->tfDirSaveAlbums->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winAlbums     ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winAlbums     ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winAlbums->tfDirSaveAlbums->Text($dir);
  }
  
}  #--- End btnDirSaveAlbums_Click

#--------------------------#
sub chSaveAlbumDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winAlbums->tfDirSaveAlbums->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winAlbums->chSaveAlbumDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_ALBUMS'} = 1;
    $CONFIG{'DIR_SAVE_ALBUMS'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winAlbums->chSaveAlbumDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_ALBUMS'} = 0;
    delete($CONFIG{'DIR_SAVE_ALBUMS'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveAlbumDir_Click

#--------------------------#
sub GridAlbums_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  
  # Select
  if (!$column) {
    my $selStatus = $winAlbums->GridAlbums->GetCellCheck($row, $column);
    if (!$row) {
      # Check all
      if (!$selStatus) { for (my $i = 0; $i < $winAlbums->GridAlbums->GetRows(); $i++) { $winAlbums->GridAlbums->SetCellCheck($i, 0, 1); } }
      # Uncheck all
      else             { for (my $i = 0; $i < $winAlbums->GridAlbums->GetRows(); $i++) { $winAlbums->GridAlbums->SetCellCheck($i, 0, 0); } }
    } else {
      # Check
      if (!$selStatus) { $winAlbums->GridAlbums->SetCellCheck($row, $column, 1); }
      # Uncheck
      else             { $winAlbums->GridAlbums->SetCellCheck($row, $column, 0); }
    }
  }
  
  return(1);

}  #--- End GridAlbums_Click

#--------------------------#
sub chPublishDate_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chPublishDate->Checked()) {
    $CONFIG{'ALBUMS_PUBLISH_DATE'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_PUBLISH_DATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chPublishDate_Click

#--------------------------#
sub chAlbumsOpenHTML_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chAlbumsOpenHTML->Checked()) {
    $CONFIG{'ALBUMS_OPEN_HTML'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_OPEN_HTML'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAlbumsOpenHTML_Click

#--------------------------#
sub chAlbumsOpenDir_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chAlbumsOpenDir->Checked()) {
    $CONFIG{'ALBUMS_OPEN_DIR'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_OPEN_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAlbumsOpenDir_Click

#--------------------------#
sub isDumpAlbumsReady
#--------------------------#
{
  # Local variables
  my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
  
  # Valid directory for save ?
  if (!$saveDir or !(-d $saveDir)) { $winAlbums->btnAlbumsOk->Disable(); return(0); }
  
  # Albums name loaded and at least one checked ?
  my $albumChecked = 0;
  for (my $i = 1; $i < $winAlbums->GridAlbums->GetRows(); $i++) {
    my $selStatus = $winAlbums->GridAlbums->GetCellCheck($i, 0);
    if ($selStatus == 1) {
      $albumChecked = 1;
      last;
    }
  }
  if (!$albumChecked) { $winAlbums->btnAlbumsOk->Disable(); return(0); }
  
  $winAlbums->btnAlbumsOk->Enable();

}  #--- End isDumpAlbumsReady

#--------------------------#
sub btnAlbumsOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
    my $mainAlbumTitle    = $winAlbums->tfAlbumTitle->Text();
    $mainAlbumTitle       =~ s/[\<\>\:\"\/\\\|\?\*]/_/g;
    my %listAlbums        = ();
    my $refListAlbums     = \%listAlbums;     # Album names and urls
    my %listPics          = ();
    my $refListPics       = \%listPics;       # Album, File path and index (position of the picture in the album)
    my %listVideoFiles    = ();
    my $refListVideoFiles = \%listVideoFiles; # Video file path
    my %listPicsDate      = ();
    my $refListPicsDate   = \%listPicsDate;   # Publication date
    my $nbrAlbums         = 0;
    my $posPb1            = 0;
    my $nbrRetries        = 0;
    my $tabCurrentTitle;
    
    if (-d $saveDir and $mainAlbumTitle) {
      # Start the thread
      $THR = threads->create(\&dumpAlbums, $saveDir, $mainAlbumTitle, $refListAlbums, $refListPics,
                             $refListVideoFiles, $refListPicsDate, $nbrAlbums, $tabCurrentTitle, 
                             $posPb1, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err4'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnAlbumsOk_Click

#--------------------------#
sub dumpAlbums
#--------------------------#
{
  # Local variables
  my ($saveDir, $mainAlbumTitle, $refListAlbums, $refListPics, $refListVideoFiles,
      $refListPicsDate, $nbrAlbums, $tabCurrentTitle, $posPb1, $nbrRetries) = @_;
  my $firstExec = 0;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpAlbumC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $posPb1 = $winPb->pbWinPb1->GetPos();
    $winPb->pbWinPb2->SetPos(0);
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpAlbums, $saveDir, $mainAlbumTitle, $refListAlbums, $refListPics,
                             $refListVideoFiles, $refListPicsDate, $nbrAlbums, $tabCurrentTitle,
                             $posPb1, $nbrRetries);
    } else {
      Win32::GUI::MessageBox($winPb, $STR{'err2'}, $STR{'err1T'}, 0x40010);
    }
    # Kill this thread
    threads->exit();
  };
  
  # First execution, must gather album names and urls
  if (!$posPb1 and !$nbrAlbums) {
    $firstExec = 1;
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpAlbumP'}.'...');
    for (my $i = 1; $i < $winAlbums->GridAlbums->GetRows(); $i++) {
      my $selStatus = $winAlbums->GridAlbums->GetCellCheck($i, 0);
      if ($selStatus == 1) {
        my $albumName = decode($CONFIG{'CHARSET'}, $winAlbums->GridAlbums->GetCellText($i, 1));
        my $albumURL  = $winAlbums->GridAlbums->GetCellText($i, 2);
        $$refListAlbums{$albumName}{'url'}  = $albumURL;
        $$refListAlbums{$albumName}{'name'} = $albumName;
      }
    }
    # Number of album
    $nbrAlbums = keys %{$refListAlbums};
  }
  
  if ($nbrAlbums > 0) {
    my $count1;
    
    # First execution, turn on the progress window
    if ($firstExec == 1) {
      # Turn on progress bar
      $winPb->Center();
      $winPb->Show();
      $win->Disable();
      $winPb->pbWinPb1->SetRange(0, $nbrAlbums);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      $count1 = 0;
    # If on resume state, get number of albums left
    } else {
      my $nbrCurrAlbums = keys %{$refListAlbums};
      $count1 = $nbrAlbums - $nbrCurrAlbums;
    }
    
    # Parse each album
    foreach my $album (sort keys %{$refListAlbums}) {
      my $encodedName = encode($CONFIG{'CHARSET'}, $$refListAlbums{$album}{name});
      my %listPics;
      my @listVideos;
      
      $winPb->lblPbCurr1->Text("$STR{'opening'}: $encodedName");
      $winPb->lblCount1->Text("$count1/$nbrAlbums");
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      
      my $albumDir;
      if ($$refListAlbums{$album}{'url'} =~ /\?set=([^\&]+)&/) { $albumDir = $1; }
      if (!$albumDir) { $albumDir = $count1; }
      $$refListPics{$album}{'dir'} = $albumDir;
      
      # Gather album page
      my $mechAlbum = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
      if (!exists($$refListAlbums{$album}{'nbrPics'}) and !exists($$refListAlbums{$album}{'nbrVideos'})) {
        if (!-d "$saveDir\\$mainAlbumTitle"                 ) { mkdir("$saveDir\\$mainAlbumTitle");                  }
        if (!-d "$saveDir\\$mainAlbumTitle\\$albumDir"      ) { mkdir("$saveDir\\$mainAlbumTitle\\$albumDir");       }
        if (!-d "$saveDir\\$mainAlbumTitle\\$albumDir\\temp") { mkdir("$saveDir\\$mainAlbumTitle\\$albumDir\\temp"); }
        $mechAlbum->get($$refListAlbums{$album}{'url'}, synchronize => 0);
        $winPb->lblPbCurr1->Text("$STR{'scrolling'}: $encodedName");
        sleep($CONFIG{'TIME_TO_WAIT'});
        &scrollAlbumPage(\$mechAlbum, $CONFIG{'TIME_TO_WAIT'});
      }
      
      $winPb->lblPbCurr1->Text("$STR{'parsing'}: $encodedName");
      
      # Video album
      if ($$refListAlbums{$album}{'url'} =~ /set=vb/) {
        my %listVideos;
        my %videoNames;
        
        # Gather video urls and corresponding preview picture urls
        my @videos = $mechAlbum->selector('div._5h60 div._53s');
        foreach my $video (@videos) {
          my $videoUrl = $mechAlbum->selector('a', one => 1, node => $video);
          if ($videoUrl and $video->{outerHTML} =~ /data-starred-src="([^\"]+)" /) {
            my $picURL = $1;
            $picURL =~ s/&amp;/&/g;
            my $videoPageURL = $videoUrl->{href};
            if ($videoPageURL =~ /\/([^\/]+)\/\?type=/) {
              my $vd = $1;
              if (!exists($videoNames{$vd})) {
                $videoNames{$vd} = 1;
                if ($videoPageURL !~ /^http/) { $videoPageURL = 'https://www.facebook.com'.$videoPageURL; }
                $videoPageURL =~ s/&amp;/&/g;
                $listVideos{$videoUrl->{href}} = $picURL;
              }
            }
          }
        }
        @videos = ();
        $$refListAlbums{$album}{'nbrVideos'} = keys %listVideos;
        
        # Gather preview picture
        if ($$refListAlbums{$album}{'nbrVideos'} > 0) {
          my $count2 = 0;
          $winPb->pbWinPb2->SetRange(0, $$refListAlbums{$album}{'nbrVideos'});
          $winPb->pbWinPb2->SetPos(0);
          $winPb->pbWinPb2->SetStep(1);
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          foreach my $videoPage (keys %listVideos) {
            my $pic;
            if ($listVideos{$videoPage} =~ /\/([^\/\?]+)(?:\?|$)/) {
              my $pic = $1;
              my $picPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$pic";
              $winPb->lblPbCurr2->Text("$STR{'downloading'}: $pic");
              # Download the picture if does not exist
              $$refListPics{$album}{$picPath} = $count2;
              $$refListVideoFiles{$videoPage} = $picPath;
              if (!-e $picPath) {
                $mechAlbum->save_url($listVideos{$videoPage}, $picPath);
              }
              $count2++;
              $winPb->pbWinPb2->StepIt();
              $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
            }
          }
        
          # Gather videos
          $count2 = 0;
          $winPb->pbWinPb2->SetPos(0);
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          foreach my $videoPage (keys %listVideos) {
            if ($videoPage =~ /vb\.[^\/]+\/([^\/]+)/) {
              # Gather page with the video
              $winPb->lblPbCurr2->Text("$STR{'opening'}: $videoPage");
              my $videoName = $1;
              $mechAlbum->get($videoPage, synchronize => 0);
              sleep($CONFIG{'TIME_TO_WAIT'}+1);
              # Download the video
              if (my $videoURL = ($mechAlbum->selector('video'))[-1]->{src}) {
                my $videoPath;
                $videoURL =~ s/&amp;/&/g;
                $winPb->lblPbCurr2->Text("$STR{'downloading'}: $videoURL");
                # Get the publication date
                if ($winAlbums->chPublishDate->Checked) {
                  my $videoDateCode = $mechAlbum->selector('a._39g5', any => 1);
                  if ($videoDateCode and $videoDateCode->{innerHTML} =~ /data-utime="([^\"]+)"/) {
                    $$refListPicsDate{$$refListVideoFiles{$videoPage}} = $1;
                  }
                }
                $videoPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$videoName\.mp4";
                $mechAlbum->save_url($videoURL, $videoPath); # Download video
                my $picPath = $$refListVideoFiles{$videoPage};
                $$refListVideoFiles{$picPath} = $videoPath;
              }
            }
            
            # Update progress
            $count2++;
            $winPb->pbWinPb2->StepIt();
            $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          }
        }        
      # Picture album
      } else {
        # Gather picture urls
        my @pictures = $mechAlbum->selector('div._5h60 div._53s');
        my $i = 0;
        foreach my $picture (@pictures) {
          if ($picture->{outerHTML} =~ /class="uiMediaThumb _6i9 uiMediaThumbMedium"/ and $picture->{outerHTML} =~ /data-starred-src="([^\"]+)" /) {
            my $picURL = $1;
            $picURL =~ s/&amp;/&/g;
            my $picturePage;
            if ($picture->{outerHTML} =~ /ajaxify="([^\"]+)"/) { $picturePage = $1; }
            $listPics{$picURL}{'ind'} = $i;
            if ($picturePage) { $listPics{$picURL}{'picPage'} = $picturePage; }
            else              { $listPics{$picURL}{'picPage'} = 0; }
            $i++;
          }
        }
        @pictures = ();
        
        # Gather pictures
        $$refListAlbums{$album}{'nbrPics'} = (keys %listPics);
        if ($$refListAlbums{$album}{'nbrPics'} > 0) {
          $winPb->pbWinPb2->SetRange(0, $$refListAlbums{$album}{'nbrPics'});
          $winPb->pbWinPb2->SetPos(0);
          $winPb->pbWinPb2->SetStep(1);
          my $count2 = 0;
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrPics'}");
          foreach my $picURL (sort {$listPics{$a}{'ind'} <=> $listPics{$b}{'ind'}} keys %listPics) {
            if ($picURL =~ /\/([^\/\?]+)(?:\?|$)/) {
              my $pic = $1;
              $pic = encode($CONFIG{'CHARSET'}, $pic);
              my $picPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$pic";
              $winPb->lblPbCurr2->Text("$STR{'downloading'}: $pic");
              my $picOk = 0;
              # If picture exists, verify integrity
              if (-e $picPath) {
                my $info = image_info($picPath);
                if (!$info->{error}) { $picOk = 1; }
              }
              # If picture doesn't exist, or exists and corrupted, or was not downloaded in this instance
              if (!-e $picPath or (-e $picPath and !$picOk) or !exists($$refListPicsDate{$picPath})) {
                # Gather publication date
                if ($winAlbums->chPublishDate->Checked) {
                  my $mechPic;
                  my $publishDate;
                  if ($listPics{$picURL}{'picPage'}) {
                    if ($tabCurrentTitle) {
                      $mechPic = WWW::Mechanize::Firefox->new(tab => qr{$tabCurrentTitle}, create => 1, autodie => 0);
                    } else { $mechPic = WWW::Mechanize::Firefox->new(create => 1, autodie => 0); }
                    $mechPic->get($listPics{$picURL}{'picPage'}, synchronize => 0);
                    sleep($CONFIG{'TIME_TO_WAIT'}+1);
                    my $currentTitle = $mechPic->title;
                    if ($currentTitle =~ /([^\-]+ \- )/) { $tabCurrentTitle = $1; }
                    my $picDateCode = $mechPic->selector('a._39g5', any => 1);
                    # Try harder to get the publication date (5 times more and parse each possible tag)
                    if (!$picDateCode or $picDateCode->{innerHTML} !~ /data-utime/) {
                      my $k = 0;
                      while ($k < 5 and (!$picDateCode or $picDateCode->{innerHTML} !~ /data-utime/)) {
                        sleep(2);
                        my @allTimeCode = $mechPic->selector('a._39g5');
                        foreach (@allTimeCode) {
                          if ($_->{innerHTML} =~ /data-utime/) { $picDateCode = $_; last; }
                        }
                        $k++;
                      }
                    }
                    if ($picDateCode and $picDateCode->{innerHTML} =~ /data-utime="([^\"]+)"/) { $publishDate = $1; }
                  } else {
                    $mechPic = WWW::Mechanize::Firefox->new(tab => qr{[\d\_]+_\w\.\w+}, create => 1, autodie => 0);
                    $mechPic->get($picURL, synchronize => 0);
                    my $header   = $mechPic->res();
                    $publishDate = $header->last_modified; # Doesn't work most of the time because Firefox changes response (add html code)
                  }
                  $$refListPicsDate{$picPath} = $publishDate;
                  undef $mechPic;
                }
                $mechAlbum->save_url($picURL, $picPath);
              }
              $$refListPics{$album}{$picPath} = $count2;
            }
            
            # Update progress
            $count2++;
            $winPb->pbWinPb2->StepIt();
            $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrPics'}");
          }
        }
      }
      
      $count1++;
      $winPb->pbWinPb1->StepIt();
      $winPb->lblCount1->Text("$count1/$nbrAlbums");
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      
      # Delete completed album
      delete($$refListAlbums{$album});
      
      # Delete temporary files
      if (-d "$saveDir\\$mainAlbumTitle\\$albumDir\\temp" and $winConfig->chDelTempFiles->Checked()) {
        remove_tree("$saveDir\\$mainAlbumTitle\\$albumDir\\temp");
      }
    }
    
    # Create the HTML Album page
    my $htmlAlbumPage = "$saveDir\\$mainAlbumTitle.html";
    $mainAlbumTitle = encode('utf8', $mainAlbumTitle);
    open(HTML, ">:encoding(UTF-8)", $htmlAlbumPage);
    print HTML "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n";
    print HTML "<html>\n<head>\n<title>$mainAlbumTitle</title>\n";
    print HTML "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf8\">\n";
    print HTML "</head>\n";
    print HTML "<body style=\"font-family: Calibri, Verdana, Arial;\">\n";
    print HTML "<h1 style=\"color:#003300; font-size: 18pt; font-variant: small-caps; font-weight: bold;\" align=\"center\">";
    print HTML "$mainAlbumTitle</h1>\n";
    print HTML "<table border=1 cellspacing=0 cellpadding=1 align=\"center\" width=\"800\">\n";
    # For each album
    foreach my $album (keys %{$refListPics}) {
      print HTML "<tr><th colspan=4 height=\"60px\" style=\"color:#003300; background-color:#EEEEEE; font-size: 14pt; font-variant: small-caps; font-weight: bold;\">$album</th></tr>";
      my $count = 0;
      my $albumDir = $$refListPics{$album}{'dir'};
      delete($$refListPics{$album}{'dir'});
      foreach my $pic (sort {$$refListPics{$album}{$a} <=> $$refListPics{$album}{$b}} keys %{$$refListPics{$album}}) {
        my $fileName = (split(/\\/, $pic))[-1];
        my $filePath = ".\\$mainAlbumTitle\\$albumDir\\$fileName";
        if (!$count) { print HTML "<tr>\n"; }  # new row for each group of 4 pics
        print HTML "<td width=\"25%\" align=\"center\" style=\"font-size: 11pt;\">\n";
        if ($albumDir =~ /^vb\./ and exists($$refListVideoFiles{$pic})) { # Video
          my $videoFileName = (split(/\\/, $$refListVideoFiles{$pic}))[-1];
          my $videoPath = ".\\$mainAlbumTitle\\$albumDir\\$videoFileName";
          print HTML "<a href=\"$videoPath\">\n";
        } else { print HTML "<a href=\"$filePath\">\n"; }               # Picture
        print HTML "<img src=\"$filePath\" alt=\"$fileName\" width=\"200\" border=0>\n";
        print HTML "</a><br><br>\n";
        if ($winAlbums->chPublishDate->Checked) {
          if (exists($$refListPicsDate{$pic})) {
            my $dateStr;
            if ($$refListPicsDate{$pic}) { $dateStr = &formatDate($$refListPicsDate{$pic}); }
            else                         { $dateStr = $STR{'errorDate'};                    }
            print HTML "Date: <strong style=\"color:#339900;\">$dateStr</strong>\n";
          }
        }
        print HTML "</td>\n";
        $count++;
        if ($count == 4) { print HTML "</tr>\n"; $count = 0; } # End row
      }
      # Complete row (last row is not 4 pics)
      if ($count != 0) {
        while ($count != 4) {
          print HTML "<td>&nbsp;</td>\n";
          $count++;
        }
      }
    }
    print HTML "</table>\n</body>\n</html>\n";
    close(HTML);
    
    # Open the page
    if ($winAlbums->chAlbumsOpenHTML->Checked()) { $win->ShellExecute('open', $htmlAlbumPage,'','',1); }
    
    # Open the directory
    if ($winAlbums->chAlbumsOpenDir->Checked() ) {
      Win32::Process::Create(my $ProcessObj                 ,
                             "$ENV{'WINDIR'}\\explorer.exe" ,
                             "explorer $saveDir"             ,
                             0                              ,
                             NORMAL_PRIORITY_CLASS          ,
                             ".");
    }

    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
  }

  $win->Tray->Change(-tip => $STR{'dumpAlbumF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpAlbumF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);


}  #--- End dumpAlbums
  
#--------------------------#
sub winPb_Terminate
#--------------------------#
{
  $winPb->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winPb_Terminate

#--------------------------#
sub winPb2_Terminate
#--------------------------#
{
  $winPb2->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winPb2_Terminate

#--------------------------#
sub winAlbums_Terminate
#--------------------------#
{
  return(-1);

}  #--- End winAlbums_Terminate

#--------------------------#
sub winFriends
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winFriendsThr);
    
    usleep(500000);
    $winFriends->GridFriends->AutoSize();
    $winFriends->Center();
    $winFriends->DoModal();
  }

}  #--- End winFriends

#--------------------------#
sub winFriendsThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winFriends->tfDirSaveFriends->Text();
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winFriendsThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winFriends, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winFriends->btnFriendsOk->Disable();
      Win32::GUI::MessageBox($winFriends, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    $winFriends->GridFriends->DeleteNonFixedRows();
    $winFriends->tfFriendName->Text('');
    $winFriends->btnFriendsOk->Disable();
    $winFriends->lblInProgress->Text($STR{'wait'}.'...');
    $winFriends->ChangeCursor($HOURGLASS);
    my $currURL   = $mech->uri();
    my $currTitle;
    if ($currURL !~ /\/friends\/?$/ and $currURL !~ /\&sk=friends/) {
      # Trying to get the good page
      if ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) {
        my $profilID = $1;
        my $goodURL = "https://www.facebook.com/profile.php?id=$profilID&sk=friends";
        ($currURL, $currTitle) = &loadPage(\$mech, $goodURL);
      } elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/) {
        my $goodURL = "https://www.facebook.com/$1/friends";
        ($currURL, $currTitle) = &loadPage(\$mech, $goodURL);
      }
      
      # Re evaluate current page
      if (($currURL !~ /\/friends\/?$/ and $currURL !~ /\&sk=friends/) or $currTitle =~ /Page Not Found/) {
        $winFriends->btnFriendsOk->Disable();
        Win32::GUI::MessageBox($winFriends, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
        $winFriends->ChangeCursor($ARROW);
        $winFriends->lblInProgress->Text('');
        threads->exit();
      } else {
        if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
        elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
        $currTitle =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
        $winFriends->tfFriendName->Text("$currTitle - $STR{'friends'}");
      }
    # You are in the right page
    } else {
      if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
      elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
      $currTitle =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
      $winFriends->tfFriendName->Text("$currTitle - $STR{'friends'}");
    }
    
    # List available categories
    if ($winFriends->tfFriendName->Text()) {
      my %categories;
      my $header = $mech->selector('div._3dc.lfloat._ohe._5brz', one => 1)->{innerHTML};
      my @div    = split(/\>/, $header);
      foreach (@div) {
        if (/href=\"([^\"]+)\"/) {
          my $url  = $1;
          $url =~ s/&amp;/&/g;
          my $cat;
          if (/name=\"([^\"]+)\"/) { $cat = $1; }
          if ($cat) {
            $categories{$cat}{name} = $cat;
            $categories{$cat}{url}  = $url;
            if (/aria-controls=\"([^\"]+)\"/) {
              my $catId = $1;
              $categories{$cat}{catId} = $catId;
            }
          }
        }
      }
      
      foreach my $cat (sort keys %categories) {
        if ($categories{$cat} and my $i = $winFriends->GridFriends->InsertRow($cat, -1)) {
          $winFriends->GridFriends->SetCellText($i, 0, ''        );
          $winFriends->GridFriends->SetCellType($i, 0, GVIT_CHECK);
          $winFriends->GridFriends->SetCellCheck($i, 0, 1);
          $categories{$cat}{name} = encode($CONFIG{'CHARSET'}, $categories{$cat}{name});
          $winFriends->GridFriends->SetCellText($i, 1, $categories{$cat}{name});
          $winFriends->GridFriends->SetCellText($i, 2, $categories{$cat}{catId});
          $winFriends->GridFriends->SetCellText($i, 3, $categories{$cat}{url});
          $winFriends->GridFriends->AutoSize();
          $winFriends->GridFriends->ExpandLastColumn();
          $winFriends->GridFriends->Refresh();
        }
      }
    }
  } else { Win32::GUI::MessageBox($winFriends, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }

  $winFriends->ChangeCursor($ARROW);
  $winFriends->lblInProgress->Text('');
  
  # Ready ?
  &isDumpFriendsReady();

}  #--- End winFriendsThr

#--------------------------#
sub tfFriendName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winFriends->tfDirSaveFriends->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'DIR_SAVE_FRIENDS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpFriendsReady();

}  #--- End tfFriendName_Change

#--------------------------#
sub tfDirSaveFriends_Change
#--------------------------#
{
  # Local variables
  my $friendName = $winFriends->tfFriendName->Text();
  my $saveDir    = $winFriends->tfDirSaveFriends->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'DIR_SAVE_FRIENDS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpFriendsReady();

}  #--- End tfDirSaveFriends_Change

#--------------------------#
sub btnDirSaveFriends_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winFriends->tfDirSaveFriends->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winFriends    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winFriends    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winFriends->tfDirSaveFriends->Text($dir);
  }
  
}  #--- End btnDirSaveFriends_Click

#--------------------------#
sub chSaveFriendsDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winFriends->tfDirSaveFriends->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_FRIENDS'} = 1;
    $CONFIG{'DIR_SAVE_FRIENDS'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_FRIENDS'} = 0;
    delete($CONFIG{'DIR_SAVE_FRIENDS'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveFriendsDir_Click

#--------------------------#
sub chFriendsProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winFriends->chFriendsProfileIcons->Checked()) {
    $CONFIG{'FRIENDS_INCLUDE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'FRIENDS_INCLUDE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFriendsProfileIcons_Click

#--------------------------#
sub chFriendsOpenXLSX_Click
#--------------------------#
{
  # Save the choice
  if ($winFriends->chFriendsOpenXLSX->Checked()) {
    $CONFIG{'FRIENDS_OPEN_XLSX'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'FRIENDS_OPEN_XLSX'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFriendsOpenXLSX_Click

#--------------------------#
sub GridFriends_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  
  # Select
  if (!$column) {
    my $selStatus = $winFriends->GridFriends->GetCellCheck($row, $column);
    if (!$row) {
      # Check all
      if (!$selStatus) { for (my $i = 0; $i < $winFriends->GridFriends->GetRows(); $i++) { $winFriends->GridFriends->SetCellCheck($i, 0, 1); } }
      # Uncheck all
      else             { for (my $i = 0; $i < $winFriends->GridFriends->GetRows(); $i++) { $winFriends->GridFriends->SetCellCheck($i, 0, 0); } }
    } else {
      # Check
      if (!$selStatus) { $winFriends->GridFriends->SetCellCheck($row, $column, 1); }
      # Uncheck
      else             { $winFriends->GridFriends->SetCellCheck($row, $column, 0); }
    }
  }
  
  return(1);

}  #--- End GridFriends_Click

#--------------------------#
sub isDumpFriendsReady
#--------------------------#
{
  # Local variables
  my $saveDir    = $winFriends->tfDirSaveFriends->Text();
  my $friendName = $winFriends->tfFriendName->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$friendName) { $winFriends->btnFriendsOk->Disable(); return(0); }
  
  # Friends category loaded and at least one checked ?
  my $friendsChecked = 0;
  for (my $i = 1; $i < $winFriends->GridFriends->GetRows(); $i++) {
    my $selStatus = $winFriends->GridFriends->GetCellCheck($i, 0);
    if ($selStatus == 1) {
      $friendsChecked = 1;
      last;
    }
  }
  if (!$friendsChecked) { $winFriends->btnFriendsOk->Disable(); return(0); }

  $winFriends->btnFriendsOk->Enable();

}  #--- End isDumpFriendsReady


#--------------------------#
sub btnFriendsOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Local variables
    my $friendName = $winFriends->tfFriendName->Text();
    $friendName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir    = $winFriends->tfDirSaveFriends->Text();
    my %listCatFriends;
    my $refListCatFriends = \%listCatFriends;   # Friend categories and urls
    my $nbrCatFriends     = 0;
    my $posPb1            = 0;
    my $parsingDone       = 0;
    my $nbrGroupsDone     = 0;
    my $nbrRetries        = 0;

    if ($friendName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpFriends, $friendName, $saveDir, $refListCatFriends, $nbrCatFriends,
                             $nbrGroupsDone, $posPb1, $parsingDone, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnFriendsOk_Click

#--------------------------#
sub dumpFriends
#--------------------------#
{
  # Local variables
  my ($friendName, $saveDir, $refListCatFriends, $nbrCatFriends, $nbrGroupsDone, $posPb1, $parsingDone, $nbrRetries) = @_;
  my $includeIcons = $winFriends->chFriendsProfileIcons->Checked();
  my $firstExec = 0;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpFriendsC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    $posPb1 = $winPb->pbWinPb1->GetPos();
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) {
      $nbrRetries++;
      # Progress window
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
    }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpFriends, $friendName, $saveDir, $refListCatFriends, $nbrCatFriends,
                             $nbrGroupsDone, $posPb1, $parsingDone, $nbrRetries);
    } else {
      Win32::GUI::MessageBox($winPb, $STR{'err2'}, $STR{'err1T'}, 0x40010);
    }
    # Kill this thread
    threads->exit();
  };
  
  # First execution, must gather friends category and url
  if (!$posPb1 and !$nbrCatFriends) {
    $firstExec = 1;
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpFriendsP'}.'...');
    for (my $i = 1; $i < $winFriends->GridFriends->GetRows(); $i++) {
      my $selStatus = $winFriends->GridFriends->GetCellCheck($i, 0);
      if ($selStatus == 1) {
        my $catName = decode($CONFIG{'CHARSET'}, $winFriends->GridFriends->GetCellText($i, 1));
        my $catid   = $winFriends->GridFriends->GetCellText($i, 2);
        my $catURL  = $winFriends->GridFriends->GetCellText($i, 3);
        $$refListCatFriends{$catName}{'id'}   = $catid;
        $$refListCatFriends{$catName}{'url'}  = $catURL;
        $$refListCatFriends{$catName}{'name'} = $catName;
      }
    }
    # Number of categories
    $nbrCatFriends = keys %{$refListCatFriends};
  } # else, resume after a crash

  if ($nbrCatFriends > 0) {
    my $count1;
    
    # First execution, turn on the progress window
    if ($firstExec == 1) {
      # Turn on progress bar
      $winPb->Center();
      $winPb->Show();
      $win->Disable();
      $winPb->pbWinPb1->SetRange(0, $nbrCatFriends);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      $winPb->lblPbCurr1->Text('');
      $winPb->lblCount1->Text('');
      $count1 = 0;
    # If on resume state, get number of friends cat left
    } else {
      my $nbrCurrCatFriends = keys %{$refListCatFriends};
      $count1 = $nbrCatFriends - $nbrCurrCatFriends;
    }
    
    # Parse each friend category page
    if (!$parsingDone) {
      # Make folders
      if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
      if (!-d "$saveDir\\images_$friendName" and $includeIcons) { mkdir("$saveDir\\images_$friendName"); }
      
      # Connect to current tab in Firefox
      my $mechFriends = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
      
      foreach my $cat (sort keys %{$refListCatFriends}) {
        my $encodedName = encode($CONFIG{'CHARSET'}, $$refListCatFriends{$cat}{'name'});
        # Check status for the current category ($$refListCatFriends{$cat}{'status'})
        # 1 : Opening
        # 2 : Scrolling done
        # 3 : Downloading done
        # 4 : Parsing done
        
        # Opening the Friends Category Tab
        if (!exists($$refListCatFriends{$cat}{'status'})) {
          $winPb->lblPbCurr1->Text("$STR{'opening'}: $encodedName");
          $winPb->lblCount1->Text("$count1/$nbrCatFriends");
          $winPb->lblPbCurr2->Text('');
          $winPb->lblCount2->Text('');
          $winPb->pbWinPb2->SetPos(0);
          &selectCatFriendPage(\$mechFriends, $cat);
          $$refListCatFriends{$cat}{'status'} = 1; # Opening done
        }
        
        # Scrolling the Friends Category Tab
        if ($$refListCatFriends{$cat}{'status'} < 2) {
          $winPb->lblPbCurr1->Text("$STR{'scrolling'}: $encodedName");
          sleep($CONFIG{'TIME_TO_WAIT'});
          &scrollFriendPage(\$mechFriends, $CONFIG{'TIME_TO_WAIT'});
          $$refListCatFriends{$cat}{'status'} = 2; # Scrolling done
        }
        
        # Downloading the Friends Category Tab
        if ($$refListCatFriends{$cat}{'status'} < 3) {
          $winPb->lblPbCurr1->Text("$STR{'downloading'}: $encodedName");
          my $htmlPage = "$saveDir\\temp\\page.html";
          my $status;
          if ($includeIcons) { $status = $mechFriends->save_content($htmlPage, "$saveDir\\temp"); }
          else               { $status = $mechFriends->save_content($htmlPage);                   }
          while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { usleep(100000); }
          $$refListCatFriends{$cat}{'status'} = 3; # Downloading done
        }
        
        # Parsing the Friends Category Tab
        my $nbrFriendsDone = keys %{$$refListCatFriends{$cat}{'profilOrder'}};
        if ($$refListCatFriends{$cat}{'status'} < 4) {
          $winPb->lblPbCurr1->Text("$STR{'parsing'}: $encodedName (per group of 20)");

          # Parse by section and groups
          my $section = $mechFriends->by_id($$refListCatFriends{$cat}{'id'}, any => 1);
          my @groups  = $mechFriends->selector('ul.uiList._262m._4kg', node => $section);
          my $nbrGroups = scalar(@groups);
          if (!$nbrGroups) {
            @groups  = $mechFriends->selector('ul.uiList.clearfix._5bbv._4kg._704._4ks', node => $section); # Followers category
            $nbrGroups = scalar(@groups);
          }
          
          # Progress bar
          $winPb->pbWinPb2->SetRange(0, $nbrGroups);
          $winPb->pbWinPb2->SetPos($nbrGroupsDone);
          $winPb->pbWinPb2->SetStep(1);
          $winPb->lblCount2->Text("$nbrGroupsDone/$nbrGroups");
          
          # Browse each group (20 friends per group)
          my $k = 0;
          my $i = $nbrGroupsDone*20;
          while (my $group = shift(@groups)) {
            if ($k >= $nbrGroupsDone) {
              my @friends;
              # Safe mode
              if ($winFriends->chFriendsSafeMode->Checked()) {
                @friends = split(/_698/, $group->{innerHTML});
                shift(@friends); # Remove first element
              # Faster mode, but less stable
              } else {
                @friends       = $mechFriends->selector('li._698', node => $group);
                my $nbrFriends = scalar(@friends);
                if (!$nbrFriends) {
                  @friends = $mechFriends->selector('li.fbProfileBrowserListItem', node => $group); # Followers category
                }
              }
              my $nbrFriends = scalar(@friends);
              
              # Progress 2
              while (my $friend = shift(@friends)) {
                if ($i >= $nbrFriendsDone) {
                  my $friendContent;
                  if ($winFriends->chFriendsSafeMode->Checked()) { $friendContent = $friend;              }
                  else                                           { $friendContent = $friend->{innerHTML}; }
                  my $url;
                  my $id;
                  my $img;
                  # Url and Img
                  if ($friendContent =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard\/user.php\?id=([^\&\"]+)(?:&|")[^\>]*>/) {
                    $url = $1;
                    $id  = $2;
                  }
                  # Img
                  if ($friendContent =~ /<img class="_s0 _r[wv] img" src="([^\"]+)" alt=""><\/a>/) {
                    $img = $1;
                  }
                  
                  # Minimum details required
                  if ($url and $id and $img) {
                    $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $id...");
                    
                    if ($includeIcons and $img =~ /\/([^\/\?]+)\?/) { # Include profile icons
                      my $imgFilename = $1; # Replace image name by profil id
                      rcopy("$saveDir\\temp\\$imgFilename", "$saveDir\\images_$friendName\\$id\.jpg"); # Copy image
                      $$refListCatFriends{$cat}{'profilImg'}{$id} = "images_$friendName\\$id\.jpg";
                    }
                    $$refListCatFriends{$cat}{'profilUrl'}{$id} = $url;
                    $$refListCatFriends{$cat}{'profilOrder'}{$nbrFriendsDone} = $id;
                    
                    # Gather profil name
                    my $url2 = quotemeta($url);
                    if ($friendContent =~ /<(?:div|span) class="fsl fwb fcb"><a href="$url2[^\>]+>([^\<]+)</) {
                      $$refListCatFriends{$cat}{'profilName'}{$id} = $1;
                    }
                    
                    # Gather details (if available)
                    if ($friendContent =~ /<span class="_50hf fsm fwn">(.+)<\/span><\/li>/) {
                      my $details = $1;
                      $details =~ s/<[^\>]+>//g;
                      $details = decode_entities($details);
                      $$refListCatFriends{$cat}{'profilDetails'}{$id} = $details;
                    }
                    $nbrFriendsDone++;
                  }
                  
                }
                $i++;
              }
              $winPb->pbWinPb2->StepIt();
              $nbrGroupsDone++;
              $winPb->lblCount2->Text("$k/$nbrGroups");
            }
            $k++;
          }
          $$refListCatFriends{$cat}{'status'} = 4; # Parsing done
          $winPb->pbWinPb1->StepIt();
          $winPb->lblCount1->Text("$count1/$nbrCatFriends");
        }
        $count1++;
        $nbrGroupsDone = 0;
        if ($count1 == $nbrCatFriends) { $parsingDone = 1; }
      }
    }
    
    # Parsing done, Save in a XLSX file
    $count1 = 0;
    $winPb->lblPbCurr1->Text($STR{'createXLSX'}.'...');
    $winPb->lblCount1->Text('');
    if ($nbrCatFriends) {
      # Progress 1
      $winPb->lblCount1->Text("$count1/$nbrCatFriends");
      $winPb->pbWinPb1->SetRange(0, $nbrCatFriends);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      
      my $filename = "$saveDir\\$friendName\.xlsx";
      my $excel    = Excel::Writer::XLSX->new($filename);    # Create the XLSX file
      # One sheet per category
      foreach my $cat (sort keys %{$refListCatFriends}) {
        &createExcelSheetWithDetails(\$excel, $$refListCatFriends{$cat}{'name'}, $$refListCatFriends{$cat}, $includeIcons, $saveDir);
        $count1++;
        $winPb->lblCount1->Text("$count1/$nbrCatFriends");
        $winPb->pbWinPb1->StepIt();
      }
      
      $excel->close(); # Close the file
      
      # Open the file
      if ($winFriends->chFriendsOpenXLSX->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
    }
    
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    
    # Delete temporary files
    if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }
  }

  $win->Tray->Change(-tip => $STR{'dumpFriendsF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'               ,
                        -balloon_title => 'ExtractFace'        ,
                        -balloon_tip   => $STR{'dumpFriendsF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpFriends

#--------------------------#
sub createExcelSheetWithDetails
#--------------------------#
{
  # Local variables
  my ($refExcel, $sheetName, $refData, $includeIcons, $saveDir) = @_;
  my $encodedName = encode($CONFIG{'CHARSET'}, $sheetName);
  
  $winPb->lblPbCurr1->Text("$STR{'createSheet'}: $encodedName");
  # Progress 2
  my $nbrItems = scalar(keys %{$$refData{'profilOrder'}});
  $winPb->lblPbCurr2->Text('');
  $winPb->lblCount2->Text('');
  $winPb->pbWinPb2->SetRange(0, $nbrItems);
  $winPb->pbWinPb2->SetPos(0);
  $winPb->pbWinPb2->SetStep(1);
  my $count2 = 0;
  
  my $sheet  = $$refExcel->add_worksheet($sheetName); # Add a sheet
  # Formats 
  my $format = $$refExcel->add_format();
  $format->set_bold();
  $format->set_align( 'center' );
  $format->set_align( 'vcenter' );
  my $format2 = $$refExcel->add_format();
  $format2->set_align( 'center' );
  $format2->set_align( 'vcenter' );
  my $format3 = $$refExcel->add_format();
  $format3->set_align( 'top' );
  my $j = 0; # Column no
  # Headers
  if ($includeIcons) { $sheet->write( 0, $j, $STR{'image'}     , $format ); $j++; }
  $sheet->write( 0, $j, $STR{'profilID'}  , $format ); $j++;
  $sheet->write( 0, $j, $STR{'url'}       , $format ); $j++;
  $sheet->write( 0, $j, $STR{'name'}      , $format ); $j++;
  $sheet->write( 0, $j, $STR{'details'}   , $format ); $j++;
  if ($includeIcons) { $sheet->write( 0, $j, $STR{'imgPath'}   , $format ); $j++; }
  $sheet->write( 0, $j, $STR{'originURL'} , $format );
  # Create content
  my $i = 1; # Row no
  my $maxWidthCol1 = 5;
  my $maxWidthCol2 = 0;
  my $maxWidthCol3 = 0;
  my $maxWidthCol4 = 0;
  my $maxWidthCol5 = 0;
  my $maxWidthCol6 = 0;
  my $maxWidthCol7 = length($$refData{'url'});
  foreach my $no (sort {$a <=> $b} keys %{$$refData{'profilOrder'}}) {
    $j = 0;
    my $id = $$refData{'profilOrder'}{$no};
    $winPb->lblPbCurr2->Text("$STR{'writing'}: $id");
    # Image column
    if ($includeIcons) {
      my $imgPath = "$saveDir\\$$refData{'profilImg'}{$id}";
      my $info = image_info($imgPath);
      if (!$info->{error}) { # Insert only if image is not corrupted
        $sheet->insert_image($i, $j, $imgPath); # Ignore if not a valid image
        if ($info->{height}) {
          my $colHeight = $info->{height} / 1.33;
          $sheet->set_row($i, $colHeight);
        }
        else { $sheet->set_row($i, 30); }
        if ($info->{width}) {
          my $colWidth = $info->{width} / 7.2;
          if ($colWidth > $maxWidthCol1) { $maxWidthCol1 = $colWidth; }
        }
      }
      $j++;
    }
    # Profil ID column
    $sheet->write_string($i, $j, $id);
    $sheet->set_column($j, 6, undef, $format3);
    if (length($id) > $maxWidthCol2) { $maxWidthCol2 = length($id); }
    $j++;
    # URL column
    $sheet->write($i, $j, $$refData{'profilUrl'}{$id});
    if (length($$refData{'profilUrl'}{$id}) > $maxWidthCol3) {
      $maxWidthCol3 = length($$refData{'profilUrl'}{$id});
    }
    $j++;
    # Name column
    if ($$refData{'profilName'}{$id}) {
      $sheet->write($i, $j, $$refData{'profilName'}{$id});
      if (length($$refData{'profilName'}{$id}) > $maxWidthCol4) {
        $maxWidthCol4 = length($$refData{'profilName'}{$id});
      }
    }
    $j++;
    # Profil Details column
    if ($$refData{'profilDetails'}{$id}) {
      $sheet->write($i, $j, $$refData{'profilDetails'}{$id});
      if (length($$refData{'profilDetails'}{$id}) > $maxWidthCol5) {
        $maxWidthCol5 = length($$refData{'profilDetails'}{$id});
      }
    }
    $j++;
    # Image Path column
    if ($includeIcons) {
      $sheet->write($i, $j, $$refData{'profilImg'}{$id});
      if (length($$refData{'profilImg'}{$id}) > $maxWidthCol6) {
        $maxWidthCol6 = length($$refData{'profilImg'}{$id});
      }
      $j++;
    }
    # Original URL column
    $sheet->write($i, $j, $$refData{'url'});
    
    # Ajust column sizes
    $j = 0;
    if ($includeIcons) { $sheet->set_column(0, 0, $maxWidthCol1, $format2); $j++; }
    $sheet->set_column($j, $j, $maxWidthCol2); $j++;
    $sheet->set_column($j, $j, $maxWidthCol3); $j++;
    $sheet->set_column($j, $j, $maxWidthCol4); $j++;
    $sheet->set_column($j, $j, $maxWidthCol5); $j++;
    if ($includeIcons) { $sheet->set_column($j, $j, $maxWidthCol6); $j++; }
    $sheet->set_column($j, $j, $maxWidthCol7);
    $i++;
  }

}  #--- End createExcelSheetWithDetails

#--------------------------#
sub winFriends_Terminate
#--------------------------#
{
  return(-1);

}  #--- End winFriends_Terminate

#--------------------------#
sub winEvent
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Reset window
    $winEvent->tfEventID->Text('');
    $winEvent->tfAuthorID->Text('');
    $winEvent->tfDataURL->Text('');
    $winEvent->chGoing->Text('Going');
    $winEvent->chMaybe->Text('Maybe');
    $winEvent->chInvited->Text('Invited');
    $winEvent->chDeclined->Text('Declined');
    $winEvent->chGoing->Checked(1);
    $winEvent->chMaybe->Checked(1);
    $winEvent->chInvited->Checked(1);
    $winEvent->chDeclined->Checked(1);
    
    # Start the thread
    $THR = threads->create(\&winEventThr);
    
    usleep(500000);
    $winEvent->Center();
    $winEvent->DoModal();
  }

}  #--- End winEvent

#--------------------------#
sub winEventThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();
  my $tempDir = "$USERDIR\\temp";
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winEventThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winEvent, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winEvent->btnEventOk->Disable();
      Win32::GUI::MessageBox($winEvent, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    my $currURL = $mech->uri();
    my $idEvent;
    if ($currURL =~ /https:\/\/www.facebook.com\/events\/(\d+)\/?/) { $idEvent = $1; }
    else {
      $winEvent->btnEventOk->Disable();
      Win32::GUI::MessageBox($winEvent, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    }

    $winEvent->ChangeCursor($HOURGLASS);
    $winEvent->lblInProgress->Text($STR{'gatherEvent'}.'...');
    
    # Gather event details
    my $eventDetailsURL = "https://www.facebook.com/events/ajax/guest_list/?acontext[ref]=51&acontext[source]=1&acontext[action_history]=[{%22surface%22%3A%22permalink%22%2C%22mechanism%22%3A%22surface%22%2C%22extra_data%22%3A[]}]&event_id=$idEvent&initial_tab=going&__pc=EXP1%3ADEFAULT&__asyncDialog=6&__a=1";
    if (!-d "$tempDir") { mkdir("$tempDir"); }
    my $localDataFile = "$tempDir\\data.txt";
    my $mechData = WWW::Mechanize::Firefox->new(create   => 1,
                                                autodie  => 0, );
    $mechData->get($eventDetailsURL, synchronize => 0);
    sleep($CONFIG{'TIME_TO_WAIT'});
    my $status = $mechData->save_content($localDataFile, $tempDir);
    while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }

    # Parse html page
    open(my $tmp, $localDataFile);
    my $file_as_string = do { local $/ = <$tmp> };
    $file_as_string =~ s/[\r\n]//g;
    # Event ID
    if ($file_as_string =~ /"eventID":"([^\"]+)"/ ) {
      $winEvent->tfEventID->Text($1);
      $winEvent->tfEventName->Text($1);
    }
    # Author ID
    if ($file_as_string =~ /"authorID":"([^\"]+)"/) { $winEvent->tfAuthorID->Text($1); }
    # URL of content
    if ($file_as_string =~ /"prefetchURI":"([^\"]+)"/) {
      my $dataURL = $1;
      $dataURL =~ s#\\\/#\/#g;
      $dataURL =~ s/&amp;/&/g;
      $dataURL =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $dataURL = "https://www.facebook.com" . $dataURL . "&__pc=EXP1%3ADEFAULT&__a=1&__req=a";
      $winEvent->tfDataURL->Text($dataURL);
    }
    # Guest list name
    my %glText;
    if ($file_as_string =~ /"typeaheadSubtitles":{([^\}]+)}/) {
      my $data = $1;
      my @lists = split(/,/, $data);
      foreach (@lists) {
        my ($lname, $ltext) = split(/:/, $_);
        $lname =~ s/"//g;
        $ltext =~ s/"//g;
        $glText{$lname} = $ltext;
      }
    }
    # Guest list members count
    my %glCount;
    if ($file_as_string =~ /"adminRSVPNuxCount":0,"counts":{([^\}]+)}/) {
      my $data = $1;
      my @lists = split(/,/, $data);
      foreach (@lists) {
        my ($lname, $lcount) = split(/:/, $_);
        $lname =~ s/"//g;
        $glCount{$lname} = $lcount;
      }
    }
    close($tmp);
    # Adjust Guest list checkbox text
    if ($glCount{'going'}    and $glText{'going'}   ) { $winEvent->chGoing->Text("$glText{'going'} [$glCount{'going'}]");          }
    if ($glCount{'maybe'}    and $glText{'maybe'}   ) { $winEvent->chMaybe->Text("$glText{'maybe'} [$glCount{'maybe'}]");          }
    if ($glCount{'invited'}  and $glText{'invited'} ) { $winEvent->chInvited->Text("$glText{'invited'} [$glCount{'invited'}]");    }
    if ($glCount{'declined'} and $glText{'declined'}) { $winEvent->chDeclined->Text("$glText{'declined'} [$glCount{'declined'}]"); }
    
    # Delete temporary files
    if ($winConfig->chDelTempFiles->Checked()) { remove_tree($tempDir); }
  } else { Win32::GUI::MessageBox($winEvent, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  $winEvent->lblInProgress->Text('');
  $winEvent->ChangeCursor($ARROW);
  
  # Ready ?
  &isDumpEventReady();

}  #--- End winEventThr

#--------------------------#
sub tfEventName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();

  # Remember the save dir
  if ($saveDir and -d $saveDir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'DIR_SAVE_EVENT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpEventReady();

}  #--- End tfEventName_Change

#--------------------------#
sub tfDirSaveEvent_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'DIR_SAVE_EVENT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpEventReady();

}  #--- End tfDirSaveEvent_Change

#--------------------------#
sub btnDirSaveEvent_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winEvent->tfDirSaveEvent->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winEvent      ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winEvent      ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winEvent->tfDirSaveEvent->Text($dir);
  }
  
}  #--- End btnDirSaveEvent_Click

#--------------------------#
sub chSaveEventDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winEvent->tfDirSaveEvent->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_EVENT'} = 1;
    $CONFIG{'DIR_SAVE_EVENT'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_EVENT'} = 0;
    delete($CONFIG{'DIR_SAVE_EVENT'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveEventDir_Click

#--------------------------#
sub chGoing_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chGoing_Click

#--------------------------#
sub chMaybe_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chMaybe_Click

#--------------------------#
sub chInvited_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chInvited_Click

#--------------------------#
sub chDeclined_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chDeclined_Click

#--------------------------#
sub isDumpEventReady
#--------------------------#
{
  # Local variables
  my $eventName = $winEvent->tfEventName->Text();
  my $saveDir   = $winEvent->tfDirSaveEvent->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$eventName) {
    $winEvent->btnEventOk->Disable();
    return(0);
  }
  
  # No selected lists
  if (!$winEvent->chGoing->Checked()   and !$winEvent->chMaybe->Checked()   and
      !$winEvent->chInvited->Checked() and !$winEvent->chDeclined->Checked()) {
    $winEvent->btnEventOk->Disable();
    return(0);
  }

  $winEvent->btnEventOk->Enable();

}  #--- End isDumpEventReady

#--------------------------#
sub chEventProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winEvent->chEventProfileIcons->Checked()) {
    $CONFIG{'EVENT_PROFILE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'EVENT_PROFILE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chEventProfileIcons_Click

#--------------------------#
sub chEventOpenXLSX_Click
#--------------------------#
{
  # Save the choice
  if ($winEvent->chEventOpenXLSX->Checked()) {
    $CONFIG{'FRIENDS_OPEN_XLSX'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'FRIENDS_OPEN_XLSX'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chEventOpenXLSX_Click

#--------------------------#
sub btnEventOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Local variables
    my $eventName = $winEvent->tfEventName->Text();
    $eventName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir   = $winEvent->tfDirSaveEvent->Text();
    my %lists;
    my $refLists   = \%lists;
    my $nbrRetries = 0;
    my $count      = 0;
    my $step       = 1;

    if ($eventName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpEvent, $eventName, $saveDir, $refLists, $nbrRetries, $count, $step);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnEventOk_Click

#--------------------------#
sub dumpEvent
#--------------------------#
{
  # Local variables
  my ($eventName, $saveDir, $refLists, $nbrRetries, $count, $step) = @_;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpEventC'});
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    &winPb2_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $winPb2->lblPbCurr->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpEvent, $eventName, $saveDir, $refLists, $nbrRetries, $count, $step);
    } else {
      $winPb2->lblPbCurr->Text($STR{'err2'});
      Win32::GUI::MessageBox($winPb2, $STR{'err2'}, $STR{'err1T'}, 0x40010);
    }
    # Kill this thread
    threads->exit();
  };

  # First execution
  if (!$count) {
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $win->Disable();
    
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpEventP'}.'...');
  }
  
  # Selected list
  my %selectedLists;
  if ($winEvent->chGoing->Checked()   ) { $selectedLists{'going'}    = 1; }
  if ($winEvent->chMaybe->Checked()   ) { $selectedLists{'maybe'}    = 1; }
  if ($winEvent->chInvited->Checked() ) { $selectedLists{'invited'}  = 1; }
  if ($winEvent->chDeclined->Checked()) { $selectedLists{'declined'} = 1; }
  
  # Connect to current tab
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($winPb2, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Target url
  my $currURL   = $mech->uri();
  my $targetURL = $winEvent->tfDataURL->Text();
  if ($step == 1) {
    if ($targetURL) {
      $winPb2->lblPbCurr->Text($STR{'dumpEventP'}.'...');
    
      # Download the data
      if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
      if (!-d "$saveDir\\images_$eventName") { mkdir("$saveDir\\images_$eventName"); }
      my $localDataFile = "$saveDir\\temp\\data.txt";
      if (my $mechData = WWW::Mechanize::Firefox->new(tab => qr{'www.facebook.com/events/ajax/guest_list'}, create => 1, autodie => 0, )) {
        $mechData->get($targetURL, synchronize => 0);
        sleep($CONFIG{'TIME_TO_WAIT'}+2);
        my $status = $mechData->save_content($localDataFile);
        while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
      }
      
      # Parse the data
      open(my $tmp, '<:encoding(UTF-8)', $localDataFile);
      my $data = do { local $/ = <$tmp> };
      close($tmp);
      $data =~ s/[\r\n]//g;
      my @tabData = split(/},/, $data);
      undef $data;
      my $nbrLines = scalar(@tabData);
      foreach my $line (@tabData) {
        my %memberData;
        if ($line =~ /{("uniqueID":[^\}]+)}/) {
          my @fields = split(/,/, $1);
          foreach my $field (@fields) {
            my ($key, $value) = split(/:[^\\]/, $field);
            $key   =~ s/"//g;
            $value =~ s/"//g;
            $memberData{$key} = $value;
          }
          
          # Save member data
          if ($memberData{'uniqueID'} and $memberData{'tab'} and
              exists($selectedLists{$memberData{'tab'}}) and
              !exists($$refLists{$memberData{'tab'}}{'profilUrl'}{$memberData{'uniqueID'}})) {
            # Url
            if (!exists($$refLists{$memberData{'tab'}}{'url'})) { $$refLists{$memberData{'tab'}}{'url'} = $currURL; }
            # Profil order
            $$refLists{$memberData{'tab'}}{'profilOrder'}{$count} = $memberData{'uniqueID'};
            # Profil URL
            if ($memberData{'uri'}) {
              $memberData{'uri'} =~ s#\\\/#\/#g;
              $$refLists{$memberData{'tab'}}{'profilUrl'}{$memberData{'uniqueID'}} = $memberData{'uri'};
            }
            # Profil Img
            if ($memberData{'photo'}) {
              $memberData{'photo'} =~ s#\\\/#\/#g;
              $memberData{'photo'} =~ s/&amp;/&/g;
              $$refLists{$memberData{'tab'}}{'profilImg'}{$memberData{'uniqueID'}} = $memberData{'photo'};
              # Download the image
              if ($winEvent->chEventProfileIcons->Checked()) {
                if (!-e("$saveDir\\images_$eventName\\$memberData{'uniqueID'}\.jpg")) {
                  $mech->save_url($memberData{'photo'}, "$saveDir\\images_$eventName\\$memberData{'uniqueID'}\.jpg");
                }
              }
            }
            # Profil Name
            if ($memberData{'title'}) {
              my $name = $memberData{'title'};
              $name =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
              $$refLists{$memberData{'tab'}}{'profilName'}{$memberData{'uniqueID'}} = $name;
            }
            $count++;
          }
        } else { $count++; }
        $winPb2->lblCount->Text("$count/$nbrLines");
      }
      $step = 2;
    } else {
      Win32::GUI::MessageBox($winPb2, $STR{'err6'}, $STR{'err1T'}, 0x40010);
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => $STR{'dumpEventC'});
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      &winPb2_Terminate;
      threads->exit();
    }
  }
  
  # Check profile icons
  if ($winEvent->chEventProfileIcons->Checked() and $step == 2) {
    $winPb2->lblPbCurr->Text($STR{'checkIcons'}.'...');
    my $count2 = 0;
    foreach my $guestList (keys %{$refLists}) {
      foreach my $id (keys %{$$refLists{$guestList}{'profilImg'}}) {
        $count2++;
        $winPb2->lblCount->Text($count2);
        my $imgPath = "$saveDir\\images_$eventName\\$id\.jpg";
        if (!-e $imgPath and $$refLists{$guestList}{'profilImg'}{$id}) { # Profile icon doesn't exist, try to download
          $mech->save_url($$refLists{$guestList}{'profilImg'}{$id}, "$saveDir\\images_$eventName\\$id\.jpg");
        }
        # Check again
        if (-e $imgPath) { # Profile icon exists, check infos
          my $info = image_info($imgPath);
          my $dim;
          if (!$info->{error}) { $dim = dim($info); } # No error, get dim
          if (($info->{error} or !$dim) and $$refLists{$guestList}{'profilImg'}{$id}) { # Error with the image or no dim, try to download again
            unlink("$saveDir\\images_$eventName\\$id\.jpg");
            $mech->save_url($$refLists{$guestList}{'profilImg'}{$id}, "$saveDir\\images_$eventName\\$id\.jpg");
            $info = image_info($imgPath);
          }
          # No error, replace profile icon URL by profile icon path
          if (!$info->{error}) {
            $dim = dim($info);
            if ($dim) { $$refLists{$guestList}{'profilImg'}{$id} = "images_$eventName\\$id\.jpg"; }
          }
        }
      }
    }
    $step = 3;
  }
  
  # Save in a XLSX file
  $winPb2->lblPbCurr->Text($STR{'createXLSX'}.'...');
  my $nbrMembers = $count;
  if ($nbrMembers) {
    my $filename = "$saveDir\\$eventName\.xlsx";
    my $excel    = Excel::Writer::XLSX->new($filename); # Create the XLSX file
    
    # A sheet for each guest list
    foreach my $guestList (sort keys %{$refLists}) {
      &createExcelSheetWithDetails(\$excel, $guestList, $$refLists{$guestList}, $winEvent->chEventProfileIcons->Checked(), $saveDir);
    }
    
    $excel->close(); # Close XLSX file
    
    # Open the file
    if ($winEvent->chEventOpenXLSX->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
  }

  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;
  
  # Delete temporary files
  #if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }

  $win->Tray->Change(-tip => $STR{'dumpEventF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpEventF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpEvent

#--------------------------#
sub winEvent_Terminate
#--------------------------#
{
  return(-1);

}  #--- End winEvent_Terminate

#--------------------------#
sub winContrib
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winContribThr);
    
    usleep(500000);
    $winContrib->Center($win);
    $winContrib->DoModal();
  }

}  #--- End winContrib

#--------------------------#
sub winContribThr
#--------------------------#
{
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winContribThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winContrib, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winContrib->btnContribOk->Disable();
      Win32::GUI::MessageBox($winContrib, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  my $currURL  = $mech->uri();
  if ($currURL =~ /facebook.com/) {
    my $title;
    if    ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $title = $1; }
    elsif ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $title = $1; }
    $winContrib->tfContribName->Text($title);
  } else {
    $winContrib->btnContribOk->Disable();
    Win32::GUI::MessageBox($winContrib, $STR{'warn4'}, $STR{'warn2T'}, 0x40010);
  }
  
  # Ready ?
  &isDumpContribReady();

}  #--- End winContribThr

#--------------------------#
sub tfContribName_Change
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End tfContribName_Change

#--------------------------#
sub tfDirSaveContrib_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winContrib->tfDirSaveContrib->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'DIR_SAVE_CONTRIB'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpContribReady();

}  #--- End tfDirSaveContrib_Change

#--------------------------#
sub btnDirSaveContrib_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winContrib->tfDirSaveContrib->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winContrib    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winContrib    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winContrib->tfDirSaveContrib->Text($dir);
  }
  
}  #--- End btnDirSaveContrib_Click

#--------------------------#
sub chSaveContribDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winContrib->tfDirSaveContrib->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CONTRIB'} = 1;
    $CONFIG{'DIR_SAVE_CONTRIB'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CONTRIB'} = 1;
    delete($CONFIG{'DIR_SAVE_CONTRIB'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveContribDir_Click

#--------------------------#
sub chContribProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winContrib->chContribProfileIcons->Checked()) {
    $CONFIG{'CONTRIB_PROFILE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'CONTRIB_PROFILE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chContribProfileIcons_Click

#--------------------------#
sub chContribOpenXLSX_Click
#--------------------------#
{
  # Save the choice
  if ($winContrib->chContribOpenXLSX->Checked()) {
    $CONFIG{'CONTRIB_OPEN_XLSX'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'CONTRIB_OPEN_XLSX'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chContribOpenXLSX_Click

#--------------------------#
sub chContribComments_Click
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribComments_Click

#--------------------------#
sub chContribLikes_Click
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribLikes_Click

#--------------------------#
sub chContribVPosts_Click
#--------------------------#
{
  if ($winContrib->chContribVPosts->Checked()) {
    $winContrib->chContribDontScrollVPosts->Enable();
  } else { $winContrib->chContribDontScrollVPosts->Disable(); }
  
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribVPosts_Click

#--------------------------#
sub isDumpContribReady
#--------------------------#
{
  # Local variables
  my $contribName = $winContrib->tfContribName->Text();
  my $saveDir     = $winContrib->tfDirSaveContrib->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$contribName) { $winContrib->btnContribOk->Disable(); return(0); }
  
  # At least one type checked
  if (!$winContrib->chContribComments->Checked() and
      !$winContrib->chContribLikes->Checked()    and
      !$winContrib->chContribVPosts->Checked()) {
    $winContrib->btnContribOk->Disable();
    return(0);
  }

  $winContrib->btnContribOk->Enable();

}  #--- End isDumpContribReady

#--------------------------#
sub btnContribOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Local variables
    my $contribName = $winContrib->tfContribName->Text();
    $contribName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir     = $winContrib->tfDirSaveContrib->Text();
    my %comments;
    my %likePages;
    my %likes;
    my %vPosts;
    my $refComments   = \%comments;
    my $refLikePages  = \%likePages;
    my $refLikes      = \%likes;
    my $refVPosts     = \%vPosts;
    my $nbrComments   = 0;
    my $nbrLikePages  = 0;
    my $nbrLikes      = 0;
    my $nbrVPosts     = 0;
    my $nbrRetries    = 0;
    my $step          = 1;
    my $done          = 0;

    if ($contribName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpContrib, $contribName, $saveDir, $refComments, $refLikePages,
                             $refLikes, $refVPosts, $nbrComments, $nbrLikePages, $nbrLikes, $nbrVPosts,
                             $nbrRetries, $step, $done);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnContribOk_Click

#--------------------------#
sub dumpContrib
#--------------------------#
{
  # Local variables
  my ($contribName, $saveDir, $refComments, $refLikePages, $refLikes, $refVPosts, $nbrComments,
      $nbrLikePages, $nbrLikes, $nbrVPosts, $nbrRetries, $step, $done) = @_;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpContribC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpContrib, $contribName, $saveDir, $refComments, $refLikePages,
                             $refLikes, $refVPosts, $nbrComments, $nbrLikePages, $nbrLikes, $nbrVPosts,
                             $nbrRetries, $step, $done);
    } else {
      $winPb->lblPbCurr1->Text($STR{'err2'});
      Win32::GUI::MessageBox($winPb2, $STR{'err2'}, $STR{'err1T'}, 0x40010);
    }
    # Kill this thread
    threads->exit();
  };
  
  # Connect to current tab
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($winPb2, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Operations
  # $step == 1 : Save the page
  # $step == 2 : Dump Contributors - Comments
  # $step == 3 : Dump Contributors - Likes
  # $step == 4 : Dump Contributors - VPosts
  # $step == 5 : Create Excel Sheet - Comments
  # $step == 6 : Create Excel Sheet - Likes
  # $step == 7 : Create Excel Sheet - VPosts
  
  my $currURL       = $mech->uri();
  my $nbrOperations = 1;
  if ($winContrib->chContribComments->Checked()) { $nbrOperations += 2; }
  if ($winContrib->chContribLikes->Checked()   ) { $nbrOperations += 2; }
  if ($winContrib->chContribVPosts->Checked()  ) { $nbrOperations += 2; }

  # First execution
  if ($step == 1) {
    # Turn on progress bar
    $winPb->Center();
    $winPb->Show();
    $win->Disable();
    $winPb->lblCount1->Text("0/$nbrOperations");
    $winPb->pbWinPb1->SetRange(0, $nbrOperations);
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb1->SetStep(1);
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpContribP'}.'...');
    
    # Create image folder
    if (!-d "$saveDir\\images_$contribName" and $winContrib->chContribProfileIcons->Checked()) {
      mkdir("$saveDir\\images_$contribName");
    }
    $step = 2;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  }

  # Gather Comment Contributors
  if ($winContrib->chContribComments->Checked() and $step == 2) {
    $winPb->lblPbCurr1->Text($STR{'dumpCommentsP'}.'...');
    
    # First execution
    if (!$nbrComments) {
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
    } else { $nbrComments--; } # If resume, start from last processed
    
    my @commentNodes = $mech->selector('a.UFIImageBlockImage');
    my $nbrCommentsToDo = scalar(@commentNodes);
    $winPb->pbWinPb2->SetRange(0, $nbrCommentsToDo);
    $winPb->pbWinPb2->SetStep(1);
    $winPb->lblCount2->Text("$nbrComments/$nbrCommentsToDo");
    my $i = 0;
    foreach my $commentNode (@commentNodes) {
      if ($i >= $nbrComments) {
        my $commentId;
        my $commentUrl;
        my $commentImg;
        my $commentName;
        if ($commentNode->{outerHTML} =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard.php\?id=([^\&\"]+)(?:&|")/) {
          $commentUrl  = $1;
          $commentId   = $2;
        }
        if ($commentNode->{innerHTML} =~ /src="([^\"]+)"/) { $commentImg  = $1; }
        if ($commentNode->{innerHTML} =~ /alt="([^\"]+)"/) { $commentName = $1; }
        
        if ($commentUrl and $commentId and $commentImg and $commentName and $commentName ne $contribName) {
          if ($currURL =~ /$commentId/) { } # On photo page, profile owner id
          else {
            $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $commentId...");
  
            # Already exists, count
            if (exists($$refComments{$commentUrl}{'Nbr'})) {
              $$refComments{$commentUrl}{'Nbr'}++;
            # Add a new entry
            } else {
              $$refComments{$commentUrl}{'Nbr'}  = 1;
              $$refComments{$commentUrl}{'Id'}   = $commentId;
              $$refComments{$commentUrl}{'Name'} = $commentName;
              
              # Include profile icon
              if ($winContrib->chContribProfileIcons->Checked() and $commentImg) {
                my $imgUrl = $commentImg =~ s/&amp;/&/gr;
                if (!-e("$saveDir\\images_$contribName\\$commentId\.jpg")) {
                  $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$commentId\.jpg");
                # File already exists, test if corrupted, if so, download it again
                } else {
                  my $info = image_info("$saveDir\\images_$contribName\\$commentId\.jpg");
                  if ($info->{error}) {
                    $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$commentId\.jpg");
                  }
                }
                $$refComments{$commentUrl}{'ImgPath'} = "images_$contribName\\$commentId\.jpg";
              }
            }
          }
        }
        $nbrComments++;
        $winPb->pbWinPb2->StepIt();
        $winPb->lblCount2->Text("$nbrComments/$nbrCommentsToDo");
      }
      $i++;
    }
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 3;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribComments->Checked()) { $step = 3; }
  
  # Gather Likes
  if ($winContrib->chContribLikes->Checked() and $step == 3) {
    $winPb->lblPbCurr1->Text($STR{'dumpLikesP'}.'...');
   
    # First execution, gather like page urls
    if (!$nbrLikePages and !$nbrLikes) {
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
      
      # Normal Likes
      my @likePages = $mech->selector('a._27jf._3emk');
      foreach my $likePage (@likePages) {
        my $url = $likePage->{href};
        $$refLikePages{$url} = 0; # To store number of likes per page
      }
      # Likes on Comments
      my @likePages2 = $mech->selector('a.UFICommentLikeButton');
      foreach my $likePage (@likePages2) {
        my $url = $likePage->{href};
        $$refLikePages{$url} = 0; # To store number of likes per page
      }
      
      # Set progress bar
      $nbrLikePages = scalar(keys %{$refLikePages});
      $winPb->pbWinPb2->SetRange(0, $nbrLikePages);
      $winPb->pbWinPb2->SetPos(0);
      $winPb->pbWinPb2->SetStep(1);
      $winPb->lblCount2->Text("0/$nbrLikePages");
    }
    
    if ($nbrLikePages > 0) {
      # Connect to Firefox (creates a new tab at first execution)
      my $mechLikePage = WWW::Mechanize::Firefox->new(tab => qr{Facebook}, create => 1, autodie => 0);
      
      foreach my $likePageUrl (sort keys %{$refLikePages}) {
        # Get the page, scroll to bottom then save the page content
        $winPb->lblPbCurr2->Text("$STR{'opening'} $likePageUrl...");
        $mechLikePage->get($likePageUrl, synchronize => 0);
        sleep($CONFIG{'TIME_TO_WAIT'});
        $winPb->lblPbCurr2->Text("$STR{'scrolling'} $likePageUrl...");
        &scrollLikePage(\$mechLikePage, $CONFIG{'TIME_TO_WAIT'});
        if ($winContrib->chContribProfileIcons->Checked()) {
          $winPb->lblPbCurr2->Text("$STR{'downloading'} $likePageUrl...");
          my $htmlPage = "$saveDir\\temp\\likePage.html";
          my $status = $mechLikePage->save_content($htmlPage, "$saveDir\\temp");
          while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { usleep(100000); }
        }
        
        my $i = 0;
        # Gather each profile details
        $winPb->lblPbCurr2->Text("$STR{'parsing'} $likePageUrl...");
        my @likeProfiles  = $mechLikePage->selector('li._5i_q');
        my @likeProfiles2 = $mechLikePage->selector('li.fbProfileBrowserListItem');
        push(@likeProfiles, @likeProfiles2);
        
        foreach my $likeProfile (@likeProfiles) {
          my $likeProfileCode = $likeProfile->{outerHTML};
          if ($i >= $$refLikePages{$likePageUrl}) {
            my $likeId;
            my $likeUrl;
            my $likeImg;
            my $likeName;
            
            # Gather url and id
            if ($likeProfileCode =~ /<(a[^\>]+)\>\<([^\<]+)\</) {
              my $profileTag = $1;
              my $imgTag     = $2;
              if ($profileTag =~ /href="([^\&\"]+)(?:&|")[^\>]+data-hovercard="([^\"]+)\"/) {
                $likeUrl = $1;
                my $temp = $2;
                if ($temp =~ /hovercard\/user\.php\?id=([^\&]+)&/) { $likeId = $1; }
              }
            }
            # Gather Image link
            if ($likeProfileCode =~ / src="([^\"]+)\"/) { $likeImg = $1; }
            # Gather name
            if ($likeProfileCode =~ /\<a[^\>]+\>([^\<]+)\</) { $likeName = $1; }
            
            if ($likeUrl and $likeId and $likeImg and $likeName and $likeName ne $contribName) {
              if ($currURL =~ /$likeId/) { } # On photo page, profile owner id
              else {
                # Already exists, count
                if (exists($$refLikes{$likeUrl}{'Nbr'})) {
                  $$refLikes{$likeUrl}{'Nbr'}++;
                # Add a new entry
                } else {
                  $nbrLikes++;
                  $$refLikes{$likeUrl}{'Nbr'}  = 1;
                  $$refLikes{$likeUrl}{'Id'}   = $likeId;
                  $$refLikes{$likeUrl}{'Name'} = $likeName;
                  
                  # Save the profil icon
                  if ($winContrib->chContribProfileIcons->Checked() and $likeImg =~ /\/([^\/\?]+)\?/) { # Include profile icons
                    my $imgFilename = $1; # Replace image name by profil id
                    if (!-e "$saveDir\\images_$contribName\\$likeId\.jpg") {
                      rcopy("$saveDir\\temp\\$imgFilename", "$saveDir\\images_$contribName\\$likeId\.jpg"); # Copy image
                    }
                    $$refLikes{$likeUrl}{'ImgPath'} = "images_$contribName\\$likeId\.jpg";
                  }
                }
              }
              $$refLikePages{$likePageUrl}++;
            }
          }
          $i++;
        }
        delete($$refLikePages{$likePageUrl});
        $winPb->pbWinPb2->StepIt();
        my $nbrLikePagesDone = $nbrLikePages - scalar(keys %{$refLikePages});
        $winPb->lblCount2->Text("$nbrLikePagesDone/$nbrLikePages");
      }
    }
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 4;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribLikes->Checked()) { $step = 4; }
  
  # Gather VPosts (Visitor Posts)
  if ($winContrib->chContribVPosts->Checked() and $step == 4) {
    $winPb->lblPbCurr1->Text($STR{'dumpVPostsP'}.'...');
    # Open the Visitor Posts popup if not already open
    my $vPostsHeader = $mech->selector('div._2h4b._50f3', any => 1);
    if (!$vPostsHeader) {
      my @vPostsUrl = $mech->selector('a._g3j');
      foreach (@vPostsUrl) {
        if ($_->{href} =~ /posts_to_page/) { $_->click(); }
      }
      sleep($CONFIG{'TIME_TO_WAIT'});
    }
    
    # First execution
    if (!$nbrVPosts) {
      if (!$winContrib->chContribDontScrollVPosts->Checked()) {
        # Display all Visitor Posts
        $winPb->lblPbCurr1->Text("$STR{'scrolling'} $STR{'chContribVPosts'}...");
        &scrollVPostsPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
      }
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
    } else { $nbrVPosts--; } # If resume, start from last processed

    # Gather all posters    
    my @vPostsCode = $mech->selector('div._5x46');
    my $nbrVPostsToDo = scalar(@vPostsCode);
    $winPb->pbWinPb2->SetRange(0, $nbrVPostsToDo);
    $winPb->pbWinPb2->SetStep(1);
    $winPb->lblCount2->Text("$nbrVPosts/$nbrVPostsToDo");
    my $i = 0;
    foreach my $vPostCode (@vPostsCode) {
      if ($i >= $nbrVPosts) {
        my $vPostsId;
        my $vPostsUrl;
        my $vPostsImg;
        my $vPostsName;
        if ($vPostCode->{outerHTML} =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard\/user\.php\?id=([^\&\"]+)(?:&|")[^\>]+\>([^\<]+)\</) {
          $vPostsUrl  = $1;
          $vPostsId   = $2;
          $vPostsName = $3;
        }
        if ($vPostCode->{innerHTML} =~ /src="([^\"]+)"/) { $vPostsImg = $1; }
        
        if ($vPostsUrl and $vPostsId and $vPostsImg and $vPostsName and $vPostsName ne $contribName) {
          $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $vPostsId...");

          # Already exists, count
          if (exists($$refVPosts{$vPostsUrl}{'Nbr'})) {
            $$refVPosts{$vPostsUrl}{'Nbr'}++;
          # Add a new entry
          } else {
            $$refVPosts{$vPostsUrl}{'Nbr'}  = 1;
            $$refVPosts{$vPostsUrl}{'Id'}   = $vPostsId;
            $$refVPosts{$vPostsUrl}{'Name'} = $vPostsName;
            
            # Include profile icon
            if ($winContrib->chContribProfileIcons->Checked() and $vPostsImg) {
              my $imgUrl = $vPostsImg =~ s/&amp;/&/gr;
              if (!-e("$saveDir\\images_$contribName\\$vPostsId\.jpg")) {
                $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$vPostsId\.jpg");
              # File already exists, test if corrupted, if so, download it again
              } else {
                my $info = image_info("$saveDir\\images_$contribName\\$vPostsId\.jpg");
                if ($info->{error}) {
                  $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$vPostsId\.jpg");
                }
              }
              $$refVPosts{$vPostsUrl}{'ImgPath'} = "images_$contribName\\$vPostsId\.jpg";
            }
          }
        }
        $nbrVPosts++;
        $winPb->pbWinPb2->StepIt();
        $winPb->lblCount2->Text("$nbrVPosts/$nbrVPostsToDo");
      }
      $i++;
    }
    
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 5;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribVPosts->Checked()) { $step = 5; }

  
  # Save in a XLSX file
  $winPb->lblPbCurr1->Text($STR{'createXLSX'}.'...');
  if ($nbrComments or $nbrLikes or $nbrVPosts) {
    my $filename = "$saveDir\\$contribName - $STR{'contributors'}\.xlsx";
    my $excel    = Excel::Writer::XLSX->new($filename); # Create the XLSX file

    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    
    # A sheet for each types
    # Comments
    if ($winContrib->chContribComments->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribComments'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribComments'}, $currURL, $refComments, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 5) {
        $step = 6;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribComments->Checked()) { $step = 6; }
    
    # Likes
    if ($winContrib->chContribLikes->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribLikes'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribLikes'}, $currURL, $refLikes, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 6) {
        $step = 7;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribLikes->Checked()) { $step = 7; }
    
    # VPosts
    if ($winContrib->chContribVPosts->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribVPosts'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribVPosts'}, $currURL, $refVPosts, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 7) {
        $step = 8;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribVPosts->Checked()) { $step = 8; }
    
    $excel->close(); # Close XLSX file
    
    # Open the file
    if ($winContrib->chContribOpenXLSX->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
  }

  # Turn off progress bar
  $winPb->lblPbCurr1->Text('');
  $winPb->lblCount1->Text('');
  $winPb->lblPbCurr2->Text('');
  $winPb->lblCount2->Text('');
  $winPb->pbWinPb1->SetPos(0);
  $winPb->pbWinPb2->SetPos(0);
  &winPb_Terminate;
  
  # Delete temporary files
  if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }

  $win->Tray->Change(-tip => $STR{'dumpContribF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpContribF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpContrib

#--------------------------#
sub createExcelSheet
#--------------------------#
{
  # Local variables
  my ($refExcel, $sheetName, $currURL, $refData, $includeIcon, $saveDir) = @_;
  
  # Create the sheet
  my $sheet = $$refExcel->add_worksheet($sheetName); # Add a sheet
  # Formats
  my $format = $$refExcel->add_format();
  $format->set_bold();
  $format->set_align( 'center' );
  $format->set_align( 'vcenter' );
  my $format2 = $$refExcel->add_format();
  $format2->set_align( 'center' );
  $format2->set_align( 'vcenter' );
  my $format3 = $$refExcel->add_format();
  $format3->set_align( 'top' );
  # Headers
  $sheet->write( 0, 0, $STR{'image'}    , $format );
  $sheet->write( 0, 1, $STR{'profilID'} , $format );
  $sheet->write( 0, 2, $STR{'url'}      , $format );
  $sheet->write( 0, 3, $STR{'name'}     , $format );
  $sheet->write( 0, 4, $STR{'imgPath2'} , $format );
  $sheet->write( 0, 5, $STR{'originURL'}, $format );
  $sheet->write( 0, 6, $STR{'count'}    , $format );
  # Create content
  my $i = 1;
  my $maxWidthCol1 = 5;
  my $maxWidthCol2 = 0;
  my $maxWidthCol3 = 0;
  my $maxWidthCol4 = 0;
  my $maxWidthCol5 = 0;
  my $maxWidthCol6 = length($currURL);
  my $maxWidthCol7 = length($STR{'count'});
  foreach my $entry (keys %{$refData}) {
    # Image column
    if ($includeIcon and -e "$saveDir\\$$refData{$entry}{'ImgPath'}") {
      my $info = image_info("$saveDir\\$$refData{$entry}{'ImgPath'}");
      if (!$info->{error}) { # Insert only if image is not corrupted
        $sheet->insert_image($i, 0, "$saveDir\\$$refData{$entry}{'ImgPath'}");
        if ($info->{height}) { # Set row height
          my $colHeight = $info->{height} / 1.33;
          $sheet->set_row($i, $colHeight);
        }
        else { $sheet->set_row($i, 30); }
        if ($info->{width}) { # Set row width
          my $colWidth = $info->{width} / 7.2;
          if ($colWidth > $maxWidthCol1) { $maxWidthCol1 = $colWidth; }
        }
      }
    }
    # Profil ID column
    $sheet->write_string($i, 1, $$refData{$entry}{'Id'});
    if (length($$refData{$entry}{'Id'}) > $maxWidthCol2) {
      $maxWidthCol2 = length($$refData{$entry}{'Id'});
    }
    # URL column
    $sheet->write($i, 2, $entry);
    if (length($entry) > $maxWidthCol3) { $maxWidthCol3 = length($entry); }
    # Name column
    if ($$refData{$entry}{'Name'}) {
      $sheet->write($i, 3, $$refData{$entry}{'Name'});
      if (length($$refData{$entry}{'Name'}) > $maxWidthCol4) {
        $maxWidthCol4 = length($$refData{$entry}{'Name'});
      }
    }
    # Image Path column
    $sheet->write($i, 4, $$refData{$entry}{'ImgPath'});
    if (length($$refData{$entry}{'ImgPath'}) > $maxWidthCol5) {
      $maxWidthCol5 = length($$refData{$entry}{'ImgPath'});
    }
    # Original URL column
    $sheet->write($i, 5, $currURL);
    # Count
    $sheet->write($i, 6, $$refData{$entry}{'Nbr'});
    $i++;
  }
  # Ajust column size
  $sheet->set_column(1, 6, undef, $format3);
  $sheet->set_column(0, 0, $maxWidthCol1, $format2);
  $sheet->set_column(1, 1, $maxWidthCol2);
  $sheet->set_column(2, 2, $maxWidthCol3);
  $sheet->set_column(3, 3, $maxWidthCol4);
  $sheet->set_column(4, 4, $maxWidthCol5);
  $sheet->set_column(5, 5, $maxWidthCol6);
  $sheet->set_column(6, 6, $maxWidthCol7);

}  #--- End createExcelSheet


#--------------------------#
sub scrollChat
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&scrollChatThr, $nbrRetries, $count);
  }
}  #--- End scrollChat

#--------------------------#
sub scrollChatThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChatC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollChatThr, $nbrRetries, $count);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChatP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChatP'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
        my $firstDisplayedDate = ($mech->selector('abbr._35.timestamp'))[0];
        if ($firstDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
          my $date = $1;
          my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($date);
          my $dateOnly = timelocal(0,0,0,$d,$m,$y+1900);
          if ($dateOnly <= $maxDate) { last; }
        }
      } elsif ($maxScrollChat and $count >= $maxScrollChat) { last; } # Stop by page
      
      my $loadOlderCode = $mech->selector('div._3hg', one => 1);
      if ($loadOlderCode->{outerHTML} =~ /hidden_elem/) { last; }
      else {
        my $left;
        if ($loadOlderCode->{innerHTML} =~ /$_ \(<span>(\d+)<\/span>\)/) { $left = $1; }
        if ($left) {
          $winPb2->lblCount->Text($left);
          $count++;
        }
        my $loadOlderLink = $mech->selector('a', any => 1, node => $loadOlderCode);
        if ($loadOlderLink) { $loadOlderLink->click(); }
        else { last; }
      }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChatF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollChatF'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End scrollChatThr

#--------------------------#
sub loadNewMsg
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&loadNewMsgThr, $nbrRetries, $count);
  }
}  #--- End loadNewMsg

#--------------------------#
sub loadNewMsgThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChat2C'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&loadNewMsgThr, $nbrRetries, $count);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChat2P'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChat2P'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
        my $lastDisplayedDate = ($mech->selector('abbr._35.timestamp'))[-1];
        if ($lastDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
          my $date = $1;
          my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($date);
          my $dateOnly = timelocal(0,0,0,$d,$m,$y+1900);
          if ($dateOnly >= $maxDate) { last; }
        }
      } elsif ($maxScrollChat and $count >= $maxScrollChat) { last; } # Stop by page
      
      my $loadNewerCode = $mech->selector('div._3hh', one => 1);
      if ($loadNewerCode->{outerHTML} =~ /hidden_elem/) { last; }
      else {
        my $loadNewerLink = $mech->selector('a', any => 1, node => $loadNewerCode);
        if ($loadNewerLink) {
          $loadNewerLink->click();
          sleep($CONFIG{'TIME_TO_WAIT'});
        }
        else { last; }
      }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChat2F'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'               ,
                          -balloon_title => 'ExtractFace'        ,
                          -balloon_tip   => $STR{'scrollChat2F'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End loadNewMsgThr

#--------------------------#
sub loadOldMsg
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&loadOldMsgThr, $nbrRetries, $count);
  }
}  #--- End loadOldMsg

#--------------------------#
sub loadOldMsgThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChat3C'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&loadOldMsgThr, $nbrRetries, $count);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChat3P'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChat3P'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
        my $section = ($mech->selector('ul.uiList._2ne._4kg'))[1];
        my $firstDisplayedDate = ($mech->selector('abbr._35.timestamp', node => $section))[0];
        if ($firstDisplayedDate->{outerHTML} =~ /data-utime="([^\"\.]+)/) {
          my $date = $1;
          my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($date);
          my $dateOnly = timelocal(0,0,0,$d,$m,$y+1900);
          if ($dateOnly <= $maxDate) { last; }
        }
      } elsif ($maxScrollChat and $count >= $maxScrollChat) { last; } # Stop by page
      
      my $loadOlderCode = ($mech->selector('div._3hg'))[1];
      if ($loadOlderCode->{outerHTML} =~ /hidden_elem/) { last; }
      else {
        my $loadOlderLink = $mech->selector('a', any => 1, node => $loadOlderCode);
        if ($loadOlderLink) {
          $loadOlderLink->click();
          sleep($CONFIG{'TIME_TO_WAIT'});
        }
        else { last; }
      }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChat3F'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'               ,
                          -balloon_title => 'ExtractFace'        ,
                          -balloon_tip   => $STR{'scrollChat3F'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End loadOldMsgThr

#--------------------------#
sub winChat
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winChatThr);
    
    usleep(500000);
    $winChat->Center($win);
    $winChat->DoModal();
  }

}  #--- End winChat

#--------------------------#
sub winChatThr
#--------------------------#
{
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winAlbumsThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winChat, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winChat->btnChatOk->Disable();
      Win32::GUI::MessageBox($winChat, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  if ($mech->uri() =~ /facebook.com/) {
    my $currURL  = $mech->uri();
    if ($currURL =~ /https:\/\/www.facebook.com\/messages\/search\/([^\/\?]+)\/?/ or
        $currURL =~ /https:\/\/www.facebook.com\/messages\/([^\/]+)\/?/) {
      my $title = $1;
      $title =~ s/[\#\<\>\:\"\/\\\|\?\*]/_/g;
      $winChat->tfChatName->Text("$title - $STR{'chat'}");
      
      # Searched part only ?
      if (my $headerSearchCode = $mech->selector('div._2z9 div.mlm._2zc.fsm.fwn.fcg', any => 1)) {
        if ($headerSearchCode->{innerHTML} and $headerSearchCode->{outerHTML} !~ /hidden_elem/) {
          $winChat->chSearched->Checked(1);
        } else { $winChat->chSearched->Checked(0); }
      } else { $winChat->chSearched->Checked(0); }
    } else {
      $winChat->btnChatOk->Disable();
      Win32::GUI::MessageBox($winChat, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    }
  } else { Win32::GUI::MessageBox($winChat, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Ready ?
  &isDumpChatReady();

}  #--- End winChatThr

#--------------------------#
sub tfChatName_Change
#--------------------------#
{
  # Ready ?
  &isDumpChatReady();

}  #--- End tfChatName_Change

#--------------------------#
sub tfDirSaveChat_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winChat->tfDirSaveChat->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winChat->chSaveChatDir->Checked()) {
    $CONFIG{'DIR_SAVE_CHAT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpChatReady();

}  #--- End tfDirSaveChat_Change

#--------------------------#
sub btnDirSaveChat_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winChat->tfDirSaveChat->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winChat       ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winChat       ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winChat->tfDirSaveChat->Text($dir);
  }
  
}  #--- End btnDirSaveChat_Click

#--------------------------#
sub chSaveChatDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winChat->tfDirSaveChat->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winChat->chSaveChatDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CHAT'} = 1;
    $CONFIG{'DIR_SAVE_CHAT'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winChat->chSaveChatDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CHAT'} = 1;
    delete($CONFIG{'DIR_SAVE_CHAT'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveChatDir_Click

#--------------------------#
sub rbChatNormalMode_Click
#--------------------------#
{
  $winChat->chDownloadImg->Enable();
  $winChat->chDownloadVid->Enable();
  $winChat->chDownloadVM->Enable();
  $winChat->chDownloadAD->Enable();

}  #--- End rbChatNormalMode_Click

#--------------------------#
sub rbChatSafeMode_Click
#--------------------------#
{
  $winChat->chDownloadImg->Checked(0);
  $winChat->chDownloadImgFull->Checked(0);
  $winChat->chDownloadVid->Checked(0);
  $winChat->chDownloadVM->Checked(0);
  $winChat->chDownloadAD->Checked(0);
  $winChat->chDownloadImg->Disable();
  $winChat->chDownloadImgFull->Disable();
  $winChat->chDownloadVid->Disable();
  $winChat->chDownloadVM->Disable();
  $winChat->chDownloadAD->Disable();

}  #--- End rbChatSafeMode_Click

#--------------------------#
sub chDownloadImg_Click
#--------------------------#
{
  if ($winChat->chDownloadImg->Checked()) {
    $winChat->chDownloadImgFull->Enable();
  } else {
    $winChat->chDownloadImgFull->Checked(0);
    $winChat->chDownloadImgFull->Disable();
  }

}  #--- End chDownloadImg_Click

#--------------------------#
sub chDownloadAD_Click
#--------------------------#
{
  if ($winChat->chDownloadAD->Checked()) {
    $winChat->chDownloadImg->Enable();
  } else {
    $winChat->chDownloadImg->Checked(0);
    $winChat->chDownloadImg->Disable();
  }

}  #--- End chDownloadAD_Click

#--------------------------#
sub dtChatDatesRangeS_Change
#--------------------------#
{
  $winChat->rbChatDatesAll->Checked(0);
  $winChat->rbChatDatesRange->Checked(1);

}  #--- End dtChatDatesRangeS_Change

#--------------------------#
sub dtChatDatesRangeE_Change
#--------------------------#
{
  $winChat->rbChatDatesAll->Checked(0);
  $winChat->rbChatDatesRange->Checked(1);

}  #--- End dtChatDatesRangeE_Change

#--------------------------#
sub isDumpChatReady
#--------------------------#
{
  # Local variables
  my $chatName = $winChat->tfChatName->Text();
  my $saveDir  = $winChat->tfDirSaveChat->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$chatName) { $winChat->btnChatOk->Disable(); return(0); }

  $winChat->btnChatOk->Enable();

}  #--- End isDumpChatReady

#--------------------------#
sub btnChatOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Local variables
    my $chatName = $winChat->tfChatName->Text();
    my $saveDir  = $winChat->tfDirSaveChat->Text();
    $chatName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $interlocutor;
    my $startText;
    my %msgProfileImg;
    my %msgProfileUrl;
    my %msgProfileName;
    my %msgIsText;
    my %msgText;
    my %msgVM;
    my $refMsgProfileImg  = \%msgProfileImg;
    my $refMsgProfileUrl  = \%msgProfileUrl;
    my $refMsgProfileName = \%msgProfileName;
    my $refMsgIsText      = \%msgIsText;
    my $refMsgText        = \%msgText;
    my $refMsgVM          = \%msgVM;
    my $nbrRetries        = 0;
    my $count             = 0;
    my $step              = 1;
    my $downloadVMStep    = 0;
    my $countVM           = 0;
    my $currentPage;
    my $mobilePage;

    if ($chatName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpChat, $chatName, $interlocutor, $saveDir, $refMsgProfileImg,
                             $refMsgProfileUrl, $refMsgProfileName, $refMsgIsText, $refMsgText,
                             $refMsgVM, $startText, $nbrRetries, $count, $step, $downloadVMStep,
                             $currentPage, $mobilePage, $countVM);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnChatOk_Click

#--------------------------#
sub dumpChat
#--------------------------#
{
  # Local variables
  my ($chatName, $interlocutor, $saveDir, $refMsgProfileImg, $refMsgProfileUrl, $refMsgProfileName,
      $refMsgIsText, $refMsgText, $refMsgVM, $startText, $nbrRetries, $count, $step, $downloadVMStep,
      $currentPage, $mobilePage, $countVM) = @_;
  my $imgDir        = "$saveDir\\images_$chatName";
  my $vidDir        = "$saveDir\\videos_$chatName";
  my $vmDir         = "$saveDir\\vm_$chatName";
  my $tmpDir        = "$saveDir\\temp";
  my $htmlPage      = "$tmpDir\\page.html";
  my $safeMode      = $winChat->rbChatSafeMode->Checked();
  my $haveEmoticon  = 0;
  my $emoticonDL    = 0;
  my $cssSprite     = 0;
  my $spriteDL      = 0;
  my %emoticons;
  my @stickers16;
  
  # Dates
  my $dateS;
  my $dateE;
  if ($winChat->rbChatDatesRange->Checked()) {
    my ($d1, $m1, $y1) = $winChat->dtChatDatesRangeS->GetDate();
    $dateS             = timelocal(0,0,0,$d1,$m1-1,$y1);   # Store in Unixtime format
    my ($d2, $m2, $y2) = $winChat->dtChatDatesRangeE->GetDate();
    $dateE             = timelocal(0,0,0,$d2+1,$m2-1,$y2); # Store in Unixtime format
  }  

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpChatC'});
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    &winPb2_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $winPb2->lblPbCurr->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpChat, $chatName, $interlocutor, $saveDir, $refMsgProfileImg,
                             $refMsgProfileUrl, $refMsgProfileName, $refMsgIsText, $refMsgText,
                             $refMsgVM, $startText, $nbrRetries, $count, $step, $downloadVMStep,
                             $currentPage, $mobilePage, $countVM);
    } else {
      $winPb2->lblPbCurr->Text($STR{'err2'});
      Win32::GUI::MessageBox($winPb2, $STR{'err2'}, $STR{'err1T'}, 0x40010);
    }
    # Kill this thread
    threads->exit();
  };

  # First execution
  if (!$count) {
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show();
    $win->Disable();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpChatP'}.'...');
  } else { $count--; }
  
  # Connect to current tab
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($winPb2, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
   
  $winPb2->lblPbCurr->Text($STR{'dumpChatP'}.'...');

  # Create folders and save the page
  my $origURL = $mech->uri;
  my $profilID; if ($origURL =~ /messages\/(?:search\/)?([^?#]+)\#?/) { $profilID = $1; } # $profilID is the profil ID of the interlocutor
  if ($step == 1) {
    if (!-d $tmpDir) { mkdir($tmpDir); }
    if (!-d $imgDir) { mkdir($imgDir); }
    my $status;
    # Safe mode, we save only html
    if ($safeMode) {
      $status = $mech->save_content($htmlPage);
      sleep($CONFIG{'TIME_TO_WAIT'});
    # Normal mode, we save html and all documents
    } else {
      $status = $mech->save_content($htmlPage, $tmpDir);
      while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
    }
    
    $step = 2; # Page have been saved
  }
  
  # Parse html page
  if ($step == 2) {
    my $i = 0;
    
    # Header name
    my $headerNameCode = $mech->selector('h2._r7', one => 1);
     
    # Parse each part
    my @parts;
    my $lastPartTxt;
    
    # Safe mode, we load content from file
    if ($safeMode) {
      if (open(my $fhTemp, "<:encoding(UTF-8)", $htmlPage)) {
        my $file_as_string = do { local $/ = <$fhTemp> };
        $file_as_string =~ s/[\r\n]//g;
        if ($winChat->chSearched->Checked()) {
          my $section = (split(/_2ne/, $file_as_string))[2];
          undef($file_as_string);
          @parts = split(/webMessengerMessageGroup/, $section);
        } else {
          my $section = (split(/_2ne/, $file_as_string))[1];
          undef($file_as_string);
          @parts     = split(/_8_/, $section);
          my @parts2 = split(/webMessengerMessageGroup/, $section);
          push(@parts, @parts2);
          my $lastPart = ($mech->selector('div.uiScrollableAreaContent div.mbs'))[1];
          if ($lastPart) { $lastPartTxt = $lastPart->{innerHTML}; }
        }
        close($fhTemp);
      }
    # Normal mode, we parse content with Firefox
    } else {
      if ($winChat->chSearched->Checked()) {
        my $section = ($mech->selector('ul.uiList._2ne._4kg'))[1];
        @parts = $mech->selector('li.webMessengerMessageGroup', node => $section);
      } else {
        my $section  = ($mech->selector('ul.uiList._2ne._4kg'))[0];
        push(@parts, $mech->selector('li._8_', node => $section));
        push(@parts, $mech->selector('li.webMessengerMessageGroup', node => $section));
        my $lastPart = ($mech->selector('div.uiScrollableAreaContent div.mbs'))[1];
        if ($lastPart) { $lastPartTxt = $lastPart->{innerHTML}; }
      }
    }
    
    my $nbrParts = scalar(@parts);
    foreach my $partCode (@parts) {
      if ($i >= $count) {
        $winPb2->lblCount->Text("$count/$nbrParts");
        my $part;
        if ($safeMode) { $part = $partCode;              }
        else           { $part = $partCode->{innerHTML}; }
        # Last messages, add last part
        if ($count == ($nbrParts-1) and $lastPartTxt) { $part .= $lastPartTxt; }
        
        # Gather sender details
        if ($part =~ /<a href="([^\"]+)"[^\>]+data-reactid=[^\>]+><img alt="([^\"]+)" src="([^\"]+)/ or
            $part =~ /<a href="([^\"]+)"[^\>]+data-reactroot=[^\>]+><img[^\>]+alt="([^\"]+)"[^\>]+src="([^\"]+)/ or
            $part =~ /<a href="([^\"]+)"[^\>]+data-reactroot=[^\>]+><img[^\>]+src="([^\"]+)"[^\>]+alt="([^\"]+)/ or
            $part =~ /<img[^\>]+src="([^\"]+)"[^\>]+alt="([^\"]+)"/ or
            $part =~ /<img[^\>]+src="([^\"]+)"[^\>]+alt="([^\"]+)"/) { # Profil does not exist anymore
          my $profileUrl;
          my $profileName;
          my $profileImg;
          my $profileImgUrl;
          if ($3) {
            $profileUrl  = $1;
            if ($3 =~ /\.jpg$/) {
              $profileName   = $2;
              $profileImgUrl = $3;
            } else {
              $profileName   = $3;
              $profileImgUrl = $2;
            }
          } else {
            $profileUrl  = '-';
            if ($2 =~ /\.jpg$/) {
              $profileName   = $1;
              $profileImgUrl = $2;
            } else {
              $profileName   = $2;
              $profileImgUrl = $1;
            }
          }
          if ($profileImgUrl =~ /\/([^\/\?]+)\?/) { $profileImg = $1; }
          my $dateUTime;
          my $isText;
          my $text;
          my $GPS_URL;
          my $include = 1; # Indicates if message is in range, yes by default
          
          # Gather profil image if does not exist
          if (!$safeMode and -e "$tmpDir\\$profileImg" and !-e "$imgDir\\$profileImg") {
            rcopy("$tmpDir\\$profileImg", "$imgDir\\$profileImg");
          }
          
          # Gather message date
          if ($part =~ /<abbr title="([^\"]+)" data-utime="([^\"]+)" class="_35 timestamp">/) {
            my $temp   = $1;
            $dateUTime = $2;
            
            # Include this message ?
            if ($dateS or $dateE) {
              if ($dateS and int($dateUTime) <  $dateS) { $include = 0; } # Out of range
              if ($dateE and int($dateUTime) >= $dateE) { last;         } # Out of range
            }
            
            if ($include) {
              
              # Gather GPS coordinates if available
              if ($part =~ /data-hovercard="\/ajax\/messaging\/hovercard\/map\.php\?([^\"]+)/) {
                my $donnees = $1;
                if ($donnees =~ /longitude=([^\&\"]+)/) {
                  my $long = $1;
                  if ($donnees =~ /latitude=([^\&\"]+)/) {
                    my $lat  = $1;
                    $GPS_URL = "http://maps.google.com/maps?q=$lat,$long";
                  }
                }
              }
              
              # Gather text, images and links
              my @paragraphs = split(/_38 direction_ltr/, $part);
              foreach my $par (@paragraphs) {
                $par =~ s/\n//g;
                # Searched part only, delete irrelevant text
                if ($par =~ /clearfix mbs uiMorePager stat_elem _3hh _52jv/) {
                  $par  = (split(/clearfix mbs uiMorePager stat_elem _3hh _52jv/, $par ))[0];
                  $part = (split(/clearfix mbs uiMorePager stat_elem _3hh _52jv/, $part))[0];
                }
                
                if ($par =~ /"><span class="null"><p>(.+)<\/p>/) {
                  $isText = 1;
                  my $extract = $1;
                  # Text
                  $text .= $extract;
                  $text =~ s/</ </g; # add spaces
                  
                  # Emoticons
                  if ($extract =~ / class=\"emoticon emoticon[^\"]+\"/) {
                    while ($extract =~ / class=\"emoticon (emoticon[^\"]+)\"/) {
                      my $emoticonTag = $1;
                      my $imgURL = 'https://www.facebook.com/rsrc.php/v2/yx/r/pimRBh7B6ER.png';
                      $haveEmoticon = 1;
                      # Download the image
                      if (!$emoticonDL) {
                        $mech->save_url($imgURL, "$imgDir\\pimRBh7B6ER.png");
                        $emoticonDL = 1;
                      }
                      my $emoCode = &emoticon($emoticonTag);
                      if ($emoCode and !exists($emoticons{$emoCode})) { $emoticons{$emoCode} = 1; }
                      
                      # Truncate text
                      $extract = &truncateText($extract, length($emoticonTag), $emoticonTag);
                      
                      # Replace in $text
                      $text =~ s/<span[^\>]+>[^\<]*<span[^\<]+class=\"emoticon [^\"]+\"[^\<]*> ?<\/span> ?<span[^\>]+>[^\<]*<\/span> ?<\/span>/<span class=\"emoticon\"><span class=\"$emoticonTag\"><\/span><\/span>/;
                    }
                  }
                  
                  # CSS Sprite
                  # Ex. : <span class="_1az _1a- _2fd"></span>
                  if ($extract =~ /<span class=\"_1az _1a- [^\"]+\"> ?<\/span>/) {
                    while ($extract =~ /<span class=\"_1az _1a- ([^\"]+)\"> ?<\/span>/) {
                      my $spriteID = $1;
                      my $imgURL = 'https://www.facebook.com/rsrc.php/v2/yp/r/aeO1ik7i7-T.png';
                      $cssSprite = 1;
                      # Download the image
                      if (!$spriteDL) {
                        $mech->save_url($imgURL, "$imgDir\\aeO1ik7i7-T.png");
                        $spriteDL = 1;
                      }
                      my $sticker = &cssSpriteBD($spriteID);
                      if ($sticker) { push(@stickers16, $sticker); }
                      
                      # Truncate text
                      $extract = &truncateText($extract, length($spriteID), $spriteID);
                      
                      # Replace in $text
                      $text =~ s/<span class=\"_1az _1a- $spriteID\"> ?<\/span>/<span class=\"sticker16\"><span class=\"$spriteID\"><\/span><\/span>/;
                    }
                  }
    
                  $text .= '<br>';
                  
                  
                # Gather warnings
                } elsif ($par =~ /<div class="[^\"]*uiBoxYellow[^\"]*"[^\>]*>([^\<]+)<\/div>/) {
                  $isText = 1;
                  my $warning = $1;
                  $text .= "<font color=\"#FFCC66\">$1</font><br>";
                }
                
                # Shared link
                if ($par =~ /<a href="([^\"]+)" target="_blank" class="_5rw4"[^\>]*>/) {
                  my $sharedLinkUrl = $1;
                  if ($sharedLinkUrl !~ /^http/) { $sharedLinkUrl = "https://www.facebook.com$sharedLinkUrl"; }
                  my $sharedLinkTxt;
                  if ($par =~ /<div class="[^\"]*__6k[^\"]*"[^\>]*>([^\<]+)<\/div>/) { # See also <div class="[^\"]*__6m[^\"]*">([^\<]+)<\/div>
                    $sharedLinkTxt = $1;
                  } elsif ($par =~ /<div class="[^\"]*__6l[^\"]*"[^\>]*>([^\<]+)<\/div>/) {
                    $sharedLinkTxt = $1;
                  }
                  if ($sharedLinkUrl and $sharedLinkTxt) {
                    $isText = 1;
                    $text .= "<font color=\"#8B2323\">$STR{'sharedLink'}: <a href=\"$sharedLinkUrl\" target=\"_blank\">$sharedLinkTxt</a></font><br>";
                  }
                }
              }
            }
            
            if ($include) {
            
              # Gather notifications (related to call)
              if ($part =~ /<div class="[^\"]*_55s[^\"]*"[^\>]*>([^\<]+)<\/div>/) {
                while ($part =~ /<div class="[^\"]*_55s[^\"]*"[^\>]*>([^\<]+)<\/div>/) {
                  $isText = 1;
                  my $notifTxt = $1;
                  $text .= "<span style=\"font-size: 14px; color: #6E7B8B;\">$notifTxt</span><br>";
                  
                  # Truncate text
                  $part =~ s/<div class="[^\"]*_55s[^\"]*"[^\>]*>([^\<]+)<\/div>//;
                }
              }
              
              ## Gather normal image
              #if    (!$winChat->chChatSafeMode->Checked() and $part =~ /a class="_ksh"/ and
              #       $part =~ /href="[^\"]+" role="img"/ and $part =~ /<img alt="" src="([^\"]+)">/) {
              #  my $imgName = $1;
              #  rcopy("$tmpDir\\$imgName", "$imgDir\\$imgName"); # Copy file
              #  $text = "<img src=\"images_$chatName\\$imgName\" border=0>";
              #  
              #  # Truncate text
              #  $part = &truncateText($part, length($imgName), $imgName);
              #}
              
              # Special image (_55pj)
              if ($part =~ /class="_ksh _55pj"/ and $part =~ /style="background-image: ?url\((?:&quot;)?[^\)]+\)/) {
                while ($part =~ /class="_ksh _55pj"/ and $part =~ /style="background-image: ?url\((?:&quot;)?([^\)]+)\)/) {
                  my $imgURL = my $origImgURL = $1;
                  $imgURL =~ s/&amp;/&/g;
                  my $urlImg;
                  if ($imgURL !~ /^http/) { $urlImg = "https://www.facebook.com$imgURL"; }
                  else                    { $urlImg = $imgURL;                           }
                  if ($winChat->chDownloadImg->Checked()) {
                    my $imgFileName;
                    if ($imgURL =~ /\/([^\/\?]+)\?/) { $imgFileName = $1; }
                    $mech->save_url($urlImg, "$imgDir\\$imgFileName");
                    $text .= "<img src=\"images_$chatName\\$imgFileName\" border=0><br><br>";
                  } else {
                    $text .= "<img src=\"$urlImg\" border=0><br><br>";
                  }
                  
                  # Truncate text
                  $part = &truncateText($part, length($origImgURL), $origImgURL);
                }
              }
              
              # Special image (_55pk)
              elsif ($part =~ /class=" ?_55pk/ and $part =~ /style="background-image: ?url\([^\)]+\)/) {
                while ($part =~ /div class="_332l" style="background-image: ?url\([^\)]+\)|div style="background-image: ?url\([^\)]+\)[^\>]+class="_332l"/ or
                       $part =~ /div class="_4yp9" style="background-image: ?url\([^\)]+\)|div style="background-image: ?url\([^\)]+\)[^\>]+class="_4yp9"/) {
                  # We keep the first
                  my $origImgURL;
                  if ($part =~ /(div class="_332l" style="background-image: ?url\([^\)]+\))/ or
                      $part =~ /(div style="background-image: ?url\([^\)]+\)[^\>]+class="_332l")/) {
                    my $el1 = $1;
                    my $posEl1 = index($part, $el1);
                    if ($part =~ /(div class="_4yp9" style="background-image: ?url\([^\)]+\))/ or
                        $part =~ /(div style="background-image: ?url\([^\)]+\)[^\>]+class="_4yp9")/) {
                      my $el2 = $1;
                      my $posEl2 = index($part, $el2);
                      if ($posEl2 > $posEl1) { $origImgURL = $el1; }
                      else                   { $origImgURL = $el2; }
                    } else { $origImgURL = $el1; }
                  } elsif ($part =~ /(div class="_4yp9" style="background-image: ?url\([^\)]+\))/ or
                           $part =~ /(div style="background-image: ?url\([^\)]+\)[^\>]+class="_4yp9")/) {
                    $origImgURL = $1;
                  }
                  my $imgURL;
                  if ($origImgURL =~ /style="background-image: ?url\((?:&quot;)?([^\)]+)\)/) { $imgURL = $1; }
                  if ($origImgURL and $imgURL) {
                    $imgURL =~ s/&amp;/&/g;
                    $imgURL =~ s/&quot;//g;
                    my $urlImg;
                    if ($imgURL !~ /^http/) { $urlImg = "https://www.facebook.com$imgURL"; }
                    else                    { $urlImg = $imgURL;                           }
                    if ($winChat->chDownloadImg->Checked()) {
                      my $imgFileName;
                      if ($imgURL =~ /\/([^\/\?]+)\?/) { $imgFileName = $1; }
                      $mech->save_url($urlImg, "$imgDir\\$imgFileName");
                      
                      # Download image in full size
                      if ($winChat->chDownloadImgFull->Checked()) {
                        # Open popup image
                        my @links = $mech->selector('div._55pk a');
                        for my $link (@links) {
                          my $linkData = $link->{innerHTML};
                          if ($linkData =~ /class="_4yp6/ and $linkData =~ /$imgFileName/) {
                            my $width;
                            my $height;
                            if ($linkData =~ /width: ?(\d+)px/ ) { $width  = $1; }
                            if ($linkData =~ /height: ?(\d+)px/) { $height = $1; }                            
                            # Open popup
                            $link->click;
                            sleep($CONFIG{'TIME_TO_WAIT'});
                            # Download the image in full size
                            my @bigImgLinks = $mech->selector('img._4-od');
                            foreach (@bigImgLinks) {
                              my $linkBigImg = $_->{src};
                              if ($linkBigImg =~ /\/([^\/\?]+)\?/) {
                                my $nameBigImg = $1;
                                $mech->save_url($linkBigImg, "$imgDir\\$nameBigImg");
                                if ($width and $height) {
                                  $text .= "<img src=\"images_$chatName\\$imgFileName\" width=$width height=$height border=0><br>";
                                } else { $text .= "<img src=\"images_$chatName\\$imgFileName\" border=0><br>"; }
                                $text .= "<span style=\"font-size: 14px;\"><a href=\"images_$chatName\\$nameBigImg\" target=\"_blank\">$STR{'zoomImg'}</a></span><br>";
                              }
                            }
    
                            # Close popup
                            $mech->eval_in_page("var el = document.getElementsByClassName('_4-o9 _50-m _51an _5wx4'); for (var i=0;i<el.length; i++) { el[i].click(); }");
                          }
                        }
                      } else {
                        $text .= "<img src=\"images_$chatName\\$imgFileName\" border=0><br>";
                      }
                      $text .= "<br>";
                    } else {
                      $text .= "<img src=\"$urlImg\" border=0><br><br>";
                    }
                    
                    # Truncate text
                    $part = &truncateText($part, length($origImgURL), $origImgURL);
                  } else { last; }
                }
              }
              
              # Gather stickerContainer type image and animated Facebook images
              elsif ($part =~ /class="mvs/ and ($part =~ /style="background-image: ?url\((?:&quot;)?(\/stickers\/asset\/\?sticker_id[^\&]+)/ or
                                                $part =~ /style="background-image: ?url\(&quot;([^\&]+)&quot;\); background-size/)) {
                my $imgURL = $1;
                if ($imgURL !~ /^http/) { $imgURL = "https://www.facebook.com$imgURL"; }
                # Sticker use redirection
                if (($imgURL =~ /sticker_id=/)) {
                  my $mechSticker = WWW::Mechanize::Firefox->new(autodie => 0);
                  $mechSticker->get($imgURL, synchronize => 0);
                  sleep($CONFIG{'TIME_TO_WAIT'});
                  $imgURL = $mechSticker->uri;
                }
                # Download the image ?
                if (!$safeMode) {
                  my $imgName = $dateUTime;
                  if ($imgURL =~ /\/([^\/]+)$/) { $imgName = $1; }
                  $mech->save_url($imgURL, "$imgDir\\$imgName");
                  $text .= "<img src=\"images_$chatName\\$imgName\" border=0><br>";
                } else { $text .= "<img src=\"$imgURL\" border=0><br>"; }
                
                # Truncate text
                $part = &truncateText($part, length($imgURL), $imgURL);
              }
              
              # Special sticker (this one cannot be displayed if not dowloaded)
              elsif ($part =~ /class="mvs _576q[^\>]+style=\"[^\"]+\"/ or
                     $part =~ /style=\"[^\"]+\"[^\>]+class="mvs _576q[^\>]+/) {
                my $imgURL = 'https://www.facebook.com/rsrc.php/ya/r/FwHVs2eE5cr.svg';
                # Download the image ?
                $mech->save_url($imgURL, "$imgDir\\FwHVs2eE5cr.svg");
                $text .= "<img src=\"images_$chatName\\FwHVs2eE5cr.svg\" width=35 height=35 border=0>";
                
                # Truncate text
                $part = &truncateText($part, length($imgURL), $imgURL);
              }
              
              # Gather video
              elsif ($part =~ /a[^\>]+rel="theater"[^\>]+href="([^\"]+)"/ or $part =~ /a[^\>]+href="([^\"]+)"[^\>]+rel="theater"[^\>]*/) { # Link to the page with the video
                my $urlVideoPage = unescape($1);
                $urlVideoPage =~ s/&amp;/&/g;
                if ($winChat->chDownloadVid->Checked()) { # Download image and video ?
                  if ($part =~ /div[^\>]+class="clearfix _23n-"[^\>]*><img[^\>]+src="([^\"]+)"/) { # Image of the video
                    my $videoImgUrl = $1;
                    $videoImgUrl =~ s/&amp;/&/g;
                    my $videoImgName;
                    if ($videoImgUrl =~ /https:\/\/(?:[^\/]+\/)+([^\/\?]+)\?/) { $videoImgName = $1; }
                    # Gather page with the video
                    my $mechVideo = WWW::Mechanize::Firefox->new(autodie => 0);
                    $mechVideo->get($urlVideoPage, synchronize => 0);
                    sleep($CONFIG{'TIME_TO_WAIT'}+1);
                    if (my $videoURL = $mechVideo->selector('video', one => 1)->{src}) {
                      my $videoName;
                      if ($videoURL =~ /https:\/\/(?:[^\/]+\/)+([^\/\?]+)\?/) { $videoName = $1; }
                      if (!-d $vidDir) { mkdir($vidDir); }
                      $winPb2->lblPbCurr->Text("$STR{'downloading'}: $videoURL");
                      $mechVideo->save_url($videoURL, "$vidDir\\$videoName"); # Download video
                      if ($videoImgUrl and $videoImgName and $mechVideo->save_url($videoImgUrl, "$imgDir\\$videoImgName")) { # Download image of the video
                        # Create message
                        $text .= "<font color=\"#8B2323\">$STR{'video'}: </font><br>";
                        $text .= "<a href=\"videos_$chatName\\$videoName\" target=\"_blank\"><img src=\"images_$chatName\\$videoImgName\" border=0></a></span><br>";
                      # No image, but video downloaded
                      } else {
                        $text .= "<font color=\"#8B2323\">$STR{'video'}: </font><br>";
                        $text .= "<a href=\"videos_$chatName\\$videoName\" target=\"_blank\">$STR{'videoURL'}</a></span><br>";
                      }
                      $winPb2->lblPbCurr->Text($STR{'dumpChatP'}.'...');
                    # Link to video not found
                    } else {
                      $isText = 1;
                      $text .= "$STR{'videoErr'}:<br><span style=\"font-size: 14px;\"><a href=\"$urlVideoPage\" target=\"_blank\">$STR{'videoURL'}</a></span><br>";
                    }
                  # No image, print url only
                  } else {
                    $isText = 1;
                    $text .= "$STR{'videoErr'}:<br><span style=\"font-size: 14px;\"><a href=\"$urlVideoPage\" target=\"_blank\">$STR{'videoURL'}</a></span><br>";
                  }
                } else {
                  $isText = 1;
                  $text .= "<span style=\"font-size: 14px;\"><a href=\"$urlVideoPage\" target=\"_blank\">$STR{'videoURL'}</a></span><br>";
                }
              }
              
              # Gather vocal message
              elsif ($part =~ / class="_1miz _2e-1/ and $part =~ / class="_1mj0 _2e-4 _3oh-"[^\>]*>([^\>]+)<\/span><div class="_1mj1 _2e-5"[^\>]*>/) {
                my $duree = $1;
                $isText = 1;
                my $idAudioFile;
                if ($dateUTime =~ /\./) {
                  $idAudioFile = (split(/\./, $dateUTime))[0];
                  $text .= "<font color=\"#339900\">$STR{'vocalMsgLast'}: </font> <font color=\"#8B2323\">$duree</font><br>";
                  $text .= "<font color=\"#339900\">$STR{'vocalJoin'}:</font> <font color=\"#8B2323\">$idAudioFile.mp4</font><br>";
                  if ($winChat->chDownloadVM->Checked()) {
                    if (!exists($$refMsgVM{$idAudioFile})) { $$refMsgVM{$idAudioFile} = 0; }
                  }
                }
              }
              
              # Gather attached document (audio attached, pdf, doc, etc.)
              elsif ($part =~ /_59go _59gq clearfix"[^\>]*><div[^\>]+class="_ohe lfloat"[^\>]*><a[^\>]+href="([^\"]+)"[^\>]*>/) {
                my $attachedURL = $1;
                if ($part =~ /<span[^\>]+class="_59gp"[^\>]*>([^\<]+)<\/span>/) {
                  my $attachedName = $1;
                  $attachedURL =~ s/&amp;/&/g;
                  $isText = 1;
                  # Download attached document
                  if ($winChat->chDownloadAD->Checked()) {
                    if (!-d "$saveDir\\pj_$chatName") { mkdir("$saveDir\\pj_$chatName"); }
                    my $localPJFile = "$saveDir\\pj_$chatName\\$attachedName";
                    if ($attachedURL =~ /u=([^\&]+)\&/) {
                      my $directURL = unescape($1);
                      $mech->save_url($directURL, $localPJFile);
                      $text .= "<font color=\"#8B2323\">$STR{'attached'}: <a href=\"pj_$chatName\\$attachedName\" target=\"_blank\">$attachedName</a></font><br>";
                    } else {
                    $text .= "<font color=\"#8B2323\">$STR{'attached'}: <a href=\"$attachedURL\" target=\"_blank\">Download $attachedName</a></font><br>";
                  }
                  # Gather the link only
                  } else {
                    $text .= "<font color=\"#8B2323\">$STR{'attached'}: <a href=\"$attachedURL\" target=\"_blank\">Download $attachedName</a></font><br>";
                  }
                }
              }                
              
              # Notifications (source, Seen: date, etc.)
              if ($part =~ /<span class="_510f"[^\>]*>(.+)<\/span>/) {
                my $tempExt = $1;
                $tempExt =~ s/<\/span>.+//g;
                if (length($tempExt) > 2) { # Avoid single space notif
                  $text .= "<br><span style=\"font-size: 14px; color: #6E7B8B;\">$tempExt</span><br>";
                }
              }
              
              # GPS coordinates
              if ($GPS_URL) {
                $text .= "<span style=\"font-size: 14px;\"><a href=\"$GPS_URL\" target=\"_blank\">GPS coordinates</a></span><br>"; }
              
              # Save the message
              if ($text) {
                # Save interlocutor name
                if ($headerNameCode->{innerHTML} =~ /$profileName/) { $interlocutor = $profileName; }
                
                if ($safeMode) { $$refMsgProfileImg{$dateUTime} = $profileImgUrl; }
                else           { $$refMsgProfileImg{$dateUTime} = $profileImg;    }
                $$refMsgProfileUrl{$dateUTime}  = $profileUrl;
                $$refMsgProfileName{$dateUTime} = $profileName;
                $$refMsgIsText{$dateUTime}      = $isText;
                $$refMsgText{$dateUTime}        = $text;
              }
            }
          }
        }
        # Gather notifications (accept)
        elsif ($part =~ /<div class="[^\"]*_42ef[^\"]*">(.+)<\/div>/) {
          if ($part =~ /data-utime="([^\"]+)"/) {
            my $dateUTime = $1;
            my $include   = 1;
            
            # Include this message ?
            if ($dateS or $dateE) {
              if ($dateS and int($dateUTime) <  $dateS) { $include = 0; } # Out of range
              if ($dateE and int($dateUTime) >= $dateE) { last;         } # Out of range
            }
            
            if ($include and $part =~ /<span>([^\<]+)<\/span>/) {
              my $notifTxt = $1;
              $$refMsgProfileImg{$dateUTime}  = '-';
              $$refMsgProfileUrl{$dateUTime}  = '-';
              $$refMsgProfileName{$dateUTime} = '-';
              $$refMsgIsText{$dateUTime}      = 1;
              $$refMsgText{$dateUTime}        = "<span style=\"font-size: 14px; color: #6E7B8B;\">$notifTxt</span><br>";
            }
          }
        }
        $count++;
        $winPb2->lblCount->Text("$count/$nbrParts");
      }
      $i++;
    }
    $step = 3; # Page has been parsed
  }
  
  # Download Vocal Messages
  if ($winChat->chDownloadVM->Checked() and $step == 3) {
    my $nbrVM = scalar(keys %{$refMsgVM});
    if ($nbrVM > 0) { # At least one vocal message
      $winPb2->lblPbCurr->Text($STR{'openMobile'}.'...');
      if (!-d $vmDir) { mkdir($vmDir); }

      # Load the interlocutor chat
      if (!$downloadVMStep) {
        my $i = 0;
        
        # Open Mobile Facebook
        my $mechVM = WWW::Mechanize::Firefox->new(create => 1, autodie => 0);
        # Already started, select current page
        if ($currentPage) { $mechVM->get($currentPage, synchronize => 0); }
        # Else, load the first page
        else { $mechVM->get('https://m.facebook.com/messages/', synchronize => 0); }
        sleep($CONFIG{'TIME_TO_WAIT'});
        
        while (!$mobilePage) {
          # Search in current page
          my @linkChats = $mechVM->selector('h3.bu a');
          foreach my $chat (@linkChats) {
            if ($chat->{innerHTML} =~ /$interlocutor/) {
              $mobilePage = $chat->{href};
              $chat->click();
              last;
            }
          }
          # Load another page
          if (!$mobilePage and my @links = $mechVM->selector('div.f')) {
            foreach my $link (@links) {
              if ($link->{outerHTML} =~ /see_older_threads/) {
                $i++;
                $currentPage = "https://m.facebook.com/messages/?pageNum=$i&selectable&pagination_direction=1&refid=11";
                $mechVM->get($currentPage, synchronize => 0);
                sleep($CONFIG{'TIME_TO_WAIT'});
                last;
              }
            }
          }
        }
        sleep($CONFIG{'TIME_TO_WAIT'});
        $downloadVMStep = 1;
        $currentPage = '';
      }
      
      # Browse all chat and gather all audioclip urls
      if ($downloadVMStep == 1 and $mobilePage) {
        $winPb2->lblPbCurr->Text($STR{'searchVMLinks'}.'...');
        
        my $mechVM = WWW::Mechanize::Firefox->new(create => 1, autodie => 0);
        # If already started, start from last page
        if ($currentPage) {
          $mechVM->get($currentPage, synchronize => 0);
        # Else, load the first page
        } else {
          $mechVM->get($mobilePage , synchronize => 0);
          $countVM = 0;
          
          $winPb2->lblCount->Text("$countVM/$nbrVM");
        }
        sleep($CONFIG{'TIME_TO_WAIT'});
        my $lastPage = 0;
        while (!$lastPage) {
          # Search audioclip links in the page
          my @fileLinks = $mechVM->selector('div.bx a'); # bm bl ...
          foreach my $fileLink (@fileLinks) {
            if ($fileLink->{innerHTML} =~ /audioclip-/ and $fileLink->{innerHTML} =~ /span>(\d{10})<\/span/) {
              my $idFile = $1;
              if ((exists($$refMsgVM{$idFile}) or exists($$refMsgVM{$idFile-1}) or exists($$refMsgVM{$idFile+1}) or
                                                  exists($$refMsgVM{$idFile-2}) or exists($$refMsgVM{$idFile+2}) or
                                                  exists($$refMsgVM{$idFile-3}) or exists($$refMsgVM{$idFile+3}) or
                                                  exists($$refMsgVM{$idFile-4}) or exists($$refMsgVM{$idFile+4}) or
                                                  exists($$refMsgVM{$idFile-5}) or exists($$refMsgVM{$idFile+5})) and
                  $fileLink->{href} =~ /u=([^\&]+)\&/) {
                my $url = $1;
                
                # IdFile is not exactly the same, change it
                if (!exists($$refMsgVM{$idFile})) {
                  delete($$refMsgVM{$idFile});
                  if    (exists($$refMsgVM{$idFile-1})) { $idFile -= 1; }
                  elsif (exists($$refMsgVM{$idFile+1})) { $idFile += 1; }
                  elsif (exists($$refMsgVM{$idFile-2})) { $idFile -= 2; }
                  elsif (exists($$refMsgVM{$idFile+2})) { $idFile += 2; }
                  elsif (exists($$refMsgVM{$idFile-3})) { $idFile -= 3; }
                  elsif (exists($$refMsgVM{$idFile+3})) { $idFile += 3; }
                  elsif (exists($$refMsgVM{$idFile-4})) { $idFile -= 4; }
                  elsif (exists($$refMsgVM{$idFile+4})) { $idFile += 4; }
                  elsif (exists($$refMsgVM{$idFile-5})) { $idFile -= 5; }
                  elsif (exists($$refMsgVM{$idFile+5})) { $idFile += 5; }
                } 
                
                $$refMsgVM{$idFile} = unescape($1);
                $countVM++;
                $winPb2->lblCount->Text("$countVM/$nbrVM");
              }
            }
          }
          
          # All links found
          if ($countVM == $nbrVM) { last; }
          
          # Load another page
          my $seeOlderLink = $mechVM->selector('div.f.bq a', any => 1);
          if (!$seeOlderLink) { $seeOlderLink = $mechVM->selector('div.f.bp a', any => 1); }
          if (!$seeOlderLink) { $seeOlderLink = $mechVM->selector('div.f.br a', any => 1); }
          if ($seeOlderLink) {
            $currentPage = $seeOlderLink->{href};
            $seeOlderLink->click();
            sleep($CONFIG{'TIME_TO_WAIT'});
          } else { $lastPage = 1; }
        }
        $downloadVMStep = 2;
        $countVM = 0;
      }
        
      # Download all mp4 files
      if ($downloadVMStep == 2) {
        if (!$countVM) {
          $winPb2->lblPbCurr->Text($STR{'chDownloadVM'}.'...');
        }
        $winPb2->lblCount->Text("$countVM/$nbrVM");
        my $i = 0;
        foreach my $idAudioFile (sort keys %{$refMsgVM}) {
          if ($i >= $countVM) {
            if ($$refMsgVM{$idAudioFile}) {
              my $vmPath = "$vmDir\\$idAudioFile\.mp4";
              $mech->save_url($$refMsgVM{$idAudioFile}, $vmPath);
              $$refMsgVM{$idAudioFile} = $vmPath;
              $countVM++;
              $winPb2->lblCount->Text("$countVM/$nbrVM");
            }
          }
          $i++;
        }
      }
    }
    $step = 4; # Vocal Messages has been downloaded
  }
  
  # Save the chat in a HTML file
  if (($winChat->chDownloadVM->Checked() and $step == 4) or (!$winChat->chDownloadVM->Checked() and $step == 3)) {
    my $count2 = 0;
    $winPb2->lblPbCurr->Text($STR{'saveChat'}.'...');
    $winPb2->lblCount->Text('');
    my $htmlChatPage = "$saveDir\\$chatName.html";
    if (!$interlocutor) { $interlocutor = $chatName; }
    open(HTML, ">:encoding(UTF-8)", $htmlChatPage);
    print HTML "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n";
    print HTML "<html>\n<head>\n<title>$interlocutor</title>\n";
    print HTML "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf8\">\n";
    print HTML "<style>\n";
    if ($haveEmoticon == 1) {
      print HTML ".emoticon span\n";
      print HTML "{\n";
      print HTML "  display:inline-block;\n";
      print HTML "  vertical-align:top;\n";
      print HTML "  background: url(\"images_$chatName\\\\pimRBh7B6ER.png\");\n";
      print HTML "  background-repeat:no-repeat;\n";
      print HTML "  background-size:auto;\n";
      print HTML "  width: 16px;\n";
      print HTML "  height: 16px;\n";
      print HTML "  margin:0 1px 0 1px;\n";
      print HTML "}\n";
      foreach (keys %emoticons) { print HTML "$_\n"; }
    }
    if ($cssSprite == 1) {
      print HTML ".sticker16 span\n";
      print HTML "{\n";
      print HTML "  display:inline-block;\n";
      print HTML "  vertical-align:top;\n";
      print HTML "  background: url(\"images_$chatName\\\\aeO1ik7i7-T.png\");\n";
      print HTML "  background-repeat:no-repeat;\n";
      print HTML "  background-size:auto;\n";
      print HTML "  width: 16px;\n";
      print HTML "  height: 16px;\n";
      print HTML "  margin:0 1px 0 1px;\n";
      print HTML "}\n";
      foreach (@stickers16) { print HTML "$_\n"; }
    }
    print HTML "    td:last-child {\n";
    print HTML "  overflow-wrap: break-word;\n";
    print HTML "  word-wrap: break-word;\n";
    print HTML "  -ms-word-break: break-all;\n";
    print HTML "  word-break: break-all;\n";
    print HTML "  word-break: break-word;\n";
    print HTML "  -ms-hyphens: auto;\n";
    print HTML "  -moz-hyphens: auto;\n";
    print HTML "  -webkit-hyphens: auto;\n";
    print HTML "  hyphens: auto;\n";
    print HTML "}\n";
    print HTML "</style>\n";
    print HTML "</head>\n";
    print HTML "<body style=\"font-family: Calibri, Verdana, Arial; font-size: smaller; color: Black;\">\n";
    print HTML "<h1 style=\"color:#003300; font-size: 18pt; font-variant: small-caps; font-weight: bold;\" align=\"center\">";
    print HTML "$interlocutor</h1>\n";
    print HTML "<table border=1 cellspacing=0 cellpadding=1 align=\"center\">\n";
    if ($startText) {
      print HTML "<tr><td colspan=5 align=\"center\" bgcolor=\"#EEEEEE\">$startText</td></tr>\n";
    }
    print HTML "<tr>\n";
    print HTML "<td style=\"font-weight: bold;\">$STR{'image'}</td>\n";
    print HTML "<td style=\"font-weight: bold;\">$STR{'url'}</td>\n";
    print HTML "<td style=\"font-weight: bold;\">$STR{'name'}</td>\n";
    print HTML "<td style=\"font-weight: bold;\">$STR{'date'}</td>\n";
    print HTML "<td style=\"font-weight: bold;\">$STR{'message'}</td>\n";
    print HTML "</tr>\n";
    foreach my $date (sort keys %{$refMsgText}) {
      $count2++;
      $winPb2->lblCount->Text($count2);
      # Is it me ?
      my $isMe = 0;
      if ($$refMsgProfileUrl{$date} ne '-' and $$refMsgProfileUrl{$date} !~ /$profilID/) { $isMe = 1; }
      # Print fields
      print HTML "<tr>\n";
      my $imgPath;
      if ($safeMode) { $imgPath = "$$refMsgProfileImg{$date}";                    }
      else           { $imgPath = "images_$chatName\\$$refMsgProfileImg{$date}"; }
      if ($isMe and $winChat->chHideMe->Checked()) { # HideMe
        my $imgTag;
        if ($imgPath ne '-') { $imgTag = "<img src=\"$imgPath\" width=32 height=32 border=0 style=\"display: none;\">"; }
        else { $imgTag = '-'; };
        print HTML "<td align=\"center\" style=\"background-color:black\">$imgTag</td>\n";
        print HTML "<td valign=\"top\" style=\"background-color:black\">$$refMsgProfileUrl{$date}</td>\n";
        print HTML "<td valign=\"top\" style=\"background-color:black\">$$refMsgProfileName{$date}</td>\n";
      } elsif ($isMe) { # Me, no background color
        my $imgTag;
        if ($imgPath ne '-') { $imgTag = "<img src=\"$imgPath\" width=32 height=32 border=0>"; }
        else { $imgTag = '-'; };
        print HTML "<td align=\"center\">$imgTag</td>\n";
        print HTML "<td valign=\"top\">$$refMsgProfileUrl{$date}</td>\n";
        print HTML "<td valign=\"top\">$$refMsgProfileName{$date}</td>\n";
      } else {
        my $imgTag;
        if ($imgPath ne '-') { $imgTag = "<img src=\"$imgPath\" width=32 height=32 border=0>"; }
        else { $imgTag = '-'; };
        print HTML "<td align=\"center\" style=\"background-color:#F9FAFC\">$imgTag</td>\n";
        print HTML "<td valign=\"top\" style=\"background-color:#F9FAFC\">$$refMsgProfileUrl{$date}</td>\n";
        print HTML "<td valign=\"top\" style=\"background-color:#F9FAFC\">$$refMsgProfileName{$date}</td>\n";
      }
      my $dateStr = &formatDate($date);
      if ($isMe) { print HTML "<td valign=\"top\">$dateStr</td>\n";                                    }
      else            { print HTML "<td valign=\"top\" style=\"background-color:#F9FAFC\">$dateStr</td>\n"; }
      
      if ($$refMsgIsText{$date} == 1) {
        # Vocal message
        if ($winChat->chDownloadVM->Checked() and $$refMsgText{$date} =~ /$STR{'vocalJoin'}/) {
          if ($$refMsgText{$date} =~ /<font color="#339900">$STR{'vocalJoin'}:<\/font> <font color="#8B2323">(\d+)\.mp4<\/font>/) {
            my $vmId = $1;
            if (-e "$saveDir\\vm_$chatName\\$vmId\.mp4") {
              $$refMsgText{$date} =~ s/<font color="#339900">$STR{'vocalJoin'}:<\/font> <font color="#8B2323">([^\<]+)<\/font>/<font color="#339900">$STR{'vocalMsgFile'}:<\/font> <font color="#8B2323"><a href="vm_$chatName\\$vmId\.mp4" target="_blank">$1<\/a><\/font>/;
            }
          }
        }
        
        if ($isMe == 1) { print HTML "<td valign=\"top\">$$refMsgText{$date}</td>\n</tr>\n";                                    }
        else            { print HTML "<td valign=\"top\" style=\"background-color:#F9FAFC\">$$refMsgText{$date}</td>\n</tr>\n"; }
      } else {
        if ($isMe == 1) { print HTML "<td align=\"center\">$$refMsgText{$date}</td>\n";                                    }
        else            { print HTML "<td align=\"center\" style=\"background-color:#F9FAFC\">$$refMsgText{$date}</td>\n"; }
      }
    }
    print HTML "</table>\n</body>\n</html>\n";
    close(HTML);
    
    # Open the page
    $win->ShellExecute('open', $htmlChatPage,'','',1);
  }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;
  
  # Delete temporary files
  if ($winConfig->chDelTempFiles->Checked()) { remove_tree($tmpDir); }

  $win->Tray->Change(-tip => $STR{'dumpChatF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'            ,
                        -balloon_title => 'ExtractFace'     ,
                        -balloon_tip   => $STR{'dumpChatF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);
  

}  #--- End dumpChat

#--------------------------#
sub truncateText
#--------------------------#
{
  # Local variables
  my ($text, $long, $toIndex) = @_;
  
  my $lineWidth = length($text);
  my $pos       = index($text, $toIndex);
  my $offset    = $pos+$long;
  $text         = substr($text,$offset,$lineWidth-$offset);

  return($text);

}  #--- End truncateText

#--------------------------#
sub winChat_Terminate
#--------------------------#
{
  return(-1);

}  #--- Fin winChat_Terminate

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb->lblPbCurr1->Text($STR{'cancel2'}.'...');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    &winPb_Terminate;
    if ($THR->is_running()) { $THR->kill('KILL')->detach(); }
    $win->ChangeCursor($ARROW);
  }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub btnCancel2_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb2->lblPbCurr->Text($STR{'cancel2'}.'...');
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    if ($THR->is_running()) { $THR->kill('KILL')->detach(); }
    $win->ChangeCursor($ARROW);
  }
  return(1);

}  #--- End btnCancel2_Click

#--------------------------#
sub winConfig
#--------------------------#
{
  # Default tab is General options
  $winConfig->configTab->Select(0);
  $winConfig->lblTool->Show();
  $winConfig->btnExportLang->Show();
  $winConfig->btnCheckUpdate->Show();
  $winConfig->chAutoUpdate->Show();
  $winConfig->lblFunctions->Show();
  $winConfig->lblTimeToWait->Show();
  $winConfig->tfTimeToWait->Show();
  $winConfig->upTimeToWait->Show();
  $winConfig->lblTimeToWait2->Show();
  $winConfig->lblNbrResume->Show();
  $winConfig->tfNbrResume->Show();
  $winConfig->upNbrResume->Show();
  $winConfig->chDelTempFiles->Show();
  $winConfig->chDebugLogging->Show();
  $winConfig->lblCharset->Show();
  $winConfig->cbCharset->Show();
  $winConfig->chOptSeemore->Hide();
  $winConfig->chOptComments->Hide();
  $winConfig->chOptPosts->Hide();
  $winConfig->chOptTranslate->Hide();
  $winConfig->lblMaxScrollChat->Hide();
  $winConfig->rbMaxScrollChatByPage->Hide();
  $winConfig->tfMaxScrollChat->Hide();
  $winConfig->upMaxScrollChat->Hide();
  $winConfig->rbMaxScrollChatByDate->Hide();
  $winConfig->dtMaxScrollChatByDate->Hide();
  $winConfig->lblMaxScroll->Hide();
  $winConfig->rbMaxScrollByPage->Hide();
  $winConfig->tfMaxScroll->Hide();
  $winConfig->upMaxScroll->Hide();
  $winConfig->rbMaxScrollByDate->Hide();
  $winConfig->dtMaxScrollByDate->Hide();
  $winConfig->chOptScrollTop->Hide();
  
  $winConfig->Center();
  $winConfig->DoModal();

}  #--- End winConfig

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General Options
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblTool->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->lblFunctions->Show();  
    $winConfig->lblTimeToWait->Show();
    $winConfig->tfTimeToWait->Show();
    $winConfig->upTimeToWait->Show();
    $winConfig->lblTimeToWait2->Show();
    $winConfig->lblNbrResume->Show();
    $winConfig->tfNbrResume->Show();
    $winConfig->upNbrResume->Show();
    $winConfig->chDelTempFiles->Show();
    $winConfig->chDebugLogging->Show();
    $winConfig->lblCharset->Show();
    $winConfig->cbCharset->Show();
    $winConfig->lblMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByPage->Hide();
    $winConfig->tfMaxScrollChat->Hide();
    $winConfig->upMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByDate->Hide();
    $winConfig->dtMaxScrollChatByDate->Hide();
    $winConfig->lblMaxScroll->Hide();
    $winConfig->rbMaxScrollByPage->Hide();
    $winConfig->tfMaxScroll->Hide();
    $winConfig->upMaxScroll->Hide();
    $winConfig->rbMaxScrollByDate->Hide();
    $winConfig->dtMaxScrollByDate->Hide();
    $winConfig->chOptScrollTop->Hide();
    $winConfig->chOptSeemore->Hide();
    $winConfig->chOptComments->Hide();
    $winConfig->chOptPosts->Hide();
    $winConfig->chOptTranslate->Hide();
    
  # Show Scroll Options
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    $winConfig->lblMaxScrollChat->Show();
    $winConfig->rbMaxScrollChatByPage->Show();
    $winConfig->tfMaxScrollChat->Show();
    $winConfig->upMaxScrollChat->Show();
    $winConfig->rbMaxScrollChatByDate->Show();
    $winConfig->dtMaxScrollChatByDate->Show();
    $winConfig->lblMaxScroll->Show();
    $winConfig->rbMaxScrollByPage->Show();
    $winConfig->tfMaxScroll->Show();
    $winConfig->upMaxScroll->Show();
    $winConfig->rbMaxScrollByDate->Show();
    $winConfig->dtMaxScrollByDate->Show();
    $winConfig->chOptScrollTop->Show();
    $winConfig->chOptSeemore->Hide();
    $winConfig->chOptComments->Hide();
    $winConfig->chOptPosts->Hide();
    $winConfig->chOptTranslate->Hide();
    $winConfig->lblTool->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->lblFunctions->Hide();
    $winConfig->lblTimeToWait->Hide();
    $winConfig->tfTimeToWait->Hide();
    $winConfig->upTimeToWait->Hide();
    $winConfig->lblTimeToWait2->Hide();
    $winConfig->lblNbrResume->Hide();
    $winConfig->tfNbrResume->Hide();
    $winConfig->upNbrResume->Hide();
    $winConfig->chDelTempFiles->Hide();
    $winConfig->chDebugLogging->Hide();
    $winConfig->lblCharset->Hide();
    $winConfig->cbCharset->Hide();
  
  # Show Chat options
  } else {
    $winConfig->chOptSeemore->Show();
    $winConfig->chOptComments->Show();
    $winConfig->chOptPosts->Show();
    $winConfig->chOptTranslate->Show();
    $winConfig->lblTool->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->lblFunctions->Hide();
    $winConfig->lblTimeToWait->Hide();
    $winConfig->tfTimeToWait->Hide();
    $winConfig->upTimeToWait->Hide();
    $winConfig->lblTimeToWait2->Hide();
    $winConfig->lblNbrResume->Hide();
    $winConfig->tfNbrResume->Hide();
    $winConfig->upNbrResume->Hide();
    $winConfig->chDelTempFiles->Hide();
    $winConfig->chDebugLogging->Hide();
    $winConfig->lblCharset->Hide();
    $winConfig->cbCharset->Hide();
    $winConfig->lblMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByPage->Hide();
    $winConfig->tfMaxScrollChat->Hide();
    $winConfig->upMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByDate->Hide();
    $winConfig->dtMaxScrollChatByDate->Hide();
    $winConfig->lblMaxScroll->Hide();
    $winConfig->rbMaxScrollByPage->Hide();
    $winConfig->tfMaxScroll->Hide();
    $winConfig->upMaxScroll->Hide();
    $winConfig->rbMaxScrollByDate->Hide();
    $winConfig->dtMaxScrollByDate->Hide();
    $winConfig->chOptScrollTop->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub winConfig_Terminate
#--------------------------#
{
  return(-1);

}  #--- End winConfig_Terminate

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG,">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnCheckUpdate_Click
#--------------------------#
{
  &checkUpdate(1);

}  #--- End btnCheckUpdate_Click

#--------------------------#
sub checkUpdate
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent('ExtractFaceUpdate $VERSION');
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($win, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      $win->Show();
      # Download with browser
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024);
      if ($answer == 6) {
        # Open Firefox to XL-Tools page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} ExtractFace",0x40010);
      }
    }
  }
  # Error 
  else {
    my $status  = $res->code;
    my $error   = $res->status_line;
    Win32::GUI::MessageBox($win, "$STR{'err1T'}: $STR{'returnedCode'} = [$status]; $STR{'returnedError'} = [$error].", $STR{'err7'},0x40010);
  }

}  #--- End checkUpdate

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub tfTimeToWait_Change
#--------------------------#
{
  # Local variables
  my $timeToWait = $winConfig->tfTimeToWait->Text();
  
  # Remember
  if ($START == 1) {
    $CONFIG{'TIME_TO_WAIT'} = $timeToWait;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfTimeToWait_Change

#--------------------------#
sub tfNbrResume_Change
#--------------------------#
{
  # Local variables
  my $nbrResume = $winConfig->tfNbrResume->Text();
  
  # Remember
  if ($START == 1) {
    $CONFIG{'NBR_RESUME'} = $nbrResume;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfNbrResume_Change

#--------------------------#
sub chDelTempFiles_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDelTempFiles->Checked()) {
    $CONFIG{'DEL_TEMP_FILES'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'DEL_TEMP_FILES'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDelTempFiles_Click

#--------------------------#
sub chDebugLogging_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDebugLogging->Checked()) {
    $CONFIG{'DEBUG_LOGGING'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'DEBUG_LOGGING'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDebugLogging_Click

#--------------------------#
sub cbCharset_Change
#--------------------------#
{
  my $charset = $winConfig->cbCharset->GetString($winConfig->cbCharset->GetCurSel());
  
  # Save the choice
  $CONFIG{'CHARSET'} = $charset;
  &saveConfig(\%CONFIG);

}  #--- End cbCharset_Change

#--------------------------#
sub tfMaxScrollChat_Change
#--------------------------#
{
  # Local variables
  my $maxScroll = $winConfig->tfMaxScrollChat->Text();

  # Remember
  if ($START == 1) {
    $winConfig->rbMaxScrollChatByDate->Checked(0);
    $winConfig->rbMaxScrollChatByPage->Checked(1);
    $CONFIG{'MAX_LOADING_MSG'} = $maxScroll;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxScrollChat_Change

#--------------------------#
sub dtMaxScrollChatByDate_Change
#--------------------------#
{
  $winConfig->rbMaxScrollChatByPage->Checked(0);
  $winConfig->rbMaxScrollChatByDate->Checked(1);

}  #--- End dtMaxScrollChatByDate_Change

#--------------------------#
sub tfMaxScroll_Change
#--------------------------#
{
  # Local variables
  my $maxScroll = $winConfig->tfMaxScroll->Text();  
  
  # Remember
  if ($START == 1) {
    $winConfig->rbMaxScrollByDate->Checked(0);
    $winConfig->rbMaxScrollByPage->Checked(1);
    $CONFIG{'MAX_SCROLL'} = $maxScroll;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxScroll_Change

#--------------------------#
sub dtMaxScrollByDate_Change
#--------------------------#
{
  $winConfig->rbMaxScrollByPage->Checked(0);
  $winConfig->rbMaxScrollByDate->Checked(1);

}  #--- End dtMaxScrollByDate_Change

#--------------------------#
sub chOptScrollTop_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptScrollTop->Checked()) {
    $CONFIG{'OPT_SCROLL_TOP'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_SCROLL_TOP'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptScrollTop_Click

#--------------------------#
sub chOptSeemore_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptSeemore->Checked()) {
    $CONFIG{'EXPAND_SEE_MORE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_SEE_MORE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptSeemore_Click

#--------------------------#
sub chOptPosts_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptPosts->Checked()) {
    $CONFIG{'EXPAND_MORE_POSTS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_MORE_POSTS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptPosts_Click

#--------------------------#
sub chOptComments_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptComments->Checked()) {
    $CONFIG{'EXPAND_MORE_COMMENTS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_MORE_COMMENTS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptComments_Click

#--------------------------#
sub chOptTranslate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptTranslate->Checked()) {
    $CONFIG{'SEE_TRANSLATION'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'SEE_TRANSLATION'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptTranslate_Click

#--------------------------#
sub help
#--------------------------#
{
  # Open Firefox to XL-Tools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} ExtractFace",0x40010);

}  #--- End help

#--------------------------#
sub loadPage
#--------------------------#
{
  # Local variables
  my ($refMech, $url) = @_;
  
  $$refMech->get($url, synchronize => 0);
  sleep($CONFIG{'TIME_TO_WAIT'});
  my $currURL   = $$refMech->uri();
  my $currTitle;
  if ($currURL and $currURL =~ /https:\/\/www.facebook.com\//) {
    if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
    elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
  }

  return($currURL, $currTitle);

}  #--- End loadPage

#--------------------------#
sub formatDate
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  
  # Convert to string, local timezone
  if ($unixtime =~ /\./) { $unixtime = (split(/\./, $unixtime))[0]; }
  my ($s,$min,$hr,$d,$m,$y,$weekday,$ha,$isDST) = localtime($unixtime);
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $hr  = $hr  < 10 ? $hr  = "0".$hr  : $hr;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  return("$y-$m-$d $hr:$min:$s");

}  #--- End formatDate

#--------------------------#
sub debug
#--------------------------#
{
  # Local variables
  my $refMsg  = shift;
  my $dateStr = &formatDate(time);
  
  # Save error msg in debug log file
  if (-e $DEBUG_FILE) { open(DEBUG,">>$DEBUG_FILE"); }
  else                { open(DEBUG,">$DEBUG_FILE");  }
  flock(DEBUG, 2);
  print DEBUG "$dateStr\t$refMsg\n";
  close(DEBUG);  

}  #--- End debug

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);  

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # If ini file exists
  if (-T $CONFIG_FILE) {
    # Open and load config values
    open(CONFIG, $CONFIG_FILE);
    my @tab = <CONFIG>;
    close(CONFIG);
    
    foreach (@tab) {
      chomp($_);
      my ($key, $value) = split(/ = /, $_);
      if ($key) { $$refConfig{$key}  = $value; }
    }
  }
  
  # Start minimized
  if (exists($$refConfig{'START_MINIMIZED'}))       { $win->chStartMinimized->Checked($$refConfig{'START_MINIMIZED'});                  }
  else                                              { $win->chStartMinimized->Checked(0);                                               } # Default is not checked
  
  # General settings
  if (exists($$refConfig{'TIME_TO_WAIT'}))          { $winConfig->upTimeToWait->SetPos($$refConfig{'TIME_TO_WAIT'});                    }
  else                                              { $winConfig->upTimeToWait->SetPos(2); $$refConfig{'TIME_TO_WAIT'} =  2;            } # Default value is 2
  if (exists($$refConfig{'NBR_RESUME'}))            { $winConfig->upNbrResume->SetPos($$refConfig{'NBR_RESUME'});                       }
  else                                              { $winConfig->upNbrResume->SetPos(10); $$refConfig{'NBR_RESUME'}   = 10;            } # Default value is 10
  if (exists($$refConfig{'OPT_SCROLL_TOP'}))        { $winConfig->chOptScrollTop->Checked($$refConfig{'OPT_SCROLL_TOP'});               }
  else                                              { $winConfig->chOptScrollTop->Checked(1); $$refConfig{'OPT_SCROLL_TOP'} = 1;        } # Default is checked
  if (exists($$refConfig{'AUTO_UPDATE'}))           { $winConfig->chAutoUpdate->Checked($$refConfig{'AUTO_UPDATE'});                    }
  else                                              { $winConfig->chAutoUpdate->Checked(1);   $$refConfig{'AUTO_UPDATE'}    = 1;        } # Default is checked
  if (exists($$refConfig{'DEL_TEMP_FILES'}))        { $winConfig->chDelTempFiles->Checked($$refConfig{'DEL_TEMP_FILES'});               }
  else                                              { $winConfig->chDelTempFiles->Checked(1); $$refConfig{'DEL_TEMP_FILES'} = 1;        } # Default is checked
  if (exists($$refConfig{'DEBUG_LOGGING'}))         { $winConfig->chDebugLogging->Checked($$refConfig{'DEBUG_LOGGING'});                }
  else                                              { $winConfig->chDebugLogging->Checked(0); $$refConfig{'DEBUG_LOGGING'} = 0;         } # Default is not checked
  if (exists($$refConfig{'CHARSET'}))               { $winConfig->cbCharset->SetCurSel($winConfig->cbCharset->FindString($$refConfig{'CHARSET'})); }
  else                                              { $winConfig->cbCharset->SetCurSel(0);    $$refConfig{'CHARSET'} = 'cp1252';        } # Default is cp1252
  if (exists($$refConfig{'EXPAND_SEE_MORE'}))       { $winConfig->chOptSeemore->Checked($$refConfig{'EXPAND_SEE_MORE'});                }
  else                                              { $winConfig->chOptSeemore->Checked(1);   $$refConfig{'EXPAND_SEE_MORE'}      = 1;  } # Default is checked
  if (exists($$refConfig{'EXPAND_MORE_POSTS'}))     { $winConfig->chOptPosts->Checked($$refConfig{'EXPAND_MORE_POSTS'});                }
  else                                              { $winConfig->chOptPosts->Checked(1);     $$refConfig{'EXPAND_MORE_POSTS'}    = 1;  } # Default is checked
  if (exists($$refConfig{'EXPAND_MORE_COMMENTS'}))  { $winConfig->chOptComments->Checked($$refConfig{'EXPAND_MORE_COMMENTS'});          }
  else                                              { $winConfig->chOptComments->Checked(1);  $$refConfig{'EXPAND_MORE_COMMENTS'} = 1;  } # Default is checked
  if (exists($$refConfig{'SEE_TRANSLATION'}))       { $winConfig->chOptTranslate->Checked($$refConfig{'SEE_TRANSLATION'});              }
  else                                              { $winConfig->chOptTranslate->Checked(0); $$refConfig{'SEE_TRANSLATION'}      = 0;  } # Default is not checked
  if (exists($$refConfig{'MAX_LOADING_MSG'}))       { $winConfig->upMaxScrollChat->SetPos($$refConfig{'MAX_LOADING_MSG'});              }
  else                                              { $winConfig->upMaxScrollChat->SetPos(0); $$refConfig{'MAX_LOADING_MSG'} = 0;       } # Default value is 0 (No maximum)
  if (exists($$refConfig{'MAX_SCROLL'}))            { $winConfig->upMaxScroll->SetPos($$refConfig{'MAX_SCROLL'});                       }
  else                                              { $winConfig->upMaxScroll->SetPos(0); $$refConfig{'MAX_SCROLL'} = 0;                } # Default value is 0 (No maximum)

  # Directories
  if (exists($$refConfig{'DIR_SAVE_ALBUMS'})  and -d $$refConfig{'DIR_SAVE_ALBUMS'})  { $winAlbums->tfDirSaveAlbums->Text($$refConfig{'DIR_SAVE_ALBUMS'});        }
  if (exists($$refConfig{'DIR_SAVE_FRIENDS'}) and -d $$refConfig{'DIR_SAVE_FRIENDS'}) { $winFriends->tfDirSaveFriends->Text($$refConfig{'DIR_SAVE_FRIENDS'});     }
  if (exists($$refConfig{'DIR_SAVE_EVENT'})   and -d $$refConfig{'DIR_SAVE_EVENT'})   { $winEvent->tfDirSaveEvent->Text($$refConfig{'DIR_SAVE_EVENT'});           }
  if (exists($$refConfig{'DIR_SAVE_CONTRIB'}) and -d $$refConfig{'DIR_SAVE_CONTRIB'}) { $winContrib->tfDirSaveContrib->Text($$refConfig{'DIR_SAVE_CONTRIB'});     }
  if (exists($$refConfig{'DIR_SAVE_CHAT'})    and -d $$refConfig{'DIR_SAVE_CHAT'})    { $winChat->tfDirSaveChat->Text($$refConfig{'DIR_SAVE_CHAT'});              }

  # Window options
  # Dump Albums
  if (exists($$refConfig{'REMEMBER_SAVE_ALBUMS'}))  { $winAlbums->chSaveAlbumDir->Checked($$refConfig{'REMEMBER_SAVE_ALBUMS'});               }
  else                                              { $winAlbums->chSaveAlbumDir->Checked(1);     $$refConfig{'REMEMBER_SAVE_ALBUMS'}   = 1;  } # Default is checked
  if (exists($$refConfig{'ALBUMS_PUBLISH_DATE'}))   { $winAlbums->chPublishDate->Checked($$refConfig{'ALBUMS_PUBLISH_DATE'});                 }
  else                                              { $winAlbums->chPublishDate->Checked(0);      $$refConfig{'ALBUMS_PUBLISH_DATE'}    = 0;  } # Default is not checked
  if (exists($$refConfig{'ALBUMS_OPEN_HTML'}))      { $winAlbums->chAlbumsOpenHTML->Checked($$refConfig{'ALBUMS_OPEN_HTML'});                 }
  else                                              { $winAlbums->chAlbumsOpenHTML->Checked(1);   $$refConfig{'ALBUMS_OPEN_HTML'}       = 1;  } # Default is checked
  if (exists($$refConfig{'ALBUMS_OPEN_DIR'}))       { $winAlbums->chAlbumsOpenDir->Checked($$refConfig{'ALBUMS_OPEN_DIR'});                   }
  else                                              { $winAlbums->chAlbumsOpenDir->Checked(0);    $$refConfig{'ALBUMS_OPEN_DIR'}        = 0;  } # Default is not checked
  # Dump friends
  if (exists($$refConfig{'REMEMBER_SAVE_FRIENDS'})) { $winFriends->chSaveFriendsDir->Checked($$refConfig{'REMEMBER_SAVE_FRIENDS'});              }
  else                                              { $winFriends->chSaveFriendsDir->Checked(1);  $$refConfig{'REMEMBER_SAVE_FRIENDS'}     = 1;  } # Default is checked
  if (exists($$refConfig{'FRIENDS_INCLUDE_ICONS'})) { $winFriends->chFriendsProfileIcons->Checked($$refConfig{'FRIENDS_INCLUDE_ICONS'});         }
  else                                              { $winFriends->chFriendsProfileIcons->Checked(1); $$refConfig{'FRIENDS_INCLUDE_ICONS'} = 1;  } # Default is checked
  if (exists($$refConfig{'FRIENDS_OPEN_XLSX'}))     { $winFriends->chFriendsOpenXLSX->Checked($$refConfig{'FRIENDS_OPEN_XLSX'});                 }
  else                                              { $winFriends->chFriendsOpenXLSX->Checked(1); $$refConfig{'FRIENDS_OPEN_XLSX'}         = 1;  } # Default is checked
  # Dump Events
  if (exists($$refConfig{'REMEMBER_SAVE_EVENT'}))   { $winEvent->chSaveEventDir->Checked($$refConfig{'REMEMBER_SAVE_EVENT'});                    }
  else                                              { $winEvent->chSaveEventDir->Checked(1);          $$refConfig{'REMEMBER_SAVE_EVENT'}   = 1;  } # Default is checked
  if (exists($$refConfig{'EVENT_PROFILE_ICONS'}))   { $winEvent->chEventProfileIcons->Checked($$refConfig{'EVENT_PROFILE_ICONS'});               }
  else                                              { $winEvent->chEventProfileIcons->Checked(1);     $$refConfig{'EVENT_PROFILE_ICONS'}   = 1;  } # Default is checked
  if (exists($$refConfig{'EVENT_OPEN_XLSX'}))       { $winEvent->chEventOpenXLSX->Checked($$refConfig{'EVENT_OPEN_XLSX'});                       }
  else                                              { $winEvent->chEventOpenXLSX->Checked(1);         $$refConfig{'EVENT_OPEN_XLSX'}       = 1;  } # Default is checked
  # Dump contrib
  if (exists($$refConfig{'REMEMBER_SAVE_CONTRIB'})) { $winContrib->chSaveContribDir->Checked($$refConfig{'REMEMBER_SAVE_CONTRIB'});              }
  else                                              { $winContrib->chSaveContribDir->Checked(1);      $$refConfig{'REMEMBER_SAVE_CONTRIB'} = 1;  } # Default is checked
  if (exists($$refConfig{'CONTRIB_PROFILE_ICONS'})) { $winContrib->chContribProfileIcons->Checked($$refConfig{'CONTRIB_PROFILE_ICONS'});         }
  else                                              { $winContrib->chContribProfileIcons->Checked(1); $$refConfig{'CONTRIB_PROFILE_ICONS'} = 1;  } # Default is checked
  if (exists($$refConfig{'CONTRIB_OPEN_XLSX'}))     { $winContrib->chContribOpenXLSX->Checked($$refConfig{'CONTRIB_OPEN_XLSX'});                 }
  else                                              { $winContrib->chContribOpenXLSX->Checked(1);     $$refConfig{'CONTRIB_OPEN_XLSX'}     = 1;  } # Default is checked
  # Dump chat
  if (exists($$refConfig{'REMEMBER_SAVE_CHAT'}))    { $winChat->chSaveChatDir->Checked($$refConfig{'REMEMBER_SAVE_CHAT'});                    }
  else                                              { $winChat->chSaveChatDir->Checked(1);        $$refConfig{'REMEMBER_SAVE_CHAT'}     = 1;  } # Default is checked
  
  &saveConfig($refConfig);

}  #--- End loadConfig

#--------------------------#
sub scrollPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  # Scrolling down and wait for content to load
  $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
  sleep($time);
  
  # Evaluate end of the page
  my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
  if ($end == 1) {
    sleep($time); # Wait another X seconds and evaluate again
    ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
    if ($end == 1) { return(1); } # End of the page
  }

}  #--- End scrollPage

#--------------------------#
sub scrollLikePage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # Click on "See more" button and wait for content to load
    sleep($time);
    my $seeMore = $$refMech->selector('a.pam.uiBoxLightblue.uiMorePagerPrimary', any => 1);
    if ($seeMore) {
      $seeMore->click();
    } else { last; } # End
  }

}  #--- End scrollLikePage

#--------------------------#
sub scrollVPostsPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # Click on "See more" button and wait for content to load
    sleep($time);
    my $seeMore = $$refMech->selector('a.pam.uiBoxWhite.topborder.uiMorePagerPrimary', any => 1);
    if ($seeMore) {
      $seeMore->click();
    } else { last; } # End
  }

}  #--- End scrollVPostsPage

#--------------------------#
sub scrollAlbumPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # End of the page ?
    sleep($time);
    my @parts = $$refMech->selector('div._30f');
    if (scalar(@parts) > 1) { return(1); } # End of the page
    # Scrolling down and wait for content to load
    else {
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      sleep($time);
    }
  }

}  #--- End scrollAlbumPage

#--------------------------#
sub scrollFriendPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # End of the page ?
    my @parts = $$refMech->selector('div._3dc.lfloat._ohe._5brz');
    if (scalar(@parts) > 1) { return(1); } # End of the page
    # Scrolling down and wait for content to load
    else {
      my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
      if ($end == 1) { # End of the page, done ? Really ? With a bit more
        sleep($time);
        $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
        ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
        if ($end == 1) { return(1); }
      }
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      sleep($time);
    }
  }

}  #--- End scrollFriendPage

#--------------------------#
sub scrollToBottom
#--------------------------#
{
  # Local variables
  my ($refMech, $time, $count) = @_;
  
  my $maxScrollByDate = $winConfig->rbMaxScrollByDate->Checked();
  my $maxDate;
  my $maxScroll;
  if ($maxScrollByDate) {
    my ($d, $m, $y) = $winConfig->dtMaxScrollByDate->GetDate();
    $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
  } else { $maxScroll = $winConfig->tfMaxScroll->Text(); }
  
  while (1) {
    # Scrolling down and wait for content to load
    $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
    $count++;
    sleep($time);
    
    # Scroll again
    if ($maxScrollByDate and $maxDate) { # Stop by date
      my $lastDisplayedDate = ($$refMech->selector('a._5pcq abbr'))[-1];
      if ($lastDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
        my $date = $1;
        if ($date <= $maxDate) { return(1); }
      }
    } elsif ($maxScroll and $count >= $maxScroll) { return(1); } # Stop by page
    
    # Evaluate end of the page
    my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
    if ($end == 1) { # End of the page, done ? Really ? With a bit more
      sleep($time);
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
      if ($end == 1) { return(1); }
    }
  }

}  #--- End scrollToBottom

#--------------------------#
sub selectCatFriendPage
#--------------------------#
{
  # Local variables
  my ($refMech, $cat) = @_;
  
  my @links = $$refMech->selector('div._3dc.lfloat._ohe._5brz a');
  foreach my $link (@links) {
    if ($link->{name} eq $cat) {
      $link->click();
      return(1);
    }
  }

}  #--- End selectCatFriendPage

#--------------------------#
sub expandContent
#--------------------------#
{
  # Local variables
  my ($refMech) = @_;
  
  # Continue Reading
  $$refMech->eval_in_page("var el = document.getElementsByClassName('text_exposed_link'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  
  # See more
  if ($winConfig->chOptSeemore->Checked()) {
    $$refMech->eval_in_page("var el = document.getElementsByClassName('see_more_link'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('_5v47 fss'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIReplySocialSentenceLinkText UFIReplySocialSentenceVerified'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  }
  
  # More post (wait to find the good classname)

  # View \d+ more comments? / View previous comments / Reply / etc
  if ($winConfig->chOptComments->Checked()) {
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIPagerLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFICommentLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIBlingBox uiBlingBox feedbackBling'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  }
  
  # See translation
  if ($winConfig->chOptTranslate->Checked()) {
    # Translate comment
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFITranslateLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    # Translate post
    my @links = $$refMech->selector('div._43f9 a');
    foreach (@links) { $_->click; }
  }
  

}  #--- End expandContent

#--------------------------#
sub cssSpriteBD
#--------------------------#
{
  # Local variables
  my ($sprite) = @_;
  my %bdSprites = (
    '_4_o0' => 'span._4_o0 { background-position:0 0 }', 
    '_4_o1' => 'span._4_o1 { background-position:0 -17px }', 
    '_4_o2' => 'span._4_o2 { background-position:0 -34px }', 
    '_4_o3' => 'span._4_o3 { background-position:0 -51px }', 
    '_4_o4' => 'span._4_o4 { background-position:0 -68px }', 
    '_4_o5' => 'span._4_o5 { background-position:0 -85px }', 
    '_4_o6' => 'span._4_o6 { background-position:0 -102px }', 
    '_4_o7' => 'span._4_o7 { background-position:0 -119px }', 
    '_4_o8' => 'span._4_o8 { background-position:0 -136px }', 
    '_4_o9' => 'span._4_o9 { background-position:0 -153px }', 
    '_4_oa' => 'span._4_oa { background-position:0 -170px }', 
    '_4_ob' => 'span._4_ob { background-position:0 -187px }', 
    '_4_oc' => 'span._4_oc { background-position:0 -204px }', 
    '_4_od' => 'span._4_od { background-position:0 -221px }', 
    '_4_oe' => 'span._4_oe { background-position:0 -238px }', 
    '_4_of' => 'span._4_of { background-position:0 -255px }', 
    '_2b_' => 'span._2b_ { background-position:0 -272px }', 
    '_2c0' => 'span._2c0 { background-position:0 -289px }', 
    '_4_og' => 'span._4_og { background-position:0 -306px }', 
    '_4_oh' => 'span._4_oh { background-position:0 -323px }', 
    '_4_oi' => 'span._4_oi { background-position:0 -340px }', 
    '_4_oj' => 'span._4_oj { background-position:0 -357px }', 
    '_4_ok' => 'span._4_ok { background-position:0 -374px }', 
    '_4_ol' => 'span._4_ol { background-position:0 -391px }', 
    '_2c1' => 'span._2c1 { background-position:0 -408px }', 
    '_2c2' => 'span._2c2 { background-position:0 -425px }', 
    '_2c3' => 'span._2c3 { background-position:0 -442px }', 
    '_2c4' => 'span._2c4 { background-position:0 -459px }', 
    '_2c5' => 'span._2c5 { background-position:0 -476px }', 
    '_2c6' => 'span._2c6 { background-position:0 -493px }', 
    '_2c7' => 'span._2c7 { background-position:0 -510px }', 
    '_2c8' => 'span._2c8 { background-position:0 -527px }', 
    '_2c9' => 'span._2c9 { background-position:0 -544px }', 
    '_2ca' => 'span._2ca { background-position:0 -561px }', 
    '_2cb' => 'span._2cb { background-position:0 -578px }', 
    '_2cc' => 'span._2cc { background-position:0 -595px }', 
    '_2cd' => 'span._2cd { background-position:0 -612px }', 
    '_2ce' => 'span._2ce { background-position:0 -629px }', 
    '_2cf' => 'span._2cf { background-position:0 -646px }', 
    '_2cg' => 'span._2cg { background-position:0 -663px }', 
    '_4_om' => 'span._4_om { background-position:0 -680px }', 
    '_4_on' => 'span._4_on { background-position:0 -697px }', 
    '_4_oo' => 'span._4_oo { background-position:0 -714px }', 
    '_2ch' => 'span._2ch { background-position:0 -731px }', 
    '_2ci' => 'span._2ci { background-position:0 -748px }', 
    '_2cj' => 'span._2cj { background-position:0 -765px }', 
    '_2ck' => 'span._2ck { background-position:0 -782px }', 
    '_4_op' => 'span._4_op { background-position:0 -799px }', 
    '_4_oq' => 'span._4_oq { background-position:0 -816px }', 
    '_4_or' => 'span._4_or { background-position:0 -833px }', 
    '_4_os' => 'span._4_os { background-position:0 -850px }', 
    '_4_ot' => 'span._4_ot { background-position:0 -867px }', 
    '_4_ou' => 'span._4_ou { background-position:0 -884px }', 
    '_4_ov' => 'span._4_ov { background-position:0 -901px }', 
    '_4_ow' => 'span._4_ow { background-position:0 -918px }', 
    '_4_ox' => 'span._4_ox { background-position:0 -935px }', 
    '_4_oy' => 'span._4_oy { background-position:0 -952px }', 
    '_4_oz' => 'span._4_oz { background-position:0 -969px }', 
    '_4_o-' => 'span._4_o- { background-position:0 -986px }', 
    '_4_o_' => 'span._4_o_ { background-position:0 -1003px }', 
    '_4_p0' => 'span._4_p0 { background-position:0 -1020px }', 
    '_4_p1' => 'span._4_p1 { background-position:0 -1037px }', 
    '_4_p2' => 'span._4_p2 { background-position:0 -1054px }', 
    '_4_p3' => 'span._4_p3 { background-position:0 -1071px }', 
    '_4_p4' => 'span._4_p4 { background-position:0 -1088px }', 
    '_4_p5' => 'span._4_p5 { background-position:0 -1105px }', 
    '_4_p6' => 'span._4_p6 { background-position:0 -1122px }', 
    '_2cl' => 'span._2cl { background-position:0 -1139px }', 
    '_2cm' => 'span._2cm { background-position:0 -1156px }', 
    '_4_p7' => 'span._4_p7 { background-position:0 -1173px }', 
    '_4_p8' => 'span._4_p8 { background-position:0 -1190px }', 
    '_2cn' => 'span._2cn { background-position:0 -1207px }', 
    '_2co' => 'span._2co { background-position:0 -1224px }', 
    '_2cp' => 'span._2cp { background-position:0 -1241px }', 
    '_2cq' => 'span._2cq { background-position:0 -1258px }', 
    '_2cr' => 'span._2cr { background-position:0 -1275px }', 
    '_2cs' => 'span._2cs { background-position:0 -1292px }', 
    '_4_p9' => 'span._4_p9 { background-position:0 -1309px }', 
    '_2ct' => 'span._2ct { background-position:0 -1326px }', 
    '_2cu' => 'span._2cu { background-position:0 -1343px }', 
    '_2cv' => 'span._2cv { background-position:0 -1360px }', 
    '_2cw' => 'span._2cw { background-position:0 -1377px }', 
    '_4_pa' => 'span._4_pa { background-position:0 -1394px }', 
    '_2cx' => 'span._2cx { background-position:0 -1411px }', 
    '_4_pb' => 'span._4_pb { background-position:0 -1428px }', 
    '_4_pc' => 'span._4_pc { background-position:0 -1445px }', 
    '_4_pd' => 'span._4_pd { background-position:0 -1462px }', 
    '_4_pe' => 'span._4_pe { background-position:0 -1479px }', 
    '_4_pf' => 'span._4_pf { background-position:0 -1496px }', 
    '_4_pg' => 'span._4_pg { background-position:0 -1513px }', 
    '_4_ph' => 'span._4_ph { background-position:0 -1530px }', 
    '_4_pi' => 'span._4_pi { background-position:0 -1547px }', 
    '_4_pj' => 'span._4_pj { background-position:0 -1564px }', 
    '_4_pk' => 'span._4_pk { background-position:0 -1581px }', 
    '_4_pl' => 'span._4_pl { background-position:0 -1598px }', 
    '_4_pm' => 'span._4_pm { background-position:0 -1615px }', 
    '_4_pn' => 'span._4_pn { background-position:0 -1632px }', 
    '_2cy' => 'span._2cy { background-position:0 -1649px }', 
    '_2cz' => 'span._2cz { background-position:0 -1666px }', 
    '_4_po' => 'span._4_po { background-position:0 -1683px }', 
    '_4_pp' => 'span._4_pp { background-position:0 -1700px }', 
    '_4_pq' => 'span._4_pq { background-position:0 -1717px }', 
    '_2c-' => 'span._2c- { background-position:0 -1734px }', 
    '_4_pr' => 'span._4_pr { background-position:0 -1751px }', 
    '_4_ps' => 'span._4_ps { background-position:0 -1768px }', 
    '_4_pt' => 'span._4_pt { background-position:0 -1785px }', 
    '_4_pu' => 'span._4_pu { background-position:0 -1802px }', 
    '_4_pv' => 'span._4_pv { background-position:0 -1819px }', 
    '_4_pw' => 'span._4_pw { background-position:0 -1836px }', 
    '_4_px' => 'span._4_px { background-position:0 -1853px }', 
    '_4_py' => 'span._4_py { background-position:0 -1870px }', 
    '_4_pz' => 'span._4_pz { background-position:0 -1887px }', 
    '_4_p-' => 'span._4_p- { background-position:0 -1904px }', 
    '_4_p_' => 'span._4_p_ { background-position:0 -1921px }', 
    '_4_q0' => 'span._4_q0 { background-position:0 -1938px }', 
    '_4_q1' => 'span._4_q1 { background-position:0 -1955px }', 
    '_4_q2' => 'span._4_q2 { background-position:0 -1972px }', 
    '_4_q3' => 'span._4_q3 { background-position:0 -1989px }', 
    '_4_q4' => 'span._4_q4 { background-position:0 -2006px }', 
    '_4_q5' => 'span._4_q5 { background-position:0 -2023px }', 
    '_4_q6' => 'span._4_q6 { background-position:0 -2040px }', 
    '_4_q7' => 'span._4_q7 { background-position:0 -2057px }', 
    '_4_q8' => 'span._4_q8 { background-position:0 -2074px }', 
    '_4_q9' => 'span._4_q9 { background-position:0 -2091px }', 
    '_2c_' => 'span._2c_ { background-position:0 -2108px }', 
    '_2d0' => 'span._2d0 { background-position:0 -2125px }', 
    '_2d1' => 'span._2d1 { background-position:0 -2142px }', 
    '_2d2' => 'span._2d2 { background-position:0 -2159px }', 
    '_2d3' => 'span._2d3 { background-position:0 -2176px }', 
    '_2d4' => 'span._2d4 { background-position:0 -2193px }', 
    '_2d5' => 'span._2d5 { background-position:0 -2210px }', 
    '_2d6' => 'span._2d6 { background-position:0 -2227px }', 
    '_2d7' => 'span._2d7 { background-position:0 -2244px }', 
    '_2d8' => 'span._2d8 { background-position:0 -2261px }', 
    '_2d9' => 'span._2d9 { background-position:0 -2278px }', 
    '_2da' => 'span._2da { background-position:0 -2295px }', 
    '_2db' => 'span._2db { background-position:0 -2312px }', 
    '_2dc' => 'span._2dc { background-position:0 -2329px }', 
    '_2dd' => 'span._2dd { background-position:0 -2346px }', 
    '_2de' => 'span._2de { background-position:0 -2363px }', 
    '_2df' => 'span._2df { background-position:0 -2380px }', 
    '_2dg' => 'span._2dg { background-position:0 -2397px }', 
    '_2dh' => 'span._2dh { background-position:0 -2414px }', 
    '_2di' => 'span._2di { background-position:0 -2431px }', 
    '_2dj' => 'span._2dj { background-position:0 -2448px }', 
    '_2dk' => 'span._2dk { background-position:0 -2465px }', 
    '_2dl' => 'span._2dl { background-position:0 -2482px }', 
    '_2dm' => 'span._2dm { background-position:0 -2499px }', 
    '_2dn' => 'span._2dn { background-position:0 -2516px }', 
    '_2do' => 'span._2do { background-position:0 -2533px }', 
    '_2dp' => 'span._2dp { background-position:0 -2550px }', 
    '_2dq' => 'span._2dq { background-position:0 -2567px }', 
    '_491' => 'span._491 { background-position:0 -2584px }', 
    '_2dr' => 'span._2dr { background-position:0 -2601px }', 
    '_2ds' => 'span._2ds { background-position:0 -2618px }', 
    '_2dt' => 'span._2dt { background-position:0 -2635px }', 
    '_2du' => 'span._2du { background-position:0 -2652px }', 
    '_2dv' => 'span._2dv { background-position:0 -2669px }', 
    '_2dw' => 'span._2dw { background-position:0 -2686px }', 
    '_2dx' => 'span._2dx { background-position:0 -2703px }', 
    '_2dy' => 'span._2dy { background-position:0 -2720px }', 
    '_2dz' => 'span._2dz { background-position:0 -2737px }', 
    '_2d-' => 'span._2d- { background-position:0 -2754px }', 
    '_2d_' => 'span._2d_ { background-position:0 -2771px }', 
    '_2e0' => 'span._2e0 { background-position:0 -2788px }', 
    '_2e1' => 'span._2e1 { background-position:0 -2805px }', 
    '_2e2' => 'span._2e2 { background-position:0 -2822px }', 
    '_2e3' => 'span._2e3 { background-position:0 -2839px }', 
    '_2e4' => 'span._2e4 { background-position:0 -2856px }', 
    '_2e5' => 'span._2e5 { background-position:0 -2873px }', 
    '_2e6' => 'span._2e6 { background-position:0 -2890px }', 
    '_2e7' => 'span._2e7 { background-position:0 -2907px }', 
    '_2e8' => 'span._2e8 { background-position:0 -2924px }', 
    '_2e9' => 'span._2e9 { background-position:0 -2941px }', 
    '_2ea' => 'span._2ea { background-position:0 -2958px }', 
    '_4_qa' => 'span._4_qa { background-position:0 -2975px }', 
    '_4_qb' => 'span._4_qb { background-position:0 -2992px }', 
    '_4_qc' => 'span._4_qc { background-position:0 -3009px }', 
    '_4_qd' => 'span._4_qd { background-position:0 -3026px }', 
    '_4_qe' => 'span._4_qe { background-position:0 -3043px }', 
    '_4_qf' => 'span._4_qf { background-position:0 -3060px }', 
    '_4_qg' => 'span._4_qg { background-position:0 -3077px }', 
    '_4_qh' => 'span._4_qh { background-position:0 -3094px }', 
    '_4_qi' => 'span._4_qi { background-position:0 -3111px }', 
    '_4_qj' => 'span._4_qj { background-position:0 -3128px }', 
    '_4_qk' => 'span._4_qk { background-position:0 -3145px }', 
    '_4_ql' => 'span._4_ql { background-position:0 -3162px }', 
    '_2eb' => 'span._2eb { background-position:0 -3179px }', 
    '_2ec' => 'span._2ec { background-position:0 -3196px }', 
    '_2ed' => 'span._2ed { background-position:0 -3213px }', 
    '_2ee' => 'span._2ee { background-position:0 -3230px }', 
    '_2ef' => 'span._2ef { background-position:0 -3247px }', 
    '_2eg' => 'span._2eg { background-position:0 -3264px }', 
    '_2eh' => 'span._2eh { background-position:0 -3281px }', 
    '_2ei' => 'span._2ei { background-position:0 -3298px }', 
    '_2ej' => 'span._2ej { background-position:0 -3315px }', 
    '_2ek' => 'span._2ek { background-position:0 -3332px }', 
    '_2el' => 'span._2el { background-position:0 -3349px }', 
    '_2em' => 'span._2em { background-position:0 -3366px }', 
    '_2en' => 'span._2en { background-position:0 -3383px }', 
    '_2eo' => 'span._2eo { background-position:0 -3400px }', 
    '_2ep' => 'span._2ep { background-position:0 -3417px }', 
    '_2eq' => 'span._2eq { background-position:0 -3434px }', 
    '_2er' => 'span._2er { background-position:0 -3451px }', 
    '_2es' => 'span._2es { background-position:0 -3468px }', 
    '_2et' => 'span._2et { background-position:0 -3485px }', 
    '_2eu' => 'span._2eu { background-position:0 -3502px }', 
    '_2ev' => 'span._2ev { background-position:0 -3519px }', 
    '_2ew' => 'span._2ew { background-position:0 -3536px }', 
    '_2ex' => 'span._2ex { background-position:0 -3553px }', 
    '_4_qm' => 'span._4_qm { background-position:0 -3570px }', 
    '_2ey' => 'span._2ey { background-position:0 -3587px }', 
    '_4_qn' => 'span._4_qn { background-position:0 -3604px }', 
    '_4_qo' => 'span._4_qo { background-position:0 -3621px }', 
    '_4_qp' => 'span._4_qp { background-position:0 -3638px }', 
    '_2ez' => 'span._2ez { background-position:0 -3655px }', 
    '_4_qq' => 'span._4_qq { background-position:0 -3672px }', 
    '_4_qr' => 'span._4_qr { background-position:0 -3689px }', 
    '_4_qs' => 'span._4_qs { background-position:0 -3706px }', 
    '_2e-' => 'span._2e- { background-position:0 -3723px }', 
    '_2e_' => 'span._2e_ { background-position:0 -3740px }', 
    '_2f0' => 'span._2f0 { background-position:0 -3757px }', 
    '_4_qt' => 'span._4_qt { background-position:0 -3774px }', 
    '_2f1' => 'span._2f1 { background-position:0 -3791px }', 
    '_2f2' => 'span._2f2 { background-position:0 -3808px }', 
    '_2f3' => 'span._2f3 { background-position:0 -3825px }', 
    '_2f4' => 'span._2f4 { background-position:0 -3842px }', 
    '_2f5' => 'span._2f5 { background-position:0 -3859px }', 
    '_2f6' => 'span._2f6 { background-position:0 -3876px }', 
    '_2f7' => 'span._2f7 { background-position:0 -3893px }', 
    '_2f8' => 'span._2f8 { background-position:0 -3910px }', 
    '_2f9' => 'span._2f9 { background-position:0 -3927px }', 
    '_2fa' => 'span._2fa { background-position:0 -3944px }', 
    '_4_qu' => 'span._4_qu { background-position:0 -3961px }', 
    '_4_qv' => 'span._4_qv { background-position:0 -3978px }', 
    '_4_qw' => 'span._4_qw { background-position:0 -3995px }', 
    '_4_qx' => 'span._4_qx { background-position:0 -4012px }', 
    '_2fb' => 'span._2fb { background-position:0 -4029px }', 
    '_4_qy' => 'span._4_qy { background-position:0 -4046px }', 
    '_2fc' => 'span._2fc { background-position:0 -4063px }', 
    '_2fd' => 'span._2fd { background-position:0 -4080px }', 
    '_4_qz' => 'span._4_qz { background-position:0 -4097px }', 
    '_2fe' => 'span._2fe { background-position:0 -4114px }', 
    '_2ff' => 'span._2ff { background-position:0 -4131px }', 
    '_2fg' => 'span._2fg { background-position:0 -4148px }', 
    '_4_q-' => 'span._4_q- { background-position:0 -4165px }', 
    '_4_q_' => 'span._4_q_ { background-position:0 -4182px }', 
    '_4_r0' => 'span._4_r0 { background-position:0 -4199px }', 
    '_4_r1' => 'span._4_r1 { background-position:0 -4216px }', 
    '_4_r2' => 'span._4_r2 { background-position:0 -4233px }', 
    '_2fh' => 'span._2fh { background-position:0 -4250px }', 
    '_4_r3' => 'span._4_r3 { background-position:0 -4267px }', 
    '_2fi' => 'span._2fi { background-position:0 -4284px }', 
    '_2fj' => 'span._2fj { background-position:0 -4301px }', 
    '_2fk' => 'span._2fk { background-position:0 -4318px }', 
    '_2fl' => 'span._2fl { background-position:0 -4335px }', 
    '_4_r4' => 'span._4_r4 { background-position:0 -4352px }', 
    '_4_r5' => 'span._4_r5 { background-position:0 -4369px }', 
    '_2fm' => 'span._2fm { background-position:0 -4386px }', 
    '_2fn' => 'span._2fn { background-position:0 -4403px }', 
    '_4_r6' => 'span._4_r6 { background-position:0 -4420px }', 
    '_4_r7' => 'span._4_r7 { background-position:0 -4437px }', 
    '_4_r8' => 'span._4_r8 { background-position:0 -4454px }', 
    '_4_r9' => 'span._4_r9 { background-position:0 -4471px }', 
    '_4_ra' => 'span._4_ra { background-position:0 -4488px }', 
    '_4_rb' => 'span._4_rb { background-position:0 -4505px }', 
    '_4_rc' => 'span._4_rc { background-position:0 -4522px }', 
    '_4_rd' => 'span._4_rd { background-position:0 -4539px }', 
    '_4_re' => 'span._4_re { background-position:0 -4556px }', 
    '_4_rf' => 'span._4_rf { background-position:0 -4573px }', 
    '_2fo' => 'span._2fo { background-position:0 -4590px }', 
    '_2fp' => 'span._2fp { background-position:0 -4607px }', 
    '_4_rg' => 'span._4_rg { background-position:0 -4624px }', 
    '_4_rh' => 'span._4_rh { background-position:0 -4641px }', 
    '_4_ri' => 'span._4_ri { background-position:0 -4658px }', 
    '_4_rj' => 'span._4_rj { background-position:0 -4675px }', 
    '_2fq' => 'span._2fq { background-position:0 -4692px }', 
    '_4_rk' => 'span._4_rk { background-position:0 -4709px }', 
    '_4_rl' => 'span._4_rl { background-position:0 -4726px }', 
    '_4_rm' => 'span._4_rm { background-position:0 -4743px }', 
    '_4_rn' => 'span._4_rn { background-position:0 -4760px }', 
    '_4_ro' => 'span._4_ro { background-position:0 -4777px }', 
    '_4_rp' => 'span._4_rp { background-position:0 -4794px }', 
    '_4_rq' => 'span._4_rq { background-position:0 -4811px }', 
    '_4_rr' => 'span._4_rr { background-position:0 -4828px }', 
    '_4_rs' => 'span._4_rs { background-position:0 -4845px }', 
    '_4_rt' => 'span._4_rt { background-position:0 -4862px }', 
    '_2fr' => 'span._2fr { background-position:0 -4879px }', 
    '_4_ru' => 'span._4_ru { background-position:0 -4896px }', 
    '_492' => 'span._492 { background-position:0 -4913px }', 
    '_4_rv' => 'span._4_rv { background-position:0 -4930px }', 
    '_4_rw' => 'span._4_rw { background-position:0 -4947px }', 
    '_4_rx' => 'span._4_rx { background-position:0 -4964px }', 
    '_4_ry' => 'span._4_ry { background-position:0 -4981px }', 
    '_4_rz' => 'span._4_rz { background-position:0 -4998px }', 
    '_4_r-' => 'span._4_r- { background-position:0 -5015px }', 
    '_4_r_' => 'span._4_r_ { background-position:0 -5032px }', 
    '_4_s0' => 'span._4_s0 { background-position:0 -5049px }', 
    '_4_s1' => 'span._4_s1 { background-position:0 -5066px }', 
    '_4_s2' => 'span._4_s2 { background-position:0 -5083px }', 
    '_4_s3' => 'span._4_s3 { background-position:0 -5100px }', 
    '_4_s4' => 'span._4_s4 { background-position:0 -5117px }', 
    '_4_s5' => 'span._4_s5 { background-position:0 -5134px }', 
    '_4_s6' => 'span._4_s6 { background-position:0 -5151px }', 
    '_4_s7' => 'span._4_s7 { background-position:0 -5168px }', 
    '_2fs' => 'span._2fs { background-position:0 -5185px }', 
    '_2ft' => 'span._2ft { background-position:0 -5202px }', 
    '_2fu' => 'span._2fu { background-position:0 -5219px }', 
    '_2fv' => 'span._2fv { background-position:0 -5236px }', 
    '_2fw' => 'span._2fw { background-position:0 -5253px }', 
    '_2fx' => 'span._2fx { background-position:0 -5270px }', 
    '_1q3y' => 'span._1q3y { background-position:0 -5287px }', 
    '_2fz' => 'span._2fz { background-position:0 -5304px }', 
    '_2f-' => 'span._2f- { background-position:0 -5321px }', 
    '_2f_' => 'span._2f_ { background-position:0 -5338px }', 
    '_2g0' => 'span._2g0 { background-position:0 -5355px }', 
    '_2g1' => 'span._2g1 { background-position:0 -5372px }', 
    '_2g2' => 'span._2g2 { background-position:0 -5389px }', 
    '_2g3' => 'span._2g3 { background-position:0 -5406px }', 
    '_2g4' => 'span._2g4 { background-position:0 -5423px }', 
    '_2g5' => 'span._2g5 { background-position:0 -5440px }', 
    '_2g6' => 'span._2g6 { background-position:0 -5457px }', 
    '_2g7' => 'span._2g7 { background-position:0 -5474px }', 
    '_2g8' => 'span._2g8 { background-position:0 -5491px }', 
    '_2g9' => 'span._2g9 { background-position:0 -5508px }', 
    '_2ga' => 'span._2ga { background-position:0 -5525px }', 
    '_2gb' => 'span._2gb { background-position:0 -5542px }', 
    '_2gc' => 'span._2gc { background-position:0 -5559px }', 
    '_2gd' => 'span._2gd { background-position:0 -5576px }', 
    '_2ge' => 'span._2ge { background-position:0 -5593px }', 
    '_2gf' => 'span._2gf { background-position:0 -5610px }', 
    '_2gg' => 'span._2gg { background-position:0 -5627px }', 
    '_2gh' => 'span._2gh { background-position:0 -5644px }', 
    '_2gi' => 'span._2gi { background-position:0 -5661px }', 
    '_2gj' => 'span._2gj { background-position:0 -5678px }', 
    '_2gk' => 'span._2gk { background-position:0 -5695px }', 
    '_2gl' => 'span._2gl { background-position:0 -5712px }', 
    '_2gm' => 'span._2gm { background-position:0 -5729px }', 
    '_2gn' => 'span._2gn { background-position:0 -5746px }', 
    '_2go' => 'span._2go { background-position:0 -5763px }', 
    '_2gp' => 'span._2gp { background-position:0 -5780px }', 
    '_2gq' => 'span._2gq { background-position:0 -5797px }', 
    '_2gr' => 'span._2gr { background-position:0 -5814px }', 
    '_2gs' => 'span._2gs { background-position:0 -5831px }', 
    '_2gt' => 'span._2gt { background-position:0 -5848px }', 
    '_2gu' => 'span._2gu { background-position:0 -5865px }', 
    '_2gv' => 'span._2gv { background-position:0 -5882px }', 
    '_2gw' => 'span._2gw { background-position:0 -5899px }', 
    '_2gx' => 'span._2gx { background-position:0 -5916px }', 
    '_2gy' => 'span._2gy { background-position:0 -5933px }', 
    '_2gz' => 'span._2gz { background-position:0 -5950px }', 
    '_2g-' => 'span._2g- { background-position:0 -5967px }', 
    '_2g_' => 'span._2g_ { background-position:0 -5984px }', 
    '_4_s8' => 'span._4_s8 { background-position:0 -6001px }', 
    '_4_s9' => 'span._4_s9 { background-position:0 -6018px }', 
    '_4_sa' => 'span._4_sa { background-position:0 -6035px }', 
    '_4_sb' => 'span._4_sb { background-position:0 -6052px }', 
    '_4_sc' => 'span._4_sc { background-position:0 -6069px }', 
    '_4_sd' => 'span._4_sd { background-position:0 -6086px }', 
    '_4_se' => 'span._4_se { background-position:0 -6103px }', 
    '_4_sf' => 'span._4_sf { background-position:0 -6120px }', 
    '_4_sg' => 'span._4_sg { background-position:0 -6137px }', 
    '_4_sh' => 'span._4_sh { background-position:0 -6154px }', 
    '_4_si' => 'span._4_si { background-position:0 -6171px }', 
    '_4_sj' => 'span._4_sj { background-position:0 -6188px }', 
    '_4_sk' => 'span._4_sk { background-position:0 -6205px }', 
    '_4_sl' => 'span._4_sl { background-position:0 -6222px }', 
    '_4_sm' => 'span._4_sm { background-position:0 -6239px }', 
    '_4_sn' => 'span._4_sn { background-position:0 -6256px }', 
    '_4_so' => 'span._4_so { background-position:0 -6273px }', 
    '_4_sp' => 'span._4_sp { background-position:0 -6290px }', 
    '_4_sq' => 'span._4_sq { background-position:0 -6307px }', 
    '_4_sr' => 'span._4_sr { background-position:0 -6324px }', 
    '_4_ss' => 'span._4_ss { background-position:0 -6341px }', 
    '_4_st' => 'span._4_st { background-position:0 -6358px }', 
    '_4_su' => 'span._4_su { background-position:0 -6375px }', 
    '_4_sv' => 'span._4_sv { background-position:0 -6392px }', 
    '_4_sw' => 'span._4_sw { background-position:0 -6409px }', 
    '_4_sx' => 'span._4_sx { background-position:0 -6426px }', 
    '_4_sy' => 'span._4_sy { background-position:0 -6443px }', 
    '_4_sz' => 'span._4_sz { background-position:0 -6460px }', 
    '_4_s-' => 'span._4_s- { background-position:0 -6545px }', 
    '_4_s_' => 'span._4_s_ { background-position:0 -6562px }', 
    '_4_t0' => 'span._4_t0 { background-position:0 -6579px }', 
    '_4_t1' => 'span._4_t1 { background-position:0 -6596px }', 
    '_4_t2' => 'span._4_t2 { background-position:0 -6613px }', 
    '_4_t3' => 'span._4_t3 { background-position:0 -6630px }', 
    '_4_t4' => 'span._4_t4 { background-position:0 -6681px }', 
    '_2h0' => 'span._2h0 { background-position:0 -6732px }', 
    '_2h1' => 'span._2h1 { background-position:0 -6749px }', 
    '_4_t5' => 'span._4_t5 { background-position:0 -6851px }', 
    '_4_t6' => 'span._4_t6 { background-position:0 -6868px }', 
    '_2h2' => 'span._2h2 { background-position:0 -6885px }', 
    '_4_t7' => 'span._4_t7 { background-position:0 -6902px }', 
    '_4_t8' => 'span._4_t8 { background-position:0 -6919px }', 
    '_4_t9' => 'span._4_t9 { background-position:0 -6936px }', 
    '_4_ta' => 'span._4_ta { background-position:0 -6953px }', 
    '_2h3' => 'span._2h3 { background-position:0 -6970px }', 
    '_4_tb' => 'span._4_tb { background-position:0 -6987px }', 
    '_4_tc' => 'span._4_tc { background-position:0 -7004px }', 
    '_4_td' => 'span._4_td { background-position:0 -7021px }', 
    '_4_te' => 'span._4_te { background-position:0 -7038px }', 
    '_4_tf' => 'span._4_tf { background-position:0 -7055px }', 
    '_4_tg' => 'span._4_tg { background-position:0 -7072px }', 
    '_4_th' => 'span._4_th { background-position:0 -7089px }', 
    '_2h4' => 'span._2h4 { background-position:0 -7157px }', 
    '_2h5' => 'span._2h5 { background-position:0 -7174px }', 
    '_2h6' => 'span._2h6 { background-position:0 -7191px }', 
    '_4_ti' => 'span._4_ti { background-position:0 -7276px }', 
    '_4_tj' => 'span._4_tj { background-position:0 -7293px }', 
    '_4_tk' => 'span._4_tk { background-position:0 -7395px }', 
    '_4_tl' => 'span._4_tl { background-position:0 -7412px }', 
    '_4_tm' => 'span._4_tm { background-position:0 -7463px }', 
    '_4_tn' => 'span._4_tn { background-position:0 -7480px }', 
    '_4_to' => 'span._4_to { background-position:0 -7497px }', 
    '_4_tp' => 'span._4_tp { background-position:0 -7514px }', 
    '_4_tq' => 'span._4_tq { background-position:0 -7531px }', 
    '_4_tr' => 'span._4_tr { background-position:0 -7548px }', 
    '_4_ts' => 'span._4_ts { background-position:0 -7565px }', 
    '_4_tt' => 'span._4_tt { background-position:0 -7582px }', 
    '_4_tu' => 'span._4_tu { background-position:0 -6477px }', 
    '_4_tv' => 'span._4_tv { background-position:0 -6494px }', 
    '_4_tw' => 'span._4_tw { background-position:0 -6511px }', 
    '_4_tx' => 'span._4_tx { background-position:0 -6528px }', 
    '_2h7' => 'span._2h7 { background-position:0 -6647px }', 
    '_2h8' => 'span._2h8 { background-position:0 -6664px }', 
    '_2h9' => 'span._2h9 { background-position:0 -6698px }', 
    '_2ha' => 'span._2ha { background-position:0 -6715px }', 
    '_4_ty' => 'span._4_ty { background-position:0 -6766px }', 
    '_4_tz' => 'span._4_tz { background-position:0 -6783px }', 
    '_4_t-' => 'span._4_t- { background-position:0 -6800px }', 
    '_4_t_' => 'span._4_t_ { background-position:0 -6817px }', 
    '_4_u0' => 'span._4_u0 { background-position:0 -6834px }', 
    '_4_u1' => 'span._4_u1 { background-position:0 -7106px }', 
    '_4_u2' => 'span._4_u2 { background-position:0 -7123px }', 
    '_4_u3' => 'span._4_u3 { background-position:0 -7140px }', 
    '_4_u4' => 'span._4_u4 { background-position:0 -7208px }', 
    '_2hb' => 'span._2hb { background-position:0 -7225px }', 
    '_4_u5' => 'span._4_u5 { background-position:0 -7242px }', 
    '_4_u6' => 'span._4_u6 { background-position:0 -7259px }', 
    '_4_u7' => 'span._4_u7 { background-position:0 -7310px }', 
    '_4_u8' => 'span._4_u8 { background-position:0 -7327px }', 
    '_4_u9' => 'span._4_u9 { background-position:0 -7344px }', 
    '_4_ua' => 'span._4_ua { background-position:0 -7361px }', 
    '_2hc' => 'span._2hc { background-position:0 -7378px }', 
    '_4_ub' => 'span._4_ub { background-position:0 -7429px }', 
    '_4_uc' => 'span._4_uc { background-position:0 -7446px }', 
    '_4_ud' => 'span._4_ud { background-position:0 -7599px }', 
    '_4_ue' => 'span._4_ue { background-position:0 -7616px }',
  );

  
  # Return the code if exist
  if (exists($bdSprites{$sprite})) { return($bdSprites{$sprite}); }

}  #--- End cssSpriteBD

#--------------------------#
sub emoticon
#--------------------------#
{
  # Local variables
  my ($emoticonTag) = @_;
  my %bdImoticon = (
    'emoticon_smile' => 'span.emoticon_smile { background-position:0 -340px }', 
    'emoticon_frown' => 'span.emoticon_frown { background-position:0 -119px }', 
    'emoticon_poop' => 'span.emoticon_poop { background-position:0 -289px }', 
    'emoticon_putnam' => 'span.emoticon_putnam { background-position:0 -306px }', 
    'emoticon_tongue' => 'span.emoticon_tongue { background-position:0 -391px }', 
    'emoticon_grin' => 'span.emoticon_grin { background-position:0 -170px }', 
    'emoticon_gasp' => 'span.emoticon_gasp { background-position:0 -136px }', 
    'emoticon_wink' => 'span.emoticon_wink { background-position:0 -442px }', 
    'emoticon_glasses' => 'span.emoticon_glasses { background-position:0 -153px }', 
    'emoticon_sunglasses' => 'span.emoticon_sunglasses { background-position:0 -374px }', 
    'emoticon_grumpy' => 'span.emoticon_grumpy { background-position:0 -187px }', 
    'emoticon_unsure' => 'span.emoticon_unsure { background-position:0 -408px }', 
    'emoticon_cry' => 'span.emoticon_cry { background-position:0 -85px }', 
    'emoticon_devil' => 'span.emoticon_devil { background-position:0 -102px }', 
    'emoticon_angel' => 'span.emoticon_angel { background-position:0 -17px }', 
    'emoticon_kiss' => 'span.emoticon_kiss { background-position:0 -238px }', 
    'emoticon_heart' => 'span.emoticon_heart { background-position:0 -204px }', 
    'emoticon_kiki' => 'span.emoticon_kiki { background-position:0 -221px }', 
    'emoticon_squint' => 'span.emoticon_squint { background-position:0 -357px }', 
    'emoticon_confused' => 'span.emoticon_confused { background-position:0 -51px }', 
    'emoticon_confused_rev' => 'span.emoticon_confused_rev { background-position:0 -68px }', 
    'emoticon_upset' => 'span.emoticon_upset { background-position:0 -425px }', 
    'emoticon_pacman' => 'span.emoticon_pacman { background-position:0 -255px }', 
    'emoticon_robot' => 'span.emoticon_robot { background-position:0 -459px }', 
    'emoticon_colonthree' => 'span.emoticon_colonthree { background-position:0 -34px }', 
    'emoticon_penguin' => 'span.emoticon_penguin { background-position:0 -272px }', 
    'emoticon_shark' => 'span.emoticon_shark { background-position:0 -323px }', 
    'emoticon_like' => 'span.emoticon_like { background-position:0 0 }', 
  );

  
  # Return the code if exist
  if (exists($bdImoticon{$emoticonTag})) { return($bdImoticon{$emoticonTag}); }

}  #--- End emoticon